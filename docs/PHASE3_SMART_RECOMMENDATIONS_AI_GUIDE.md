# Phase 3: Smart Recommendations & AI - Complete Implementation Guide

**GACP Platform - Botanical Audit Framework**
**Phase**: 3 - Smart Recommendations & AI
**Status**: Implementation Guide
**Timeline**: 3 months (12 weeks)
**Budget**: 2,000,000 - 3,000,000 THB
**Team**: 5-6 people (2 Backend + 1 AI/ML + 1 Data Scientist + 1 Agricultural Expert + 1 QA)

**Prerequisites**: Phase 1 & Phase 2 must be 100% complete ‚úÖ

---

## Table of Contents

1. [Overview](#overview)
   - Platform Mission & Primary Focus
   - Cannabis as Default Crop
   - Secondary Economic Crops
2. [GACP Compliance & Legal Framework](#gacp-compliance--legal-framework)
   - Thai Cannabis Regulations
   - Standard Operating Procedures (SOP)
   - Automated Compliance Support
3. [Fertilizer Recommendation Engine](#fertilizer-recommendation-engine)
4. [Water Management & Irrigation AI](#water-management--irrigation-ai)
5. [AI Assistant Enhancement](#ai-assistant-enhancement)
6. [Machine Learning Models](#machine-learning-models)
7. [Predictive Analytics](#predictive-analytics)
8. [Testing Strategy](#testing-strategy)
9. [Deployment Guide](#deployment-guide)

---

## Overview

### Platform Mission & Primary Focus

üåø **Primary Mission**: The GACP Platform is designed to bring **cannabis producers into the legal, regulated system** under Thailand's medicinal cannabis framework. Our platform ensures that cannabis cultivation meets the strict standards set by the **Department of Thai Traditional and Alternative Medicine (‡∏Å‡∏£‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)**.

#### Primary Crop: Cannabis (‡∏Å‡∏±‡∏ç‡∏ä‡∏≤) üéØ

**Cannabis is the DEFAULT and PRIMARY focus** of this platform:

- **Legal Compliance**: Full GACP (Good Agricultural and Collection Practices) compliance
- **Standard Operating Procedures**: Following official SOP from Thai government
- **Quality Assurance**: Meeting pharmaceutical-grade requirements
- **Traceability**: Complete audit trail from seed to harvest
- **Documentation**: Comprehensive record-keeping for legal submissions

#### Secondary Economic Crops (Optional) üí∞

The platform also supports **5 additional Thai medicinal plants** as economic alternatives for farmers to diversify income:

1. **‡∏Ç‡∏°‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏ô (Turmeric)** - Export-quality rhizome crop
2. **‡∏Ç‡∏¥‡∏á (Ginger)** - High-value medicinal rhizome
3. **‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏î‡∏≥ (Black Galingale)** - Premium Thai herb
4. **‡πÑ‡∏û‡∏• (Plai)** - Traditional medicinal plant
5. **‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏° (Kratom)** - Controlled perennial crop

‚ö†Ô∏è **Important**: These 5 crops are **secondary options** to help farmers generate additional national income. They are NOT the primary focus of Phase 3 development. Future phases may expand support for these crops, but **cannabis remains the core mission**.

---

### Purpose

Phase 3 adds **intelligence and automation** to the GACP Platform, transforming it from a monitoring system into a **smart agricultural advisor for legal cannabis production**. This phase uses AI/ML to provide personalized recommendations, optimize resource usage, ensure GACP compliance, and predict outcomes - **primarily for cannabis cultivation** while maintaining optional support for secondary economic crops.

### Business Value (Cannabis-Focused)

**Primary Value for Cannabis Producers**:

- **Legal Compliance**: 100% GACP adherence with automated documentation
- **Quality Assurance**: Pharmaceutical-grade cannabis production
- **Cost Reduction**: Optimize fertilizer/water usage (save 20-40%)
- **Yield Improvement**: Data-driven decisions (increase 15-30%)
- **Traceability**: Complete audit trail for government submissions
- **Time Savings**: Automated recommendations (save 10+ hours/week)

**Secondary Value for Economic Crop Farmers**:

- **Knowledge Transfer**: AI assistant educates about cultivation best practices
- **Predictive Insights**: Prevent problems before they occur
- **Resource Optimization**: Efficient use of inputs across multiple crops
- **Market Access**: Meeting export standards for Thai medicinal plants

### Key Objectives

1. **Fertilizer Recommendation Engine** (Weeks 1-4)
   - Rule-based expert system
   - NPK optimization algorithms
   - Cost-effective fertilizer suggestions
   - Thai agricultural best practices

2. **Water Management AI** (Weeks 5-8)
   - Smart irrigation scheduling
   - Water usage optimization
   - Weather integration
   - Evapotranspiration calculations

3. **AI Assistant Enhancement** (Weeks 9-12)
   - Natural Language Processing (Thai)
   - Context-aware conversations
   - Agricultural knowledge base
   - Multi-modal responses

4. **Machine Learning Models** (Throughout)
   - Yield prediction model
   - Disease detection (future)
   - Optimal harvest timing
   - Resource optimization

### Success Criteria

**Cannabis Production (Primary)**:

- ‚úÖ 100% GACP compliance for all cannabis farms
- ‚úÖ 90%+ recommendation accuracy for cannabis cultivation
- ‚úÖ Complete audit trail documentation for legal submissions
- ‚úÖ Pharmaceutical-grade quality metrics tracking
- ‚úÖ 80%+ cannabis farmer satisfaction

**System Performance**:

- ‚úÖ Respond to Thai queries in <2 seconds
- ‚úÖ Reduce fertilizer costs by 20%+ (cannabis)
- ‚úÖ Reduce water usage by 25%+ (cannabis)
- ‚úÖ Handle 1000+ queries/day

**Secondary Crops (Optional)**:

- ‚úÖ Basic recommendations for 5 economic crops
- ‚úÖ 70%+ accuracy for secondary crop advice

---

## GACP Compliance & Legal Framework

### What is GACP?

**GACP** (Good Agricultural and Collection Practices for Medicinal Plants) is the Thai government standard established by the **Department of Thai Traditional and Alternative Medicine** (‡∏Å‡∏£‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) to ensure:

- **Quality**: Pharmaceutical-grade medicinal plant production
- **Safety**: Free from contaminants, heavy metals, pesticides
- **Traceability**: Complete documentation from seed to harvest
- **Sustainability**: Environmentally responsible cultivation
- **Legal Compliance**: Meeting all regulatory requirements

### Cannabis Legal Framework in Thailand

#### Regulatory Authority

**Department of Thai Traditional and Alternative Medicine (‡∏Å‡∏£‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)**

- Issues GACP certification
- Defines Standard Operating Procedures (SOP)
- Conducts farm inspections and audits
- Approves production licenses

#### GACP Requirements for Cannabis

1. **Farm Registration**
   - Legal land ownership or lease
   - Location approval from local authorities
   - GPS coordinates registration
   - Farm layout and facility plans

2. **Cultivation Standards**
   - Approved cannabis varieties only
   - Organic or approved input materials
   - Water quality standards
   - Soil testing and monitoring

3. **Record Keeping** (Critical for Platform)
   - Daily cultivation logs
   - Input usage records (fertilizers, pesticides)
   - Environmental monitoring data
   - Harvest and yield documentation
   - Worker training records

4. **Quality Control**
   - Regular soil and water testing
   - Plant health monitoring
   - Pest and disease management
   - Post-harvest quality testing

5. **Traceability**
   - Seed/clone source documentation
   - Batch numbering system
   - Chain of custody records
   - Storage and transport logs

### Platform's GACP Support

Our AI recommendation system is designed to **automatically ensure GACP compliance** by:

#### 1. Automated Documentation

```javascript
// All recommendations include GACP compliance notes
{
  recommendation: "Apply NPK 15-15-15 at 50kg/rai",
  gacpCompliance: {
    standard: "GACP-TH-2024",
    approvedProduct: true,
    maxAllowedDose: "60kg/rai",
    recordingRequired: true,
    documentationFields: [
      "applicationDate",
      "productBatch",
      "applicatorName",
      "weatherConditions",
      "soilMoisture"
    ]
  }
}
```

#### 2. Input Validation

- Only recommends **approved fertilizers and pesticides**
- Enforces maximum application rates
- Warns about restricted substances
- Tracks pre-harvest intervals (PHI)

#### 3. Audit Trail Generation

- Every action logged with timestamp
- User identification for accountability
- GPS location for field activities
- Photo documentation support

#### 4. SOP Enforcement

- Step-by-step cultivation guides
- Critical control point (CCP) alerts
- Deviation warnings
- Corrective action suggestions

#### 5. Compliance Reporting

- Generate GACP audit reports
- Export data for government submissions
- Certificate renewal reminders
- Non-compliance alerts

### Standard Operating Procedures (SOP)

The platform enforces official Thai GACP SOPs for cannabis:

#### SOP-01: Land Preparation

- Soil testing requirements
- Approved amendments
- pH adjustment procedures
- Drainage standards

#### SOP-02: Planting

- Clone/seed source verification
- Planting density standards
- Spacing requirements
- Record keeping at planting

#### SOP-03: Vegetative Stage Management

- Nutrient application schedule
- Watering requirements
- Pruning and training techniques
- Pest monitoring protocols

#### SOP-04: Flowering Stage Management

- Light cycle management (outdoor considerations)
- Bloom nutrient specifications
- Environmental controls
- Quality indicators

#### SOP-05: Harvest & Post-Harvest

- Maturity indicators
- Harvest timing
- Drying conditions (temp, humidity, duration)
- Storage requirements
- Testing protocols

#### SOP-06: Quality Assurance

- Cannabinoid testing requirements
- Heavy metal limits
- Microbial contamination tests
- Pesticide residue tests

### Compliance Monitoring

The platform provides **real-time compliance status**:

```javascript
{
  farmId: "FARM-001",
  gacpCertified: true,
  certificationExpiry: "2025-12-31",
  complianceScore: 95, // Out of 100

  recentViolations: [],

  upcomingRequirements: [
    {
      type: "soilTest",
      dueDate: "2025-11-15",
      priority: "high",
      description: "Annual soil testing required"
    },
    {
      type: "staffTraining",
      dueDate: "2025-12-01",
      priority: "medium",
      description: "Worker safety training renewal"
    }
  ],

  documentationStatus: {
    dailyLogs: "complete",
    inputRecords: "complete",
    harvestLogs: "pending",
    qualityTests: "complete"
  }
}
```

### Legal Compliance Benefits

By using this platform, cannabis producers gain:

1. **Simplified Compliance**: Automated record-keeping reduces paperwork
2. **Reduced Risk**: Real-time alerts prevent violations
3. **Faster Certification**: Complete documentation ready for audits
4. **Market Access**: GACP certification required for legal sales
5. **Quality Premiums**: Certified cannabis commands higher prices
6. **Legal Protection**: Complete audit trail for regulatory defense

---

## Fertilizer Recommendation Engine

### System Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                Fertilizer Recommendation Engine          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ                ‚îÇ                ‚îÇ
           ‚ñº                ‚ñº                ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Soil Data  ‚îÇ  ‚îÇ  Crop Type  ‚îÇ  ‚îÇ Growth Stage ‚îÇ
    ‚îÇ  Analyzer   ‚îÇ  ‚îÇ  Profile    ‚îÇ  ‚îÇ  Detector    ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                ‚îÇ                ‚îÇ
           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ  Rule Engine    ‚îÇ
                   ‚îÇ  (Expert System)‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ                ‚îÇ                ‚îÇ
           ‚ñº                ‚ñº                ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ NPK Balance ‚îÇ  ‚îÇ   Product   ‚îÇ  ‚îÇ  Application ‚îÇ
    ‚îÇ Calculator  ‚îÇ  ‚îÇ  Matcher    ‚îÇ  ‚îÇ   Schedule   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ Recommendations ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Soil Data Analyzer

**File**: `apps/backend/modules/ai-recommendations/domain/services/SoilDataAnalyzer.js`

```javascript
const { logger } = require('../../../../shared/utils/logger');

class SoilDataAnalyzer {
  /**
   * Analyze soil data and determine deficiencies
   * @param {Object} soilData - Current soil parameters
   * @param {Object} cropRequirements - Crop-specific requirements
   * @returns {Object} Analysis results with deficiencies
   */
  analyze(soilData, cropRequirements) {
    const analysis = {
      ph: this.analyzePH(soilData.ph, cropRequirements.ph),
      npk: this.analyzeNPK(soilData.npk, cropRequirements.npk),
      micronutrients: this.analyzeMicronutrients(
        soilData.micronutrients,
        cropRequirements.micronutrients
      ),
      organicMatter: this.analyzeOrganicMatter(soilData.organicMatter),
      overallHealth: 'good', // Will be calculated
      score: 0 // 0-100
    };

    // Calculate overall health score
    analysis.score = this.calculateHealthScore(analysis);
    analysis.overallHealth = this.getHealthStatus(analysis.score);

    return analysis;
  }

  /**
   * Analyze pH levels
   */
  analyzePH(currentPH, optimalRange) {
    if (!currentPH) {
      return {
        status: 'unknown',
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ pH',
        action: 'required'
      };
    }

    const { min, max, ideal } = optimalRange;

    if (currentPH < min - 0.5) {
      return {
        status: 'critical',
        issue: 'very_acidic',
        currentValue: currentPH,
        targetValue: ideal,
        difference: ideal - currentPH,
        message: `‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏î‡∏à‡∏±‡∏î (pH ${currentPH})`,
        severity: 'high',
        impact: '‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏ô‡∏¥‡∏î‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏Å ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ N, P, K, Ca, Mg',
        action: 'urgent'
      };
    }

    if (currentPH < min) {
      return {
        status: 'warning',
        issue: 'acidic',
        currentValue: currentPH,
        targetValue: ideal,
        difference: ideal - currentPH,
        message: `‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (pH ${currentPH})`,
        severity: 'medium',
        impact: '‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡∏î‡∏•‡∏á 20-30%',
        action: 'recommended'
      };
    }

    if (currentPH > max + 0.5) {
      return {
        status: 'critical',
        issue: 'very_alkaline',
        currentValue: currentPH,
        targetValue: ideal,
        difference: currentPH - ideal,
        message: `‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏î‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î (pH ${currentPH})`,
        severity: 'high',
        impact: '‡πÄ‡∏´‡∏•‡πá‡∏Å ‡πÅ‡∏°‡∏á‡∏Å‡∏≤‡∏ô‡∏µ‡∏™ ‡∏™‡∏±‡∏á‡∏Å‡∏∞‡∏™‡∏µ ‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å',
        action: 'urgent'
      };
    }

    if (currentPH > max) {
      return {
        status: 'warning',
        issue: 'alkaline',
        currentValue: currentPH,
        targetValue: ideal,
        difference: currentPH - ideal,
        message: `‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏î‡πà‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (pH ${currentPH})`,
        severity: 'medium',
        impact: '‡∏ò‡∏≤‡∏ï‡∏∏‡∏£‡∏≠‡∏á‡∏ö‡∏≤‡∏á‡∏ä‡∏ô‡∏¥‡∏î‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏Å',
        action: 'recommended'
      };
    }

    return {
      status: 'good',
      issue: null,
      currentValue: currentPH,
      targetValue: ideal,
      message: `‡∏Ñ‡πà‡∏≤ pH ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (${currentPH})`,
      action: 'maintain'
    };
  }

  /**
   * Analyze NPK levels
   */
  analyzeNPK(currentNPK, optimalNPK) {
    const analysis = {
      nitrogen: this.analyzeNutrient('nitrogen', 'N', currentNPK.nitrogen, optimalNPK.nitrogen, {
        symptoms: {
          deficient: ['‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏ä‡πâ‡∏≤', '‡∏•‡∏≥‡∏ï‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å'],
          excessive: ['‡πÉ‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥', '‡∏•‡∏≥‡∏ï‡πâ‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠', '‡πÇ‡∏£‡∏Ñ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô']
        },
        functions: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô ‡∏Ñ‡∏•‡∏≠‡πÇ‡∏£‡∏ü‡∏¥‡∏•‡∏•‡πå ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï',
        criticalStages: ['vegetative', 'early_flowering']
      }),

      phosphorus: this.analyzeNutrient(
        'phosphorus',
        'P',
        currentNPK.phosphorus,
        optimalNPK.phosphorus,
        {
          symptoms: {
            deficient: ['‡πÉ‡∏ö‡∏°‡∏∑‡∏î', '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á', '‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å‡∏ä‡πâ‡∏≤'],
            excessive: ['‡∏Ç‡∏±‡∏î‡∏Ç‡∏ß‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡∏™‡∏±‡∏á‡∏Å‡∏∞‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏•‡πá‡∏Å']
          },
          functions: '‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏≤‡∏Å ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ú‡∏• ‡∏™‡∏∞‡∏™‡∏°‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô',
          criticalStages: ['seedling', 'flowering', 'fruiting']
        }
      ),

      potassium: this.analyzeNutrient(
        'potassium',
        'K',
        currentNPK.potassium,
        optimalNPK.potassium,
        {
          symptoms: {
            deficient: ['‡∏Ç‡∏≠‡∏ö‡πÉ‡∏ö‡πÑ‡∏´‡∏°‡πâ', '‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ï‡πà‡∏≥', '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏ï‡πà‡∏≥'],
            excessive: ['‡∏Ç‡∏±‡∏î‡∏Ç‡∏ß‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡πÅ‡∏Ñ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡∏Å‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°']
          },
          functions: '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï ‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏™‡∏á',
          criticalStages: ['flowering', 'fruiting', 'ripening']
        }
      )
    };

    // Calculate NPK ratio
    const total =
      (currentNPK.nitrogen || 0) + (currentNPK.phosphorus || 0) + (currentNPK.potassium || 0);
    if (total > 0) {
      analysis.ratio = {
        n: Math.round((currentNPK.nitrogen / total) * 100),
        p: Math.round((currentNPK.phosphorus / total) * 100),
        k: Math.round((currentNPK.potassium / total) * 100)
      };
    }

    // Overall NPK balance
    const deficiencies = [analysis.nitrogen, analysis.phosphorus, analysis.potassium].filter(
      n => n.status === 'deficient' || n.status === 'very_deficient'
    );

    analysis.balanceStatus = deficiencies.length === 0 ? 'balanced' : 'imbalanced';
    analysis.deficiencyCount = deficiencies.length;

    return analysis;
  }

  /**
   * Analyze individual nutrient
   */
  analyzeNutrient(name, symbol, currentValue, optimal, metadata) {
    if (!currentValue && currentValue !== 0) {
      return {
        nutrient: name,
        symbol,
        status: 'unknown',
        message: `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•${symbol}`,
        action: 'test_required',
        metadata
      };
    }

    const { min, max, ideal } = optimal;
    const percentOfIdeal = (currentValue / ideal) * 100;

    // Very deficient (< 50% of minimum)
    if (currentValue < min * 0.5) {
      return {
        nutrient: name,
        symbol,
        status: 'very_deficient',
        currentValue,
        targetValue: ideal,
        percentOfIdeal: Math.round(percentOfIdeal),
        deficiency: ideal - currentValue,
        message: `${symbol} ‡∏Ç‡∏≤‡∏î‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (${currentValue} ppm, ‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${ideal} ppm)`,
        severity: 'critical',
        priority: 1,
        symptoms: metadata.symptoms.deficient,
        impact: `‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏•‡∏î‡∏•‡∏á 40-60%, ${metadata.functions}‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠`,
        action: 'urgent',
        metadata
      };
    }

    // Deficient (< minimum)
    if (currentValue < min) {
      return {
        nutrient: name,
        symbol,
        status: 'deficient',
        currentValue,
        targetValue: ideal,
        percentOfIdeal: Math.round(percentOfIdeal),
        deficiency: ideal - currentValue,
        message: `${symbol} ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå (${currentValue} ppm, ‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${ideal} ppm)`,
        severity: 'high',
        priority: 2,
        symptoms: metadata.symptoms.deficient,
        impact: `‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏•‡∏î‡∏•‡∏á 20-40%, ${metadata.functions}‡∏à‡∏≥‡∏Å‡∏±‡∏î`,
        action: 'recommended',
        metadata
      };
    }

    // Slightly low (< ideal)
    if (currentValue < ideal) {
      return {
        nutrient: name,
        symbol,
        status: 'low',
        currentValue,
        targetValue: ideal,
        percentOfIdeal: Math.round(percentOfIdeal),
        deficiency: ideal - currentValue,
        message: `${symbol} ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (${currentValue} ppm, ‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${ideal} ppm)`,
        severity: 'medium',
        priority: 3,
        impact: `‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏à‡∏•‡∏î‡∏•‡∏á 10-20%`,
        action: 'optional',
        metadata
      };
    }

    // Excessive (> maximum * 1.5)
    if (currentValue > max * 1.5) {
      return {
        nutrient: name,
        symbol,
        status: 'excessive',
        currentValue,
        targetValue: ideal,
        percentOfIdeal: Math.round(percentOfIdeal),
        excess: currentValue - ideal,
        message: `${symbol} ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (${currentValue} ppm, ‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${ideal} ppm)`,
        severity: 'high',
        priority: 2,
        symptoms: metadata.symptoms.excessive,
        impact: '‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏© ‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏∏‡πã‡∏¢‡πÇ‡∏î‡∏¢‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå',
        action: 'reduce',
        metadata
      };
    }

    // Slightly high (> maximum)
    if (currentValue > max) {
      return {
        nutrient: name,
        symbol,
        status: 'high',
        currentValue,
        targetValue: ideal,
        percentOfIdeal: Math.round(percentOfIdeal),
        excess: currentValue - ideal,
        message: `${symbol} ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (${currentValue} ppm)`,
        severity: 'low',
        priority: 4,
        impact: '‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á‡∏õ‡∏∏‡πã‡∏¢ ‡∏≠‡∏≤‡∏à‡∏Ç‡∏±‡∏î‡∏Ç‡∏ß‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏∑‡πà‡∏ô',
        action: 'reduce',
        metadata
      };
    }

    // Optimal
    return {
      nutrient: name,
      symbol,
      status: 'optimal',
      currentValue,
      targetValue: ideal,
      percentOfIdeal: Math.round(percentOfIdeal),
      message: `${symbol} ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (${currentValue} ppm)`,
      severity: 'none',
      priority: 5,
      action: 'maintain',
      metadata
    };
  }

  /**
   * Analyze micronutrients
   */
  analyzeMicronutrients(current, optimal) {
    if (!current || !optimal) {
      return {
        status: 'unknown',
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏≤‡∏ï‡∏∏‡∏£‡∏≠‡∏á',
        nutrients: []
      };
    }

    const micronutrients = ['iron', 'zinc', 'manganese', 'copper', 'boron', 'molybdenum'];
    const analysis = {};
    const deficiencies = [];

    micronutrients.forEach(nutrient => {
      if (current[nutrient] && optimal[nutrient]) {
        const status = this.getMicronutrientStatus(current[nutrient], optimal[nutrient]);
        analysis[nutrient] = status;

        if (status.deficient) {
          deficiencies.push(nutrient);
        }
      }
    });

    return {
      status: deficiencies.length === 0 ? 'adequate' : 'deficient',
      deficiencies,
      details: analysis,
      message:
        deficiencies.length === 0 ? '‡∏ò‡∏≤‡∏ï‡∏∏‡∏£‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' : `‡∏ò‡∏≤‡∏ï‡∏∏‡∏£‡∏≠‡∏á‡∏Ç‡∏≤‡∏î: ${deficiencies.join(', ')}`
    };
  }

  getMicronutrientStatus(current, optimal) {
    const { min, max } = optimal;

    if (current < min) {
      return {
        deficient: true,
        status: 'low',
        currentValue: current,
        targetValue: min,
        action: 'supplement'
      };
    }

    if (current > max) {
      return {
        deficient: false,
        status: 'high',
        currentValue: current,
        targetValue: max,
        action: 'reduce'
      };
    }

    return {
      deficient: false,
      status: 'adequate',
      currentValue: current,
      action: 'maintain'
    };
  }

  /**
   * Analyze organic matter
   */
  analyzeOrganicMatter(percentage) {
    if (!percentage && percentage !== 0) {
      return {
        status: 'unknown',
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏',
        action: 'test_required'
      };
    }

    if (percentage < 2) {
      return {
        status: 'very_low',
        percentage,
        targetRange: '4-6%',
        message: `‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å (${percentage}%)`,
        severity: 'high',
        impact: [
          '‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á ‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢',
          '‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏î‡∏µ',
          '‡∏à‡∏∏‡∏•‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ï‡πà‡∏≥',
          'CEC ‡∏ï‡πà‡∏≥ ‡πÄ‡∏Å‡πá‡∏ö‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'
        ],
        benefits: [
          '‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô 30-40%',
          '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
          '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏¥‡∏ô',
          '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏•‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå'
        ],
        action: 'urgent'
      };
    }

    if (percentage < 3) {
      return {
        status: 'low',
        percentage,
        targetRange: '4-6%',
        message: `‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ï‡πà‡∏≥ (${percentage}%)`,
        severity: 'medium',
        impact: ['‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏¥‡∏ô‡∏û‡∏≠‡πÉ‡∏ä‡πâ', '‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á'],
        action: 'recommended'
      };
    }

    if (percentage > 8) {
      return {
        status: 'high',
        percentage,
        targetRange: '4-6%',
        message: `‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏™‡∏π‡∏á (${percentage}%)`,
        severity: 'low',
        impact: ['‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î N immobilization', '‡∏î‡∏¥‡∏ô‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏î'],
        action: 'monitor'
      };
    }

    return {
      status: 'optimal',
      percentage,
      targetRange: '4-6%',
      message: `‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (${percentage}%)`,
      action: 'maintain'
    };
  }

  /**
   * Calculate overall soil health score (0-100)
   */
  calculateHealthScore(analysis) {
    let score = 100;

    // pH (20 points)
    if (analysis.ph.status === 'critical') score -= 20;
    else if (analysis.ph.status === 'warning') score -= 10;
    else if (analysis.ph.status === 'good') score -= 0;

    // NPK (40 points total)
    ['nitrogen', 'phosphorus', 'potassium'].forEach(nutrient => {
      const n = analysis.npk[nutrient];
      if (n.status === 'very_deficient' || n.status === 'excessive') score -= 15;
      else if (n.status === 'deficient' || n.status === 'high') score -= 8;
      else if (n.status === 'low') score -= 4;
    });

    // Organic Matter (20 points)
    const om = analysis.organicMatter;
    if (om.status === 'very_low') score -= 20;
    else if (om.status === 'low') score -= 10;
    else if (om.status === 'high') score -= 5;

    // Micronutrients (20 points)
    if (analysis.micronutrients.status === 'deficient') {
      score -= analysis.micronutrients.deficiencies.length * 5;
    }

    return Math.max(0, Math.min(100, score));
  }

  /**
   * Get health status from score
   */
  getHealthStatus(score) {
    if (score >= 80) return 'excellent';
    if (score >= 60) return 'good';
    if (score >= 40) return 'fair';
    return 'poor';
  }
}

module.exports = SoilDataAnalyzer;
```

### Crop Profile Database

**File**: `apps/backend/modules/ai-recommendations/data/crop-profiles.js`

```javascript
/**
 * Cannabis (Hemp/Medical) Growing Requirements
 * üéØ PRIMARY CROP - GACP Compliant
 * Based on Thai DOA research, GACP standards, and international best practices
 * Legal Framework: Department of Thai Traditional and Alternative Medicine
 */
const CANNABIS_PROFILE = {
  cropName: 'Cannabis',
  scientificName: 'Cannabis sativa L.',
  thaiName: '‡∏Å‡∏±‡∏ç‡∏ä‡∏≤',
  isPrimaryCrop: true, // Default crop for the platform
  gacpCompliant: true,
  regulatoryBody: '‡∏Å‡∏£‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',

  // Growth stages with durations
  growthStages: [
    {
      stage: 'germination',
      duration: { days: 3 - 10 },
      thaiName: '‡∏á‡∏≠‡∏Å',
      description: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏á‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏ï‡∏Å‡∏£‡∏≤‡∏Å‡πÅ‡∏£‡∏Å'
    },
    {
      stage: 'seedling',
      duration: { weeks: 2 - 3 },
      thaiName: '‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤',
      description: '‡πÉ‡∏ö‡πÅ‡∏ó‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏Å 2-6 ‡πÉ‡∏ö'
    },
    {
      stage: 'vegetative',
      duration: { weeks: 4 - 8 },
      thaiName: '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï',
      description: '‡∏•‡∏≥‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà'
    },
    {
      stage: 'pre_flowering',
      duration: { weeks: 1 - 2 },
      thaiName: '‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å',
      description: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏®‡∏û‡∏∑‡∏ä'
    },
    {
      stage: 'flowering',
      duration: { weeks: 6 - 12 },
      thaiName: '‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å',
      description: '‡∏î‡∏≠‡∏Å‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏™‡∏° cannabinoids'
    },
    {
      stage: 'ripening',
      duration: { weeks: 1 - 2 },
      thaiName: '‡∏™‡∏∏‡∏Å‡∏á‡∏≠‡∏°',
      description: '‡∏î‡∏≠‡∏Å‡∏™‡∏∏‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß'
    }
  ],

  // Soil requirements
  soilRequirements: {
    ph: {
      min: 6.0,
      max: 7.0,
      ideal: 6.5,
      notes: 'Cannabis ‡∏ä‡∏≠‡∏ö‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢'
    },

    // NPK by growth stage
    npk: {
      germination: {
        nitrogen: { min: 0, max: 50, ideal: 20 },
        phosphorus: { min: 20, max: 60, ideal: 40 },
        potassium: { min: 10, max: 40, ideal: 20 },
        ratio: '1-2-1'
      },
      seedling: {
        nitrogen: { min: 50, max: 100, ideal: 80 },
        phosphorus: { min: 40, max: 80, ideal: 60 },
        potassium: { min: 40, max: 80, ideal: 60 },
        ratio: '2-1-1'
      },
      vegetative: {
        nitrogen: { min: 100, max: 200, ideal: 150 },
        phosphorus: { min: 40, max: 80, ideal: 60 },
        potassium: { min: 80, max: 150, ideal: 120 },
        ratio: '3-1-2'
      },
      flowering: {
        nitrogen: { min: 50, max: 100, ideal: 80 },
        phosphorus: { min: 80, max: 150, ideal: 120 },
        potassium: { min: 150, max: 250, ideal: 200 },
        ratio: '1-3-3'
      },
      ripening: {
        nitrogen: { min: 20, max: 50, ideal: 30 },
        phosphorus: { min: 60, max: 120, ideal: 90 },
        potassium: { min: 180, max: 280, ideal: 220 },
        ratio: '0-1-3'
      }
    },

    // Micronutrients (ppm)
    micronutrients: {
      iron: { min: 2, max: 5, ideal: 3 },
      zinc: { min: 1, max: 3, ideal: 2 },
      manganese: { min: 1, max: 3, ideal: 2 },
      copper: { min: 0.1, max: 0.5, ideal: 0.2 },
      boron: { min: 0.5, max: 1.5, ideal: 1.0 },
      molybdenum: { min: 0.01, max: 0.05, ideal: 0.02 },
      calcium: { min: 150, max: 300, ideal: 200 },
      magnesium: { min: 40, max: 100, ideal: 60 },
      sulfur: { min: 20, max: 50, ideal: 30 }
    },

    organicMatter: {
      min: 3,
      ideal: 5,
      max: 8,
      unit: '%'
    },

    ec: {
      min: 1.0,
      ideal: 1.5,
      max: 2.2,
      unit: 'mS/cm'
    }
  },

  // Water requirements
  waterRequirements: {
    germination: {
      moisture: { min: 60, max: 80, ideal: 70 },
      frequency: 'keep moist, not wet',
      amount: { min: 0.1, max: 0.3, unit: 'L/plant/day' }
    },
    seedling: {
      moisture: { min: 50, max: 70, ideal: 60 },
      frequency: 'once daily',
      amount: { min: 0.3, max: 0.5, unit: 'L/plant/day' }
    },
    vegetative: {
      moisture: { min: 40, max: 60, ideal: 50 },
      frequency: 'once or twice daily',
      amount: { min: 1, max: 3, unit: 'L/plant/day' }
    },
    flowering: {
      moisture: { min: 35, max: 55, ideal: 45 },
      frequency: 'once or twice daily',
      amount: { min: 2, max: 5, unit: 'L/plant/day' }
    },
    ripening: {
      moisture: { min: 30, max: 50, ideal: 40 },
      frequency: 'reduce gradually',
      amount: { min: 0.5, max: 2, unit: 'L/plant/day' },
      notes: '‡∏•‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏Ç‡∏≠‡∏á resin'
    }
  },

  // Environmental requirements
  environment: {
    temperature: {
      day: { min: 20, ideal: 26, max: 30, unit: 'C' },
      night: { min: 16, ideal: 20, max: 24, unit: 'C' },
      notes: '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô-‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏ß‡∏£‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô 4-6¬∞C'
    },
    humidity: {
      vegetative: { min: 50, ideal: 60, max: 70, unit: '%' },
      flowering: { min: 40, ideal: 50, max: 60, unit: '%' },
      notes: '‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏î‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤'
    },
    light: {
      vegetative: { hours: 18, intensity: 'high' },
      flowering: { hours: 12, intensity: 'high' },
      notes: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏á‡πÅ‡∏£‡∏á 600-1000 ¬µmol/m¬≤/s'
    }
  },

  // Common deficiency symptoms
  deficiencySymptoms: {
    nitrogen: {
      symptoms: ['‡πÉ‡∏ö‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏ä‡πâ‡∏≤', '‡∏•‡∏≥‡∏ï‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å', '‡πÉ‡∏ö‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å'],
      progression: '‡πÉ‡∏ö‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏°‡πÑ‡∏õ‡πÉ‡∏ö‡∏ö‡∏ô',
      urgency: 'high',
      reversible: true
    },
    phosphorus: {
      symptoms: ['‡πÉ‡∏ö‡∏°‡∏∑‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', '‡πÉ‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡πâ‡∏á', '‡∏£‡∏≤‡∏Å<red', '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏ä‡πâ‡∏≤'],
      progression: '‡πÉ‡∏ö‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Å‡πà‡∏≠‡∏ô',
      urgency: 'high',
      reversible: true
    },
    potassium: {
      symptoms: ['‡∏Ç‡∏≠‡∏ö‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏´‡∏°‡πâ', '‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ö‡∏ô‡πÉ‡∏ö', '‡∏•‡∏≥‡∏ï‡πâ‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠', '‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ï‡πà‡∏≥'],
      progression: '‡πÉ‡∏ö‡∏•‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏ö‡πÉ‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Å‡πà‡∏≠‡∏ô',
      urgency: 'medium',
      reversible: true
    },
    calcium: {
      symptoms: ['‡∏¢‡∏≠‡∏î‡∏≠‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏¢', '‡∏Ç‡∏≠‡∏ö‡πÉ‡∏ö‡∏á‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏°‡πâ‡∏ß‡∏ô', '‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ö‡∏ô‡∏ú‡∏•'],
      progression: '‡∏¢‡∏≠‡∏î‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Å‡πà‡∏≠‡∏ô',
      urgency: 'medium',
      reversible: false
    },
    magnesium: {
      symptoms: ['‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ö‡∏¢‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', '‡πÉ‡∏ö‡∏•‡πà‡∏≤‡∏á‡πÅ‡∏´‡πâ‡∏á', '‡πÉ‡∏ö‡∏°‡πâ‡∏ß‡∏ô'],
      progression: '‡πÉ‡∏ö‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Å‡πà‡∏≠‡∏ô',
      urgency: 'medium',
      reversible: true
    },
    iron: {
      symptoms: ['‡πÉ‡∏ö‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', '‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ö‡∏¢‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', '‡∏¢‡∏≠‡∏î‡∏≠‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡∏î'],
      progression: '‡πÉ‡∏ö‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Å‡πà‡∏≠‡∏ô',
      urgency: 'medium',
      reversible: true
    },
    zinc: {
      symptoms: ['‡πÉ‡∏ö‡πÄ‡∏•‡πá‡∏Å', '‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡πâ‡∏ô', '‡πÉ‡∏ö‡∏ö‡∏¥‡∏î‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß'],
      progression: '‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö',
      urgency: 'low',
      reversible: true
    }
  }
};

/**
 * Turmeric (‡∏Ç‡∏°‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏ô) Growing Requirements
 * üí∞ SECONDARY ECONOMIC CROP (Optional - Not Phase 3 Focus)
 * Curcuma longa - Thai medicinal plant for export and national income
 */
const TURMERIC_PROFILE = {
  cropName: 'Turmeric',
  scientificName: 'Curcuma longa L.',
  thaiName: '‡∏Ç‡∏°‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏ô',
  isPrimaryCrop: false, // Secondary economic crop
  gacpCompliant: false, // Basic recommendations only
  developmentPhase: 'future', // Full support in future phases

  growthStages: [
    { stage: 'planting', duration: { days: 1 }, thaiName: '‡∏õ‡∏•‡∏π‡∏Å' },
    { stage: 'sprouting', duration: { weeks: 2 - 3 }, thaiName: '‡∏á‡∏≠‡∏Å' },
    { stage: 'vegetative', duration: { months: 3 - 4 }, thaiName: '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï' },
    { stage: 'rhizome_development', duration: { months: 3 - 4 }, thaiName: '‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏´‡∏á‡πâ‡∏≤' },
    { stage: 'maturity', duration: { months: 1 - 2 }, thaiName: '‡∏™‡∏∏‡∏Å‡πÅ‡∏Å‡πà' }
  ],

  soilRequirements: {
    ph: { min: 5.5, max: 7.5, ideal: 6.5 },
    npk: {
      vegetative: {
        nitrogen: { min: 80, max: 120, ideal: 100 },
        phosphorus: { min: 60, max: 100, ideal: 80 },
        potassium: { min: 100, max: 150, ideal: 120 },
        ratio: '1-1-1.5'
      },
      rhizome_development: {
        nitrogen: { min: 60, max: 100, ideal: 80 },
        phosphorus: { min: 80, max: 120, ideal: 100 },
        potassium: { min: 120, max: 180, ideal: 150 },
        ratio: '1-1.5-2'
      }
    },
    micronutrients: {
      zinc: { min: 5, max: 15, ideal: 10 },
      boron: { min: 0.5, max: 2, ideal: 1 }
    }
  },

  waterRequirements: {
    vegetative: { mmPerWeek: 40 - 50 },
    rhizome_development: { mmPerWeek: 30 - 40 },
    maturity: { mmPerWeek: 20 - 30 }
  },

  harvestTime: '8-10 months after planting',
  tips: [
    '‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏ã‡∏∏‡∏¢ ‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏î‡∏µ',
    '‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏á‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡∏ô‡∏≤‡∏î 20-30 ‡∏Å‡∏£‡∏±‡∏°',
    '‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å 2-3 ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏•‡∏π‡∏Å',
    '‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≥‡∏Ç‡∏±‡∏á',
    '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÅ‡∏´‡πâ‡∏á'
  ]
};

/**
 * Ginger (‡∏Ç‡∏¥‡∏á) Growing Requirements
 * üí∞ SECONDARY ECONOMIC CROP (Optional - Not Phase 3 Focus)
 */
const GINGER_PROFILE = {
  cropName: 'Ginger',
  scientificName: 'Zingiber officinale Roscoe',
  thaiName: '‡∏Ç‡∏¥‡∏á',
  isPrimaryCrop: false,
  developmentPhase: 'future',

  growthStages: [
    { stage: 'planting', duration: { days: 1 }, thaiName: '‡∏õ‡∏•‡∏π‡∏Å' },
    { stage: 'sprouting', duration: { weeks: 2 - 4 }, thaiName: '‡∏á‡∏≠‡∏Å' },
    { stage: 'vegetative', duration: { months: 4 - 5 }, thaiName: '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï' },
    { stage: 'rhizome_formation', duration: { months: 3 - 4 }, thaiName: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏á‡πâ‡∏≤' },
    { stage: 'maturity', duration: { months: 1 - 2 }, thaiName: '‡∏™‡∏∏‡∏Å‡πÅ‡∏Å‡πà' }
  ],

  soilRequirements: {
    ph: { min: 5.5, max: 6.5, ideal: 6.0 },
    npk: {
      vegetative: {
        nitrogen: { min: 100, max: 150, ideal: 120 },
        phosphorus: { min: 50, max: 80, ideal: 60 },
        potassium: { min: 80, max: 120, ideal: 100 },
        ratio: '2-1-1.5'
      },
      rhizome_formation: {
        nitrogen: { min: 80, max: 120, ideal: 100 },
        phosphorus: { min: 60, max: 100, ideal: 80 },
        potassium: { min: 120, max: 180, ideal: 150 },
        ratio: '1-1-2'
      }
    }
  },

  waterRequirements: {
    vegetative: { mmPerWeek: 50 - 60 },
    rhizome_formation: { mmPerWeek: 40 - 50 },
    maturity: { mmPerWeek: 20 - 30 }
  },

  harvestTime: '10-12 months for mature rhizomes, 4-6 months for young ginger',
  tips: [
    '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏î‡∏µ ‡πÄ‡∏´‡∏á‡πâ‡∏≤‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á ‡πÑ‡∏°‡πà‡πÄ‡∏ô‡πà‡∏≤',
    '‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏™‡∏π‡∏á',
    '‡∏£‡∏∞‡∏¢‡∏∞‡∏õ‡∏•‡∏π‡∏Å 30x30 cm ‡∏´‡∏£‡∏∑‡∏≠ 40x40 cm',
    '‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á‡∏à‡∏±‡∏î',
    '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡∏¥‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏π‡∏Å 4-5 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'
  ]
};

/**
 * Black Galingale (‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏î‡∏≥) Growing Requirements
 * üí∞ SECONDARY ECONOMIC CROP (Optional - Not Phase 3 Focus)
 */
const BLACK_GALINGALE_PROFILE = {
  cropName: 'Black Galingale',
  scientificName: 'Kaempferia parviflora Wall. ex Baker',
  thaiName: '‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏î‡∏≥',
  isPrimaryCrop: false,
  developmentPhase: 'future',

  growthStages: [
    { stage: 'planting', duration: { days: 1 }, thaiName: '‡∏õ‡∏•‡∏π‡∏Å' },
    { stage: 'sprouting', duration: { weeks: 3 - 4 }, thaiName: '‡∏á‡∏≠‡∏Å' },
    { stage: 'vegetative', duration: { months: 5 - 6 }, thaiName: '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï' },
    { stage: 'rhizome_development', duration: { months: 4 - 5 }, thaiName: '‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏´‡∏á‡πâ‡∏≤' },
    { stage: 'dormancy', duration: { months: 2 - 3 }, thaiName: '‡∏û‡∏±‡∏Å‡∏ï‡∏±‡∏ß' }
  ],

  soilRequirements: {
    ph: { min: 5.0, max: 6.5, ideal: 5.8 },
    npk: {
      vegetative: {
        nitrogen: { min: 60, max: 100, ideal: 80 },
        phosphorus: { min: 40, max: 70, ideal: 50 },
        potassium: { min: 80, max: 120, ideal: 100 },
        ratio: '1.5-1-2'
      },
      rhizome_development: {
        nitrogen: { min: 40, max: 80, ideal: 60 },
        phosphorus: { min: 60, max: 100, ideal: 80 },
        potassium: { min: 100, max: 150, ideal: 120 },
        ratio: '1-1.5-2'
      }
    }
  },

  waterRequirements: {
    vegetative: { mmPerWeek: 35 - 45 },
    rhizome_development: { mmPerWeek: 30 - 40 },
    dormancy: { mmPerWeek: 10 - 20 }
  },

  harvestTime: '12-15 months after planting',
  tips: [
    '‡∏ä‡∏≠‡∏ö‡∏£‡πà‡∏°‡πÄ‡∏á‡∏≤ ‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ï‡πâ‡∏£‡πà‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ',
    '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠',
    '‡∏î‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏™‡∏π‡∏á',
    '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡∏¢‡∏Å‡πÅ‡∏õ‡∏•‡∏á',
    '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô'
  ]
};

/**
 * Plai/Cassumunar Ginger (‡πÑ‡∏û‡∏•) Growing Requirements
 * üí∞ SECONDARY ECONOMIC CROP (Optional - Not Phase 3 Focus)
 */
const PLAI_PROFILE = {
  cropName: 'Plai',
  scientificName: 'Zingiber cassumunar Roxb.',
  thaiName: '‡πÑ‡∏û‡∏•',
  isPrimaryCrop: false,
  developmentPhase: 'future',

  growthStages: [
    { stage: 'planting', duration: { days: 1 }, thaiName: '‡∏õ‡∏•‡∏π‡∏Å' },
    { stage: 'sprouting', duration: { weeks: 2 - 3 }, thaiName: '‡∏á‡∏≠‡∏Å' },
    { stage: 'vegetative', duration: { months: 3 - 4 }, thaiName: '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï' },
    { stage: 'rhizome_formation', duration: { months: 3 - 4 }, thaiName: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏á‡πâ‡∏≤' },
    { stage: 'maturity', duration: { months: 1 - 2 }, thaiName: '‡∏™‡∏∏‡∏Å‡πÅ‡∏Å‡πà' }
  ],

  soilRequirements: {
    ph: { min: 5.5, max: 7.0, ideal: 6.0 },
    npk: {
      vegetative: {
        nitrogen: { min: 80, max: 120, ideal: 100 },
        phosphorus: { min: 50, max: 80, ideal: 60 },
        potassium: { min: 80, max: 120, ideal: 100 },
        ratio: '1.5-1-1.5'
      },
      rhizome_formation: {
        nitrogen: { min: 60, max: 100, ideal: 80 },
        phosphorus: { min: 60, max: 100, ideal: 80 },
        potassium: { min: 100, max: 150, ideal: 120 },
        ratio: '1-1-1.5'
      }
    }
  },

  waterRequirements: {
    vegetative: { mmPerWeek: 40 - 50 },
    rhizome_formation: { mmPerWeek: 35 - 45 },
    maturity: { mmPerWeek: 25 - 35 }
  },

  harvestTime: '8-10 months after planting',
  tips: [
    '‡∏ó‡∏ô‡∏£‡πà‡∏°‡πÄ‡∏á‡∏≤‡πÑ‡∏î‡πâ‡∏î‡∏µ ‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ï‡πâ‡πÑ‡∏°‡πâ‡∏ú‡∏•‡πÑ‡∏î‡πâ',
    '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô ‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏',
    '‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏´‡πâ‡∏á‡∏à‡∏±‡∏î',
    '‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏á‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å 30-40 ‡∏Å‡∏£‡∏±‡∏°',
    '‡∏ô‡∏¥‡∏¢‡∏°‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£'
  ]
};

/**
 * Kratom (‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°) Growing Requirements
 * üí∞ SECONDARY ECONOMIC CROP (Optional - Not Phase 3 Focus)
 * ‚ö†Ô∏è Highly regulated - requires special permits
 */
const KRATOM_PROFILE = {
  cropName: 'Kratom',
  scientificName: 'Mitragyna speciosa Korth.',
  thaiName: '‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°',
  isPrimaryCrop: false,
  developmentPhase: 'future',
  regulatoryWarning: 'Requires special cultivation permits and legal compliance',

  growthStages: [
    { stage: 'seedling', duration: { months: 3 - 6 }, thaiName: '‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤' },
    { stage: 'young_tree', duration: { years: 1 - 2 }, thaiName: '‡∏ï‡πâ‡∏ô‡∏≠‡πà‡∏≠‡∏ô' },
    { stage: 'mature_tree', duration: { years: 2 - 3 }, thaiName: '‡∏ï‡πâ‡∏ô‡πÇ‡∏ï' },
    { stage: 'production', duration: { years: '3+' }, thaiName: '‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï' }
  ],

  soilRequirements: {
    ph: { min: 5.5, max: 6.8, ideal: 6.0 },
    npk: {
      young_tree: {
        nitrogen: { min: 100, max: 150, ideal: 120 },
        phosphorus: { min: 40, max: 70, ideal: 50 },
        potassium: { min: 80, max: 120, ideal: 100 },
        ratio: '2-1-2'
      },
      mature_tree: {
        nitrogen: { min: 120, max: 180, ideal: 150 },
        phosphorus: { min: 50, max: 80, ideal: 60 },
        potassium: { min: 100, max: 150, ideal: 120 },
        ratio: '2.5-1-2'
      }
    },
    micronutrients: {
      iron: { min: 20, max: 50, ideal: 30 },
      magnesium: { min: 30, max: 60, ideal: 40 }
    }
  },

  waterRequirements: {
    young_tree: { mmPerWeek: 50 - 70 },
    mature_tree: { mmPerWeek: 60 - 80 },
    production: { mmPerWeek: 70 - 90 }
  },

  harvestTime: 'Leaf harvest every 3-4 months after 3 years',
  tips: [
    '‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏°‡πâ‡∏¢‡∏∑‡∏ô‡∏ï‡πâ‡∏ô ‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏ä‡πâ‡∏≤',
    '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏π‡∏á ‡∏£‡πà‡∏°‡πÄ‡∏á‡∏≤‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô',
    '‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏ú‡∏™‡∏≤‡∏ô',
    '‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ö 3-4 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏ï‡πâ‡∏ô‡πÇ‡∏ï',
    '‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°',
    '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï'
  ]
};

module.exports = {
  CANNABIS_PROFILE,
  TURMERIC_PROFILE,
  GINGER_PROFILE,
  BLACK_GALINGALE_PROFILE,
  PLAI_PROFILE,
  KRATOM_PROFILE,

  /**
   * Get crop profile by name
   */
  getCropProfile(cropName) {
    // If no crop name provided, default to Cannabis (primary crop)
    if (!cropName) {
      return CANNABIS_PROFILE;
    }

    const lowerName = cropName.toLowerCase();

    // Cannabis - Primary Crop (Default)
    if (lowerName.includes('cannabis') || lowerName.includes('‡∏Å‡∏±‡∏ç‡∏ä‡∏≤')) {
      return CANNABIS_PROFILE;
    }

    // Secondary Economic Crops (Optional)
    if (lowerName.includes('turmeric') || lowerName.includes('‡∏Ç‡∏°‡∏¥‡πâ‡∏ô')) {
      return TURMERIC_PROFILE;
    }
    if (lowerName.includes('ginger') || lowerName.includes('‡∏Ç‡∏¥‡∏á')) {
      return GINGER_PROFILE;
    }
    if (lowerName.includes('galingale') || lowerName.includes('‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢')) {
      return BLACK_GALINGALE_PROFILE;
    }
    if (lowerName.includes('plai') || lowerName.includes('‡πÑ‡∏û‡∏•')) {
      return PLAI_PROFILE;
    }
    if (lowerName.includes('kratom') || lowerName.includes('‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°')) {
      return KRATOM_PROFILE;
    }

    // If crop not recognized, default to Cannabis
    return CANNABIS_PROFILE;
  },

  /**
   * Get requirements for specific growth stage
   */
  getStageRequirements(cropProfile, stage) {
    return {
      npk: cropProfile.soilRequirements.npk[stage],
      water: cropProfile.waterRequirements[stage],
      environment: cropProfile.environment
    };
  }
};
```

### Fertilizer Recommendation Service

**File**: `apps/backend/modules/ai-recommendations/domain/services/FertilizerRecommendationService.js`

```javascript
const SoilDataAnalyzer = require('./SoilDataAnalyzer');
const { getCropProfile, getStageRequirements } = require('../../data/crop-profiles');
const { logger } = require('../../../../shared/utils/logger');

class FertilizerRecommendationService {
  constructor() {
    this.soilAnalyzer = new SoilDataAnalyzer();
    this.productDatabase = require('../../data/fertilizer-products');
  }

  /**
   * Generate complete fertilizer recommendations
   */
  async generateRecommendations(farmData) {
    const { soilData, cropType, growthStage, farmSize, budget } = farmData;

    // Get crop profile
    const cropProfile = getCropProfile(cropType);
    if (!cropProfile) {
      throw new Error(`Crop profile not found for: ${cropType}`);
    }

    // Get stage requirements
    const requirements = getStageRequirements(cropProfile, growthStage);

    // Analyze current soil
    const soilAnalysis = this.soilAnalyzer.analyze(soilData, {
      ph: cropProfile.soilRequirements.ph,
      npk: requirements.npk,
      micronutrients: cropProfile.soilRequirements.micronutrients,
      organicMatter: cropProfile.soilRequirements.organicMatter
    });

    // Generate recommendations
    const recommendations = [];

    // pH Correction
    if (soilAnalysis.ph.action !== 'maintain') {
      const phRec = this.generatePHCorrection(soilAnalysis.ph, farmSize);
      if (phRec) recommendations.push(phRec);
    }

    // NPK Fertilizers
    const npkRecs = this.generateNPKRecommendations(
      soilAnalysis.npk,
      requirements.npk,
      growthStage,
      farmSize
    );
    recommendations.push(...npkRecs);

    // Organic Matter
    if (soilAnalysis.organicMatter.action !== 'maintain') {
      const omRec = this.generateOrganicMatterRecommendation(soilAnalysis.organicMatter, farmSize);
      if (omRec) recommendations.push(omRec);
    }

    // Micronutrients
    if (soilAnalysis.micronutrients.deficiencies.length > 0) {
      const microRec = this.generateMicronutrientRecommendation(
        soilAnalysis.micronutrients,
        farmSize
      );
      if (microRec) recommendations.push(microRec);
    }

    // Calculate total cost
    const totalCost = recommendations.reduce((sum, rec) => sum + (rec.estimatedCost || 0), 0);

    // Budget optimization
    if (budget && totalCost > budget) {
      this.optimizeForBudget(recommendations, budget);
    }

    return {
      soilAnalysis,
      recommendations: this.prioritizeRecommendations(recommendations),
      summary: {
        totalRecommendations: recommendations.length,
        estimatedCost: totalCost,
        expectedImprovements: this.calculateExpectedImprovements(soilAnalysis, recommendations),
        applicationSchedule: this.generateApplicationSchedule(recommendations, growthStage)
      }
    };
  }

  /**
   * Generate pH correction recommendation
   */
  generatePHCorrection(phAnalysis, farmSize) {
    if (phAnalysis.issue === 'very_acidic' || phAnalysis.issue === 'acidic') {
      // Use agricultural lime
      const limeAmount = Math.ceil(phAnalysis.difference * 500 * farmSize); // kg per rai

      return {
        priority: phAnalysis.severity === 'high' ? 1 : 2,
        category: 'pH Correction',
        issue: phAnalysis.message,
        currentValue: phAnalysis.currentValue,
        targetValue: phAnalysis.targetValue,

        product: {
          name: '‡∏õ‡∏π‡∏ô‡∏Ç‡∏≤‡∏ß (Agricultural Lime)',
          type: 'pH Amendment',
          composition: 'CaCO3',
          form: 'powder'
        },

        application: {
          amount: limeAmount,
          unit: 'kg',
          perArea: `${limeAmount / farmSize} kg/rai`,
          method: 'broadcast',
          methodThai: '‡πÇ‡∏£‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÅ‡∏õ‡∏•‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏£‡∏ß‡∏ô‡∏î‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô',
          timing: '‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏•‡∏π‡∏Å 2-4 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
          frequency: '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß',
          waterAfter: true
        },

        estimatedCost: limeAmount * 15, // 15 baht/kg
        expectedResult: `pH ‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${phAnalysis.targetValue} ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 2-4 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå`,
        benefits: [
          '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
          '‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏∏‡∏•‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå',
          '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏¥‡∏ô',
          '‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡πÅ‡∏Å‡πà‡∏û‡∏∑‡∏ä'
        ],
        warnings: [
          '‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏™‡πà‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏î‡πà‡∏≤‡∏á',
          '‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à pH ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
          '‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏™‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πã‡∏¢‡∏¢‡∏π‡πÄ‡∏£‡∏µ‡∏¢ (‡∏£‡∏≠ 1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)'
        ]
      };
    }

    if (phAnalysis.issue === 'very_alkaline' || phAnalysis.issue === 'alkaline') {
      // Use sulfur
      const sulfurAmount = Math.ceil(phAnalysis.difference * 300 * farmSize);

      return {
        priority: phAnalysis.severity === 'high' ? 1 : 2,
        category: 'pH Correction',
        issue: phAnalysis.message,
        currentValue: phAnalysis.currentValue,
        targetValue: phAnalysis.targetValue,

        product: {
          name: '‡∏Å‡∏≥‡∏°‡∏∞‡∏ñ‡∏±‡∏ô (Elemental Sulfur)',
          type: 'pH Amendment',
          composition: 'S',
          form: 'powder'
        },

        application: {
          amount: sulfurAmount,
          unit: 'kg',
          perArea: `${sulfurAmount / farmSize} kg/rai`,
          method: 'broadcast and incorporate',
          methodThai: '‡∏ú‡∏™‡∏°‡∏Ñ‡∏•‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏•‡πâ‡∏≤‡∏î‡∏¥‡∏ô ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡∏∏‡πà‡∏°',
          timing: '‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏•‡∏π‡∏Å 3-4 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
          frequency: '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß',
          waterAfter: true
        },

        estimatedCost: sulfurAmount * 25, // 25 baht/kg
        expectedResult: `pH ‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${phAnalysis.targetValue} ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 3-4 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå`,
        benefits: ['‡∏•‡∏î pH ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡πÄ‡∏´‡∏•‡πá‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡∏á‡∏Å‡∏≤‡∏ô‡∏µ‡∏™', '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡∏ò‡∏≤‡∏ï‡∏∏‡∏£‡∏≠‡∏á'],
        warnings: [
          '‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô 3-4 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•',
          '‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö pH ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠'
        ]
      };
    }

    return null;
  }

  /**
   * Generate NPK fertilizer recommendations
   */
  generateNPKRecommendations(npkAnalysis, requirements, growthStage, farmSize) {
    const recommendations = [];

    // Nitrogen
    if (
      npkAnalysis.nitrogen.status === 'very_deficient' ||
      npkAnalysis.nitrogen.status === 'deficient'
    ) {
      const nRec = this.recommendNitrogen(npkAnalysis.nitrogen, growthStage, farmSize);
      recommendations.push(nRec);
    }

    // Phosphorus
    if (
      npkAnalysis.phosphorus.status === 'very_deficient' ||
      npkAnalysis.phosphorus.status === 'deficient'
    ) {
      const pRec = this.recommendPhosphorus(npkAnalysis.phosphorus, growthStage, farmSize);
      recommendations.push(pRec);
    }

    // Potassium
    if (
      npkAnalysis.potassium.status === 'very_deficient' ||
      npkAnalysis.potassium.status === 'deficient'
    ) {
      const kRec = this.recommendPotassium(npkAnalysis.potassium, growthStage, farmSize);
      recommendations.push(kRec);
    }

    // Balanced NPK for maintenance
    if (recommendations.length === 0 && growthStage !== 'germination') {
      const balancedRec = this.recommendBalancedNPK(requirements, growthStage, farmSize);
      recommendations.push(balancedRec);
    }

    return recommendations;
  }

  recommendNitrogen(nAnalysis, growthStage, farmSize) {
    const deficiency = nAnalysis.deficiency;
    const amountKg = Math.ceil((deficiency * farmSize * 0.4) / 100); // Convert ppm to kg, 40% efficiency

    // Choose product based on growth stage
    let product;
    if (growthStage === 'vegetative') {
      product = {
        name: '‡∏õ‡∏∏‡πã‡∏¢‡∏¢‡∏π‡πÄ‡∏£‡∏µ‡∏¢',
        npk: '46-0-0',
        nContent: 46,
        form: 'granular',
        price: 15 // baht/kg
      };
    } else {
      product = {
        name: 'Blood Meal (‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå)',
        npk: '12-0-0',
        nContent: 12,
        form: 'powder',
        price: 35
      };
    }

    const productAmount = Math.ceil((amountKg * 100) / product.nContent);

    return {
      priority: nAnalysis.priority,
      category: 'Nitrogen (N)',
      issue: nAnalysis.message,
      currentValue: nAnalysis.currentValue,
      targetValue: nAnalysis.targetValue,
      deficiency: deficiency,

      product: {
        name: product.name,
        type: 'Nitrogen Fertilizer',
        npk: product.npk,
        form: product.form
      },

      application: {
        amount: productAmount,
        unit: 'kg',
        perArea: `${(productAmount / farmSize).toFixed(1)} kg/rai`,
        method: growthStage === 'vegetative' ? 'side dress or fertigation' : 'broadcast',
        methodThai: growthStage === 'vegetative' ? '‡πÇ‡∏£‡∏¢‡∏£‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏ô‡∏ï‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏£‡∏î' : '‡πÇ‡∏£‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÅ‡∏õ‡∏•‡∏á',
        timing: growthStage === 'vegetative' ? '‡∏ó‡∏∏‡∏Å 7-10 ‡∏ß‡∏±‡∏ô' : '‡∏ó‡∏∏‡∏Å 14 ‡∏ß‡∏±‡∏ô',
        frequency: '3-4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
        splitApplication: true
      },

      estimatedCost: productAmount * product.price,
      expectedResult: `‡∏£‡∏∞‡∏î‡∏±‡∏ö N ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${nAnalysis.targetValue} ppm ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 2-3 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå`,
      benefits: [
        '‡πÉ‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏° ‡∏°‡∏µ‡∏Ñ‡∏•‡∏≠‡πÇ‡∏£‡∏ü‡∏¥‡∏•‡∏•‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô',
        '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô',
        '‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 20-40%'
      ],
      warnings: [
        '‡πÅ‡∏ö‡πà‡∏á‡πÉ‡∏™‡πà‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
        '‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÉ‡∏™‡πà‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ö‡πÑ‡∏´‡∏°‡πâ',
        '‡∏•‡∏î‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏î‡∏≠‡∏Å'
      ]
    };
  }

  recommendPhosphorus(pAnalysis, growthStage, farmSize) {
    const deficiency = pAnalysis.deficiency;
    const amountKg = Math.ceil((deficiency * farmSize * 0.3) / 100);

    const product = {
      name: '‡∏õ‡∏∏‡πã‡∏¢‡∏ã‡∏∏‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏ü‡∏≠‡∏™‡πÄ‡∏ü‡∏ï',
      npk: '0-20-0',
      pContent: 20,
      form: 'granular',
      price: 18
    };

    const productAmount = Math.ceil((amountKg * 100) / product.pContent);

    return {
      priority: pAnalysis.priority,
      category: 'Phosphorus (P)',
      issue: pAnalysis.message,
      currentValue: pAnalysis.currentValue,
      targetValue: pAnalysis.targetValue,

      product: {
        name: product.name,
        type: 'Phosphorus Fertilizer',
        npk: product.npk,
        form: product.form
      },

      application: {
        amount: productAmount,
        unit: 'kg',
        perArea: `${(productAmount / farmSize).toFixed(1)} kg/rai`,
        method: 'incorporate into soil',
        methodThai: '‡∏ú‡∏™‡∏°‡∏Ñ‡∏•‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏•‡πâ‡∏≤‡∏î‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏ô‡∏ï‡πâ‡∏ô',
        timing: '‡∏ä‡πà‡∏ß‡∏á‡∏õ‡∏•‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å',
        frequency: '‡∏ó‡∏∏‡∏Å 14-21 ‡∏ß‡∏±‡∏ô',
        waterAfter: true
      },

      estimatedCost: productAmount * product.price,
      expectedResult: `‡∏£‡∏∞‡∏î‡∏±‡∏ö P ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${pAnalysis.targetValue} ppm`,
      benefits: ['‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏Å‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á', '‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô', '‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô']
    };
  }

  recommendPotassium(kAnalysis, growthStage, farmSize) {
    const deficiency = kAnalysis.deficiency;
    const amountKg = Math.ceil((deficiency * farmSize * 0.35) / 100);

    const product = {
      name: '‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏±‡∏•‡πÄ‡∏ü‡∏ï',
      npk: '0-0-50',
      kContent: 50,
      form: 'crystal',
      price: 30
    };

    const productAmount = Math.ceil((amountKg * 100) / product.kContent);

    return {
      priority: kAnalysis.priority,
      category: 'Potassium (K)',
      issue: kAnalysis.message,
      currentValue: kAnalysis.currentValue,
      targetValue: kAnalysis.targetValue,

      product: {
        name: product.name,
        type: 'Potassium Fertilizer',
        npk: product.npk,
        form: product.form,
        note: '‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏î‡∏≠‡∏Å'
      },

      application: {
        amount: productAmount,
        unit: 'kg',
        perArea: `${(productAmount / farmSize).toFixed(1)} kg/rai`,
        method: 'fertigation or foliar spray',
        methodThai: '‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏£‡∏î‡πÇ‡∏Ñ‡∏ô‡∏ï‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡πà‡∏ô‡πÉ‡∏ö',
        timing: '‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ú‡∏•',
        frequency: '‡∏ó‡∏∏‡∏Å 7-10 ‡∏ß‡∏±‡∏ô',
        concentration: '0.5-1% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡πà‡∏ô‡πÉ‡∏ö'
      },

      estimatedCost: productAmount * product.price,
      expectedResult: `‡∏£‡∏∞‡∏î‡∏±‡∏ö K ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${kAnalysis.targetValue} ppm`,
      benefits: ['‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô', '‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡∏•‡∏á', 'cannabinoid content ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô'],
      warnings: ['‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å', '‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏™‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πã‡∏¢‡πÅ‡∏Ñ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏°']
    };
  }

  /**
   * Generate organic matter recommendation
   */
  generateOrganicMatterRecommendation(omAnalysis, farmSize) {
    if (omAnalysis.status === 'optimal') return null;

    const targetIncrease = 5 - omAnalysis.percentage; // Target 5%
    const compostAmount = Math.ceil(targetIncrease * farmSize * 200); // kg per rai

    return {
      priority: omAnalysis.status === 'very_low' ? 2 : 3,
      category: 'Organic Matter',
      issue: omAnalysis.message,
      currentValue: `${omAnalysis.percentage}%`,
      targetValue: '5%',

      product: {
        name: '‡∏Ñ‡∏≠‡∏°‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏î‡∏µ',
        type: 'Organic Amendment',
        composition: 'Composted organic matter',
        form: 'decomposed'
      },

      alternatives: ['‡∏°‡∏π‡∏•‡πÑ‡∏™‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Vermicompost)', '‡∏°‡∏π‡∏•‡πÑ‡∏Å‡πà‡∏´‡∏°‡∏±‡∏Å', '‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏´‡∏°‡∏±‡∏Å', '‡∏ä‡∏µ‡∏ß‡∏†‡∏≤‡∏û EM'],

      application: {
        amount: compostAmount,
        unit: 'kg',
        perArea: `${compostAmount / farmSize} kg/rai`,
        method: 'incorporate',
        methodThai: '‡∏ú‡∏™‡∏°‡∏Ñ‡∏•‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏•‡πâ‡∏≤‡∏î‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πà‡∏ß',
        timing: '‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏•‡∏π‡∏Å 2-4 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
        frequency: '‡∏ó‡∏∏‡∏Å 3-6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
        depth: '10-15 cm'
      },

      estimatedCost: compostAmount * 5, // 5 baht/kg
      expectedResult: `‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 5% ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 2-3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`,
      benefits: omAnalysis.benefits || [
        '‡∏î‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô 30-50%',
        '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
        '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏¥‡∏ô',
        '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏•‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå',
        '‡∏•‡∏î soil compaction'
      ]
    };
  }

  /**
   * Prioritize recommendations by urgency and impact
   */
  prioritizeRecommendations(recommendations) {
    return recommendations.sort((a, b) => {
      // Sort by priority first
      if (a.priority !== b.priority) {
        return a.priority - b.priority;
      }

      // Then by estimated impact
      return (b.estimatedCost || 0) - (a.estimatedCost || 0);
    });
  }

  /**
   * Generate application schedule
   */
  generateApplicationSchedule(recommendations, currentStage) {
    const schedule = [];
    const stages = ['germination', 'seedling', 'vegetative', 'flowering', 'ripening'];
    const currentIndex = stages.indexOf(currentStage);

    recommendations.forEach(rec => {
      if (rec.application) {
        schedule.push({
          stage: currentStage,
          week: 1,
          product: rec.product.name,
          amount: rec.application.perArea,
          method: rec.application.methodThai,
          priority: rec.priority
        });
      }
    });

    return schedule.sort((a, b) => a.priority - b.priority);
  }

  /**
   * Calculate expected improvements
   */
  calculateExpectedImprovements(soilAnalysis, recommendations) {
    const improvements = {
      soilHealth: {
        current: soilAnalysis.score,
        expected: Math.min(100, soilAnalysis.score + 20),
        improvement: '+20 points'
      },
      yieldIncrease: {
        percentage: '15-30%',
        reason: 'Optimal nutrient levels'
      },
      costSavings: {
        fertilizer: '20-30%',
        water: '15-25%',
        reason: 'Efficient resource use'
      }
    };

    return improvements;
  }
}

module.exports = FertilizerRecommendationService;
```

### Fertilizer Recommendation API

**File**: `apps/backend/modules/ai-recommendations/application/controllers/fertilizer.controller.js`

```javascript
const FertilizerRecommendationService = require('../../domain/services/FertilizerRecommendationService');
const Farm = require('../../../farm-management/infrastructure/database/Farm.model');
const { logger } = require('../../../../shared/utils/logger');
const ApiResponse = require('../../../../shared/utils/api-response');

const fertilizerService = new FertilizerRecommendationService();

/**
 * Get fertilizer recommendations for a farm
 */
exports.getRecommendations = async (req, res) => {
  try {
    const { farmId } = req.params;
    const { growthStage, budget } = req.query;

    // Get farm data
    const farm = await Farm.findById(farmId).select('farmName soilMonitoring crops area').lean();

    if (!farm) {
      return res.status(404).json(ApiResponse.error('Farm not found', 404));
    }

    // Prepare data for recommendation engine
    const farmData = {
      soilData: {
        ph: farm.soilMonitoring?.realTimeData?.ph?.current,
        npk: {
          nitrogen: farm.soilMonitoring?.realTimeData?.npk?.nitrogen?.current,
          phosphorus: farm.soilMonitoring?.realTimeData?.npk?.phosphorus?.current,
          potassium: farm.soilMonitoring?.realTimeData?.npk?.potassium?.current
        },
        organicMatter: farm.soilMonitoring?.realTimeData?.organicMatter,
        micronutrients: farm.soilMonitoring?.manualTests?.[0]?.micronutrients
      },
      cropType: farm.crops?.[0]?.cropType || 'cannabis',
      growthStage: growthStage || farm.crops?.[0]?.growthStage || 'vegetative',
      farmSize: farm.area || 1,
      budget: budget ? parseFloat(budget) : null
    };

    // Generate recommendations
    const result = await fertilizerService.generateRecommendations(farmData);

    logger.info('Fertilizer recommendations generated', {
      farmId,
      recommendationsCount: result.recommendations.length,
      totalCost: result.summary.estimatedCost,
      userId: req.user.id
    });

    res.json(ApiResponse.success(result));
  } catch (error) {
    logger.error('Failed to generate fertilizer recommendations', {
      error: error.message,
      farmId: req.params.farmId
    });
    res
      .status(500)
      .json(ApiResponse.error('Failed to generate recommendations', 500, error.message));
  }
};

/**
 * Get detailed product information
 */
exports.getProductInfo = async (req, res) => {
  try {
    const { productName } = req.params;

    const productDatabase = require('../../data/fertilizer-products');
    const product = productDatabase.findProduct(productName);

    if (!product) {
      return res.status(404).json(ApiResponse.error('Product not found', 404));
    }

    res.json(ApiResponse.success(product));
  } catch (error) {
    logger.error('Failed to get product info', { error: error.message });
    res.status(500).json(ApiResponse.error('Failed to get product info', 500, error.message));
  }
};

/**
 * Save fertilizer application record
 */
exports.recordApplication = async (req, res) => {
  try {
    const { farmId } = req.params;
    const { product, amount, method, date, cost, notes } = req.body;

    const farm = await Farm.findById(farmId);
    if (!farm) {
      return res.status(404).json(ApiResponse.error('Farm not found', 404));
    }

    // Add to improvement history
    if (!farm.soilMonitoring) {
      farm.soilMonitoring = { improvements: [] };
    }

    farm.soilMonitoring.improvements.push({
      date: new Date(date),
      type: 'fertilizer',
      product,
      amount,
      unit: 'kg',
      cost,
      appliedBy: req.user.id,
      notes,
      method
    });

    await farm.save();

    logger.info('Fertilizer application recorded', {
      farmId,
      product,
      amount,
      userId: req.user.id
    });

    res.status(201).json(
      ApiResponse.success({
        message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
        application: farm.soilMonitoring.improvements[farm.soilMonitoring.improvements.length - 1]
      })
    );
  } catch (error) {
    logger.error('Failed to record fertilizer application', {
      error: error.message,
      farmId: req.params.farmId
    });
    res.status(500).json(ApiResponse.error('Failed to record application', 500, error.message));
  }
};
```

---

## 6. Water Management & Irrigation AI

### 6.1 Overview

‡∏£‡∏∞‡∏ö‡∏ö Water Management & Irrigation AI ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡∏ä ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï

**Key Features**:

- ‚òÄÔ∏è **Evapotranspiration Calculator**: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏¢‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏à‡∏≤‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡∏ä
- üå¶Ô∏è **Weather Integration**: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏°‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
- üíß **Smart Scheduling**: ‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
- üìä **Usage Optimization**: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥
- ‚ö†Ô∏è **Stress Detection**: ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏û‡∏∑‡∏ä‡∏Ç‡∏≤‡∏î‡∏ô‡πâ‡∏≥

### 6.2 Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 Water Management & Irrigation AI             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ  ‚îÇ  Soil Moisture ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  ET Calculator   ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ    Sensors     ‚îÇ      ‚îÇ (Penman-Monteith)‚îÇ              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ           ‚îÇ                       ‚îÇ                          ‚îÇ
‚îÇ           ‚ñº                       ‚ñº                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ  ‚îÇ   Smart Irrigation Scheduling Engine    ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ  - Weather forecast integration         ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ  - Crop water requirements              ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ  - Soil type analysis                   ‚îÇ               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ           ‚îÇ                                                  ‚îÇ
‚îÇ           ‚ñº                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ  ‚îÇ     Water Usage Optimizer               ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ  - Historical usage analysis            ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ  - Cost reduction strategies            ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ  - Efficiency improvement               ‚îÇ               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ           ‚îÇ                                                  ‚îÇ
‚îÇ           ‚ñº                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ  ‚îÇ      Irrigation Control System          ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ  - Automated valve control              ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ  - IoT device integration               ‚îÇ               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 6.3 Evapotranspiration (ET) Calculator

‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏¢‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡∏ä (ET‚ÇÄ) ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏Å‡∏≤‡∏£ Penman-Monteith ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô FAO

**File**: `src/services/water/ETCalculator.js`

```javascript
/**
 * Evapotranspiration Calculator
 * ‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏Å‡∏≤‡∏£ FAO Penman-Monteith
 * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ET‚ÇÄ (Reference Evapotranspiration)
 */

class ETCalculator {
  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ET‚ÇÄ ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (mm/day)
   * @param {Object} weatherData - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
   * @returns {number} ET‚ÇÄ in mm/day
   */
  calculateDailyET0(weatherData) {
    const {
      temperature, // ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (¬∞C)
      temperatureMax, // ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (¬∞C)
      temperatureMin, // ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î (¬∞C)
      humidity, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ó‡∏ò‡πå (%)
      windSpeed, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏° (m/s)
      solarRadiation, // ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏™‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå (MJ/m¬≤/day)
      elevation, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (m)
      latitude, // ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (degrees)
      date // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    } = weatherData;

    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Saturation Vapor Pressure (es)
    const es = this.calculateSaturationVaporPressure(temperatureMax, temperatureMin);

    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Actual Vapor Pressure (ea)
    const ea = this.calculateActualVaporPressure(temperature, humidity);

    // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Slope of Vapor Pressure Curve (Œî)
    const delta = this.calculateVaporPressureCurveSlope(temperature);

    // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Psychrometric Constant (Œ≥)
    const gamma = this.calculatePsychrometricConstant(elevation);

    // 5. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Net Radiation (Rn)
    const Rn = this.calculateNetRadiation(
      solarRadiation,
      temperatureMax,
      temperatureMin,
      ea,
      latitude,
      date
    );

    // 6. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Soil Heat Flux (G) - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡πâ G = 0
    const G = 0;

    // 7. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Wind Speed at 2m height
    const u2 = windSpeed; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà 2m ‡πÅ‡∏•‡πâ‡∏ß

    // 8. ‡∏™‡∏°‡∏Å‡∏≤‡∏£ FAO Penman-Monteith
    const numerator =
      0.408 * delta * (Rn - G) + gamma * (900 / (temperature + 273)) * u2 * (es - ea);
    const denominator = delta + gamma * (1 + 0.34 * u2);

    const ET0 = numerator / denominator;

    return Math.max(0, ET0); // ET‚ÇÄ ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Saturation Vapor Pressure (kPa)
   */
  calculateSaturationVaporPressure(tMax, tMin) {
    const eoTmax = 0.6108 * Math.exp((17.27 * tMax) / (tMax + 237.3));
    const eoTmin = 0.6108 * Math.exp((17.27 * tMin) / (tMin + 237.3));
    return (eoTmax + eoTmin) / 2;
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Actual Vapor Pressure (kPa)
   */
  calculateActualVaporPressure(temp, humidity) {
    const eo = 0.6108 * Math.exp((17.27 * temp) / (temp + 237.3));
    return eo * (humidity / 100);
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Slope of Vapor Pressure Curve (kPa/¬∞C)
   */
  calculateVaporPressureCurveSlope(temp) {
    return (4098 * 0.6108 * Math.exp((17.27 * temp) / (temp + 237.3))) / Math.pow(temp + 237.3, 2);
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Psychrometric Constant (kPa/¬∞C)
   */
  calculatePsychrometricConstant(elevation) {
    const P = 101.3 * Math.pow((293 - 0.0065 * elevation) / 293, 5.26);
    return 0.000665 * P;
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Net Radiation (MJ/m¬≤/day)
   */
  calculateNetRadiation(Rs, tMax, tMin, ea, latitude, date) {
    // Net shortwave radiation
    const albedo = 0.23; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    const Rns = (1 - albedo) * Rs;

    // Net longwave radiation
    const sigma = 4.903e-9; // Stefan-Boltzmann constant (MJ/K‚Å¥/m¬≤/day)
    const Rso = this.calculateClearSkyRadiation(latitude, date);

    const Rnl =
      ((sigma * (Math.pow(tMax + 273.16, 4) + Math.pow(tMin + 273.16, 4))) / 2) *
      (0.34 - 0.14 * Math.sqrt(ea)) *
      (1.35 * (Rs / Rso) - 0.35);

    return Rns - Rnl;
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Clear Sky Radiation (MJ/m¬≤/day)
   */
  calculateClearSkyRadiation(latitude, date) {
    // ‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
    const dayOfYear = this.getDayOfYear(date);
    const Gsc = 0.082; // Solar constant (MJ/m¬≤/min)
    const dr = 1 + 0.033 * Math.cos((2 * Math.PI * dayOfYear) / 365);
    const latRad = (latitude * Math.PI) / 180;
    const declination = 0.409 * Math.sin((2 * Math.PI * dayOfYear) / 365 - 1.39);
    const ws = Math.acos(-Math.tan(latRad) * Math.tan(declination));

    const Ra =
      ((24 * 60) / Math.PI) *
      Gsc *
      dr *
      (ws * Math.sin(latRad) * Math.sin(declination) +
        Math.cos(latRad) * Math.cos(declination) * Math.sin(ws));

    return (0.75 + 2e-5 * 0) * Ra; // elevation = 0 for simplification
  }

  /**
   * ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏µ (1-365)
   */
  getDayOfYear(date) {
    const start = new Date(date.getFullYear(), 0, 0);
    const diff = date - start;
    const oneDay = 1000 * 60 * 60 * 24;
    return Math.floor(diff / oneDay);
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Crop Evapotranspiration (ETc)
   * ETc = Kc √ó ET‚ÇÄ
   * @param {number} ET0 - Reference ET
   * @param {string} cropType - ‡∏ä‡∏ô‡∏¥‡∏î‡∏û‡∏∑‡∏ä
   * @param {string} growthStage - ‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï
   * @returns {number} ETc in mm/day
   */
  calculateCropET(ET0, cropType, growthStage) {
    const Kc = this.getCropCoefficient(cropType, growthStage);
    return ET0 * Kc;
  }

  /**
   * ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ Crop Coefficient (Kc)
   */
  getCropCoefficient(cropType, growthStage) {
    const cropCoefficients = {
      cannabis: {
        germination: 0.5, // ‡πÅ‡∏£‡∏Å‡∏á‡∏≠‡∏Å
        seedling: 0.7, // ‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤
        vegetative: 1.0, // ‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï
        flowering: 1.1, // ‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å
        ripening: 0.8 // ‡∏™‡∏∏‡∏Å‡πÅ‡∏Å‡πà
      },
      rice: {
        initial: 1.05,
        development: 1.1,
        mid: 1.2,
        late: 0.95
      },
      vegetables: {
        initial: 0.7,
        development: 0.9,
        mid: 1.05,
        late: 0.95
      }
    };

    return cropCoefficients[cropType]?.[growthStage] || 1.0;
  }
}

module.exports = ETCalculator;
```

### 6.4 Weather API Integration

‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö API ‡∏Å‡∏£‡∏°‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏≠‡∏∑‡πà‡∏ô‡πÜ

**File**: `src/services/water/WeatherService.js`

```javascript
const axios = require('axios');
const NodeCache = require('node-cache');
const logger = require('../../utils/logger');

/**
 * Weather Service
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
 */
class WeatherService {
  constructor() {
    // Cache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 15 ‡∏ô‡∏≤‡∏ó‡∏µ
    this.cache = new NodeCache({ stdTTL: 900 });

    this.sources = {
      tmd: {
        name: 'Thai Meteorological Department',
        baseURL: process.env.TMD_API_URL || 'https://data.tmd.go.th/api',
        apiKey: process.env.TMD_API_KEY
      },
      openweather: {
        name: 'OpenWeatherMap',
        baseURL: 'https://api.openweathermap.org/data/2.5',
        apiKey: process.env.OPENWEATHER_API_KEY
      }
    };
  }

  /**
   * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
   * @param {number} latitude - ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î
   * @param {number} longitude - ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î
   * @returns {Object} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
   */
  async getCurrentWeather(latitude, longitude) {
    const cacheKey = `current_${latitude}_${longitude}`;
    const cached = this.cache.get(cacheKey);
    if (cached) return cached;

    try {
      // ‡∏•‡∏≠‡∏á TMD ‡∏Å‡πà‡∏≠‡∏ô
      let weatherData = await this.fetchFromTMD(latitude, longitude);

      // ‡∏ñ‡πâ‡∏≤ TMD ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏ä‡πâ OpenWeatherMap
      if (!weatherData) {
        weatherData = await this.fetchFromOpenWeather(latitude, longitude);
      }

      if (!weatherData) {
        throw new Error('Failed to fetch weather data from all sources');
      }

      // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
      const standardized = this.standardizeWeatherData(weatherData);

      this.cache.set(cacheKey, standardized);
      return standardized;
    } catch (error) {
      logger.error('Failed to get current weather', { error: error.message });
      throw error;
    }
  }

  /**
   * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏® 7 ‡∏ß‡∏±‡∏ô
   */
  async getWeatherForecast(latitude, longitude, days = 7) {
    const cacheKey = `forecast_${latitude}_${longitude}_${days}`;
    const cached = this.cache.get(cacheKey);
    if (cached) return cached;

    try {
      const response = await axios.get(`${this.sources.openweather.baseURL}/onecall`, {
        params: {
          lat: latitude,
          lon: longitude,
          exclude: 'minutely,hourly,alerts',
          units: 'metric',
          appid: this.sources.openweather.apiKey
        },
        timeout: 10000
      });

      const forecast = response.data.daily.slice(0, days).map(day => ({
        date: new Date(day.dt * 1000),
        temperature: day.temp.day,
        temperatureMax: day.temp.max,
        temperatureMin: day.temp.min,
        humidity: day.humidity,
        windSpeed: day.wind_speed,
        precipitation: day.rain || 0,
        precipitationProbability: day.pop * 100,
        cloudCover: day.clouds,
        uvIndex: day.uvi,
        description: day.weather[0].description,
        icon: day.weather[0].icon
      }));

      this.cache.set(cacheKey, forecast);
      return forecast;
    } catch (error) {
      logger.error('Failed to get weather forecast', { error: error.message });
      throw error;
    }
  }

  /**
   * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å TMD API
   */
  async fetchFromTMD(latitude, longitude) {
    if (!this.sources.tmd.apiKey) return null;

    try {
      const response = await axios.get(`${this.sources.tmd.baseURL}/Weather/current`, {
        params: {
          lat: latitude,
          lon: longitude,
          appid: this.sources.tmd.apiKey
        },
        timeout: 10000
      });

      return {
        source: 'tmd',
        data: response.data
      };
    } catch (error) {
      logger.warn('TMD API failed', { error: error.message });
      return null;
    }
  }

  /**
   * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å OpenWeatherMap API
   */
  async fetchFromOpenWeather(latitude, longitude) {
    try {
      const response = await axios.get(`${this.sources.openweather.baseURL}/weather`, {
        params: {
          lat: latitude,
          lon: longitude,
          units: 'metric',
          appid: this.sources.openweather.apiKey
        },
        timeout: 10000
      });

      return {
        source: 'openweather',
        data: response.data
      };
    } catch (error) {
      logger.error('OpenWeatherMap API failed', { error: error.message });
      return null;
    }
  }

  /**
   * ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
   */
  standardizeWeatherData(weatherData) {
    const { source, data } = weatherData;

    if (source === 'openweather') {
      return {
        source,
        timestamp: new Date(data.dt * 1000),
        location: {
          name: data.name,
          latitude: data.coord.lat,
          longitude: data.coord.lon
        },
        temperature: data.main.temp,
        temperatureFeelsLike: data.main.feels_like,
        temperatureMax: data.main.temp_max,
        temperatureMin: data.main.temp_min,
        humidity: data.main.humidity,
        pressure: data.main.pressure,
        windSpeed: data.wind.speed,
        windDirection: data.wind.deg,
        cloudCover: data.clouds.all,
        precipitation: data.rain?.['1h'] || 0,
        visibility: data.visibility / 1000, // ‡πÄ‡∏õ‡πá‡∏ô km
        description: data.weather[0].description,
        descriptionThai: this.translateWeatherDescription(data.weather[0].description),
        icon: data.weather[0].icon,
        sunrise: new Date(data.sys.sunrise * 1000),
        sunset: new Date(data.sys.sunset * 1000)
      };
    }

    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TMD API (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    return {
      source,
      ...data
    };
  }

  /**
   * ‡πÅ‡∏õ‡∏•‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
   */
  translateWeatherDescription(description) {
    const translations = {
      'clear sky': '‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡πÅ‡∏à‡πà‡∏°‡πÉ‡∏™',
      'few clouds': '‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô',
      'scattered clouds': '‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢',
      'broken clouds': '‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏°‡∏≤‡∏Å',
      'overcast clouds': '‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡∏Ñ‡∏£‡∏∂‡πâ‡∏°',
      'light rain': '‡∏ù‡∏ô‡∏ï‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢',
      'moderate rain': '‡∏ù‡∏ô‡∏ï‡∏Å‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
      'heavy rain': '‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å',
      thunderstorm: '‡∏û‡∏≤‡∏¢‡∏∏‡∏ù‡∏ô‡∏ü‡πâ‡∏≤‡∏Ñ‡∏∞‡∏ô‡∏≠‡∏á',
      mist: '‡∏°‡∏µ‡∏´‡∏°‡∏≠‡∏Å',
      fog: '‡∏´‡∏°‡∏≠‡∏Å‡∏´‡∏ô‡∏≤'
    };

    return translations[description.toLowerCase()] || description;
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Solar Radiation ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
   * ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ET ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Solar Radiation ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
   */
  estimateSolarRadiation(weatherData) {
    const { latitude, cloudCover, date = new Date() } = weatherData;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Clear Sky Radiation
    const etCalc = require('./ETCalculator');
    const calculator = new etCalc();
    const Rso = calculator.calculateClearSkyRadiation(latitude, date);

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Cloud Cover
    const cloudFactor = 1 - (cloudCover / 100) * 0.75;
    const Rs = Rso * cloudFactor;

    return Rs;
  }
}

module.exports = WeatherService;
```

### 6.5 Smart Irrigation Scheduling Service

‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏≤‡∏Å ET, ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®, ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô

**File**: `src/services/water/IrrigationScheduler.js`

```javascript
const ETCalculator = require('./ETCalculator');
const WeatherService = require('./WeatherService');
const SensorReading = require('../../models/SensorReading');
const logger = require('../../utils/logger');

/**
 * Smart Irrigation Scheduler
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 */
class IrrigationScheduler {
  constructor() {
    this.etCalculator = new ETCalculator();
    this.weatherService = new WeatherService();
  }

  /**
   * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
   * @param {Object} farmData - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≤‡∏£‡πå‡∏°
   * @returns {Object} ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
   */
  async generateSchedule(farmData) {
    const {
      farmId,
      cropType,
      growthStage,
      soilType,
      latitude,
      longitude,
      elevation = 0,
      farmSize // rai
    } = farmData;

    try {
      // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
      const currentWeather = await this.weatherService.getCurrentWeather(latitude, longitude);
      const forecast = await this.weatherService.getWeatherForecast(latitude, longitude, 7);

      // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå
      const soilMoisture = await this.getSoilMoistureData(farmId);

      // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ET‚ÇÄ ‡πÅ‡∏•‡∏∞ ETc
      const weatherData = {
        ...currentWeather,
        elevation,
        latitude,
        date: new Date()
      };

      // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì Solar Radiation ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
      if (!weatherData.solarRadiation) {
        weatherData.solarRadiation = this.weatherService.estimateSolarRadiation(weatherData);
      }

      const ET0 = this.etCalculator.calculateDailyET0(weatherData);
      const ETc = this.etCalculator.calculateCropET(ET0, cropType, growthStage);

      // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Water Balance
      const waterBalance = this.calculateWaterBalance({
        soilMoisture,
        ETc,
        precipitation: currentWeather.precipitation || 0,
        soilType,
        farmSize
      });

      // 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥ 7 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤
      const schedule = await this.createWeeklySchedule({
        ETc,
        forecast,
        soilType,
        cropType,
        growthStage,
        currentSoilMoisture: soilMoisture.current,
        waterBalance
      });

      // 6. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô
      const summary = this.calculateScheduleSummary(schedule, farmSize);

      return {
        farmId,
        generatedAt: new Date(),
        currentConditions: {
          soilMoisture: soilMoisture.current,
          weather: {
            temperature: currentWeather.temperature,
            humidity: currentWeather.humidity,
            description: currentWeather.descriptionThai
          },
          ET0,
          ETc,
          waterBalance
        },
        schedule,
        summary,
        recommendations: this.generateRecommendations(waterBalance, schedule)
      };
    } catch (error) {
      logger.error('Failed to generate irrigation schedule', { error: error.message, farmId });
      throw error;
    }
  }

  /**
   * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå
   */
  async getSoilMoistureData(farmId) {
    try {
      const readings = await SensorReading.find({
        farmId,
        sensorType: 'soil_moisture',
        timestamp: { $gte: new Date(Date.now() - 24 * 60 * 60 * 1000) }
      })
        .sort({ timestamp: -1 })
        .limit(24)
        .lean();

      if (readings.length === 0) {
        return {
          current: 50, // default
          average24h: 50,
          trend: 'stable',
          hasData: false
        };
      }

      const current = readings[0].value;
      const average24h = readings.reduce((sum, r) => sum + r.value, 0) / readings.length;
      const trend = this.calculateMoistureTrend(readings);

      return {
        current,
        average24h,
        trend,
        hasData: true,
        lastUpdated: readings[0].timestamp
      };
    } catch (error) {
      logger.warn('Failed to get soil moisture data', { error: error.message });
      return {
        current: 50,
        average24h: 50,
        trend: 'stable',
        hasData: false
      };
    }
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô
   */
  calculateMoistureTrend(readings) {
    if (readings.length < 3) return 'stable';

    const recent = readings.slice(0, 6);
    const older = readings.slice(6, 12);

    const recentAvg = recent.reduce((sum, r) => sum + r.value, 0) / recent.length;
    const olderAvg = older.reduce((sum, r) => sum + r.value, 0) / older.length;

    const diff = recentAvg - olderAvg;

    if (diff > 5) return 'increasing';
    if (diff < -5) return 'decreasing';
    return 'stable';
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏î‡∏¥‡∏ô (Water Balance)
   */
  calculateWaterBalance({ soilMoisture, ETc, precipitation, soilType, farmSize }) {
    // Available Water Capacity (AWC) ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏î‡∏¥‡∏ô
    const AWC = {
      clay: 200, // ‡∏î‡∏¥‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (mm)
      loam: 170, // ‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô (mm)
      sandy_loam: 130, // ‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ (mm)
      sand: 80 // ‡∏î‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ (mm)
    };

    const capacity = AWC[soilType] || 170; // default = loam

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏û‡∏∑‡∏ä‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ (mm)
    const availableWater = (soilMoisture.current / 100) * capacity;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    const waterLoss = ETc; // ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏¢‡∏£‡∏∞‡πÄ‡∏´‡∏¢ (mm/day)
    const waterGain = precipitation; // ‡∏ù‡∏ô (mm/day)
    const netChange = waterGain - waterLoss;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ
    const projectedMoisture = Math.max(
      0,
      Math.min(100, soilMoisture.current + (netChange / capacity) * 100)
    );

    // Management Allowed Depletion (MAD)
    const MAD = this.getMAD(soilMoisture.current);

    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    let status = 'optimal';
    let urgency = 'none';

    if (soilMoisture.current < 30) {
      status = 'critical';
      urgency = 'urgent';
    } else if (soilMoisture.current < 50) {
      status = 'low';
      urgency = 'high';
    } else if (soilMoisture.current < 65) {
      status = 'moderate';
      urgency = 'medium';
    } else if (soilMoisture.current > 85) {
      status = 'excessive';
      urgency = 'none';
    }

    return {
      currentMoisture: soilMoisture.current,
      availableWater,
      capacity,
      waterLoss,
      waterGain,
      netChange,
      projectedMoisture,
      MAD,
      status,
      urgency,
      daysUntilCritical: this.calculateDaysUntilCritical(
        soilMoisture.current,
        ETc,
        precipitation,
        capacity
      )
    };
  }

  /**
   * ‡∏´‡∏≤ Management Allowed Depletion (%)
   */
  getMAD(currentMoisture) {
    // MAD = ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏î‡∏•‡∏á‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
    if (currentMoisture > 80) return 30; // ‡πÉ‡∏´‡πâ‡∏•‡∏î‡πÑ‡∏î‡πâ 30%
    if (currentMoisture > 60) return 40;
    if (currentMoisture > 40) return 50;
    return 60;
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ß‡∏¥‡∏Å‡∏§‡∏ï
   */
  calculateDaysUntilCritical(currentMoisture, ETc, precipitation, capacity) {
    const criticalMoisture = 30; // %
    const dailyChange = ((precipitation - ETc) / capacity) * 100;

    if (dailyChange >= 0) return Infinity; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ß‡∏¥‡∏Å‡∏§‡∏ï

    const daysUntilCritical = (currentMoisture - criticalMoisture) / Math.abs(dailyChange);
    return Math.max(0, Math.ceil(daysUntilCritical));
  }

  /**
   * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥ 7 ‡∏ß‡∏±‡∏ô
   */
  async createWeeklySchedule(params) {
    const { ETc, forecast, soilType, cropType, growthStage, currentSoilMoisture, waterBalance } =
      params;

    const schedule = [];
    let simulatedMoisture = currentSoilMoisture;

    for (let day = 0; day < 7; day++) {
      const dayForecast = forecast[day];
      const date = new Date(dayForecast.date);

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ETc ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      const dailyETc = ETc; // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÑ‡∏î‡πâ

      // ‡∏ù‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ï‡∏Å
      const expectedRain = dayForecast.precipitation || 0;

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå
      const AWC = { clay: 200, loam: 170, sandy_loam: 130, sand: 80 }[soilType] || 170;
      const moistureChange = ((expectedRain - dailyETc) / AWC) * 100;
      simulatedMoisture = Math.max(0, Math.min(100, simulatedMoisture + moistureChange));

      // ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const needsIrrigation = this.shouldIrrigate({
        soilMoisture: simulatedMoisture,
        ETc: dailyETc,
        precipitation: expectedRain,
        precipitationProbability: dayForecast.precipitationProbability,
        growthStage
      });

      let irrigationAmount = 0;
      let method = 'none';
      let duration = 0;

      if (needsIrrigation) {
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ
        const targetMoisture = 75; // ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 75%
        const deficit = ((targetMoisture - simulatedMoisture) / 100) * AWC;
        irrigationAmount = Math.max(0, deficit - expectedRain);

        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
        method = this.selectIrrigationMethod(cropType, growthStage);

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏™‡∏°‡∏°‡∏ï‡∏¥ flow rate = 10 mm/hour)
        duration = Math.ceil((irrigationAmount / 10) * 60); // ‡∏ô‡∏≤‡∏ó‡∏µ

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
        simulatedMoisture = Math.min(100, simulatedMoisture + (irrigationAmount / AWC) * 100);
      }

      schedule.push({
        date: date.toISOString().split('T')[0],
        dayOfWeek: this.getDayOfWeekThai(date),
        needsIrrigation,
        irrigation: {
          amount: Math.round(irrigationAmount), // mm
          method,
          duration, // minutes
          timing: needsIrrigation ? this.getOptimalTiming(dayForecast) : null
        },
        conditions: {
          temperature: dayForecast.temperature,
          humidity: dayForecast.humidity,
          precipitation: expectedRain,
          precipitationProbability: dayForecast.precipitationProbability,
          ETc: Math.round(dailyETc * 10) / 10
        },
        soilMoisture: {
          morning: Math.round(simulatedMoisture - moistureChange),
          evening: Math.round(simulatedMoisture),
          status: this.getMoistureStatus(simulatedMoisture)
        }
      });
    }

    return schedule;
  }

  /**
   * ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
   */
  shouldIrrigate({ soilMoisture, ETc, precipitation, precipitationProbability, growthStage }) {
    // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ñ‡πâ‡∏≤‡∏ù‡∏ô‡∏à‡∏∞‡∏ï‡∏Å‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô (>80%)
    if (precipitationProbability > 80 && precipitation > ETc) {
      return false;
    }

    // ‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ threshold
    const thresholds = {
      germination: 70,
      seedling: 65,
      vegetative: 60,
      flowering: 55,
      ripening: 50
    };

    const threshold = thresholds[growthStage] || 60;

    return soilMoisture < threshold;
  }

  /**
   * ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
   */
  selectIrrigationMethod(cropType, growthStage) {
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏±‡∏ç‡∏ä‡∏≤ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ drip irrigation
    if (cropType === 'cannabis') {
      if (growthStage === 'flowering' || growthStage === 'ripening') {
        return 'drip_slow'; // ‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ä‡πâ‡∏≤‡πÜ ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å
      }
      return 'drip_regular';
    }

    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß
    if (cropType === 'rice') {
      return 'flood'; // ‡∏Ç‡∏±‡∏á‡∏ô‡πâ‡∏≥
    }

    // default
    return 'drip_regular';
  }

  /**
   * ‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
   */
  getOptimalTiming(dayForecast) {
    const { temperature, humidity } = dayForecast;

    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏£‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å ‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡πâ‡∏≤‡∏°‡∏∑‡∏î
    if (temperature > 35) {
      return {
        time: '05:00-07:00',
        reason: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏£‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å ‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡πâ‡∏≤‡∏°‡∏∑‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏¢‡∏£‡∏∞‡πÄ‡∏´‡∏¢'
      };
    }

    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡πâ‡∏≤
    if (humidity < 50) {
      return {
        time: '06:00-08:00',
        reason: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏∑‡∏ä‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ'
      };
    }

    // ‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô
    return {
      time: '06:00-08:00 ‡∏´‡∏£‡∏∑‡∏≠ 16:00-18:00',
      reason: '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î'
    };
  }

  /**
   * ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
   */
  getDayOfWeekThai(date) {
    const days = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
    return days[date.getDay()];
  }

  /**
   * ‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô
   */
  getMoistureStatus(moisture) {
    if (moisture < 30) return '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï';
    if (moisture < 50) return '‡∏ï‡πà‡∏≥';
    if (moisture < 65) return '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
    if (moisture < 80) return '‡∏î‡∏µ';
    if (moisture < 90) return '‡∏î‡∏µ‡∏°‡∏≤‡∏Å';
    return '‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ';
  }

  /**
   * ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
   */
  calculateScheduleSummary(schedule, farmSize) {
    const totalIrrigationDays = schedule.filter(day => day.needsIrrigation).length;
    const totalWaterAmount = schedule.reduce((sum, day) => sum + day.irrigation.amount, 0);

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å mm ‡πÄ‡∏õ‡πá‡∏ô ‡∏•‡∏π‡∏Å‡∏ö‡∏≤‡∏®‡∏Å‡πå‡πÄ‡∏°‡∏ï‡∏£
    // 1 mm = 1 liter/m¬≤ = 0.001 m¬≥/m¬≤
    // 1 rai = 1,600 m¬≤
    const totalWaterM3 = (totalWaterAmount / 1000) * (farmSize * 1600);

    // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ô‡πâ‡∏≥ (‡∏™‡∏°‡∏°‡∏ï‡∏¥ 5 ‡∏ö‡∏≤‡∏ó/m¬≥)
    const waterCostPerM3 = 5;
    const totalCost = totalWaterM3 * waterCostPerM3;

    // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏õ‡∏±‡πä‡∏°‡πÉ‡∏ä‡πâ 2 kW, 4 ‡∏ö‡∏≤‡∏ó/kWh)
    const totalDuration = schedule.reduce((sum, day) => sum + day.irrigation.duration, 0);
    const electricityCost = (totalDuration / 60) * 2 * 4;

    return {
      totalIrrigationDays,
      totalWaterAmount: Math.round(totalWaterAmount), // mm
      totalWaterVolume: Math.round(totalWaterM3), // m¬≥
      avgDailyWater: Math.round(totalWaterAmount / 7), // mm/day
      waterCost: Math.round(totalCost),
      electricityCost: Math.round(electricityCost),
      totalCost: Math.round(totalCost + electricityCost),
      estimatedSavings: this.calculateSavings(schedule, farmSize)
    };
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
   */
  calculateSavings(schedule, farmSize) {
    // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 20 mm
    const traditionalWater = 20 * 7;
    const smartWater = schedule.reduce((sum, day) => sum + day.irrigation.amount, 0);
    const savedMM = traditionalWater - smartWater;
    const savedPercent = (savedMM / traditionalWater) * 100;

    const savedM3 = (savedMM / 1000) * (farmSize * 1600);
    const savedCost = savedM3 * 5;

    return {
      waterSaved: Math.round(savedMM), // mm
      volumeSaved: Math.round(savedM3), // m¬≥
      percentSaved: Math.round(savedPercent), // %
      costSaved: Math.round(savedCost) // ‡∏ö‡∏≤‡∏ó
    };
  }

  /**
   * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
   */
  generateRecommendations(waterBalance, schedule) {
    const recommendations = [];

    // ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô
    if (waterBalance.status === 'critical') {
      recommendations.push({
        priority: 'urgent',
        category: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô',
        message: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ß‡∏¥‡∏Å‡∏§‡∏ï ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!',
        action: '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 15-20 mm ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô'
      });
    }

    if (waterBalance.daysUntilCritical <= 2) {
      recommendations.push({
        priority: 'high',
        category: '‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤',
        message: `‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡πÉ‡∏ô ${waterBalance.daysUntilCritical} ‡∏ß‡∏±‡∏ô`,
        action: '‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤'
      });
    }

    // ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ù‡∏ô
    const rainyDays = schedule.filter(d => d.conditions.precipitationProbability > 60).length;
    if (rainyDays >= 3) {
      recommendations.push({
        priority: 'medium',
        category: '‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏®',
        message: `‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏ù‡∏ô‡∏ï‡∏Å ${rainyDays} ‡∏ß‡∏±‡∏ô ‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ`,
        action: '‡∏≠‡∏≤‡∏à‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠'
      });
    }

    // ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥
    const totalIrrigation = schedule.filter(d => d.needsIrrigation).length;
    if (totalIrrigation > 5) {
      recommendations.push({
        priority: 'medium',
        category: '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥',
        message: '‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ö‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 5 ‡∏ß‡∏±‡∏ô)',
        action: '‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° mulch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏¢‡∏£‡∏∞‡πÄ‡∏´‡∏¢'
      });
    }

    return recommendations;
  }
}

module.exports = IrrigationScheduler;
```

### 6.6 Water Usage Optimization

‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥

**File**: `src/services/water/WaterOptimizer.js`

```javascript
const SensorReading = require('../../models/SensorReading');
const IrrigationLog = require('../../models/IrrigationLog');
const logger = require('../../utils/logger');

/**
 * Water Usage Optimizer
 * ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥
 */
class WaterOptimizer {
  /**
   * ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï
   */
  async analyzeWaterUsage(farmId, startDate, endDate) {
    try {
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
      const irrigationLogs = await IrrigationLog.find({
        farmId,
        timestamp: { $gte: startDate, $lte: endDate }
      })
        .sort({ timestamp: 1 })
        .lean();

      if (irrigationLogs.length === 0) {
        return {
          hasData: false,
          message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'
        };
      }

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
      const totalWater = irrigationLogs.reduce((sum, log) => sum + log.amount, 0);
      const avgDaily = totalWater / this.getDaysBetween(startDate, endDate);
      const totalCost = irrigationLogs.reduce((sum, log) => sum + (log.cost || 0), 0);

      // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
      const patterns = this.analyzeIrrigationPatterns(irrigationLogs);

      // ‡∏´‡∏≤‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á
      const issues = this.identifyIssues(irrigationLogs, patterns);

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
      const efficiency = await this.calculateEfficiency(farmId, irrigationLogs);

      // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
      const benchmark = this.getBenchmark(irrigationLogs[0].cropType);
      const comparison = {
        waterUsage: ((avgDaily / benchmark.avgDaily - 1) * 100).toFixed(1),
        efficiency: efficiency.score,
        status: efficiency.score >= 80 ? '‡∏î‡∏µ‡∏°‡∏≤‡∏Å' : efficiency.score >= 60 ? '‡∏î‡∏µ' : '‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á'
      };

      return {
        hasData: true,
        period: {
          start: startDate,
          end: endDate,
          days: this.getDaysBetween(startDate, endDate)
        },
        summary: {
          totalWater,
          avgDaily: Math.round(avgDaily * 10) / 10,
          totalCost: Math.round(totalCost),
          totalEvents: irrigationLogs.length
        },
        patterns,
        efficiency,
        comparison,
        issues,
        recommendations: this.generateOptimizationRecommendations(patterns, efficiency, issues)
      };
    } catch (error) {
      logger.error('Failed to analyze water usage', { error: error.message });
      throw error;
    }
  }

  /**
   * ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
   */
  analyzeIrrigationPatterns(logs) {
    // ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô
    const timeDistribution = {
      morning: 0, // 05:00-09:00
      midday: 0, // 09:00-15:00
      afternoon: 0, // 15:00-19:00
      night: 0 // 19:00-05:00
    };

    // ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
    const dayDistribution = {
      mon: 0,
      tue: 0,
      wed: 0,
      thu: 0,
      fri: 0,
      sat: 0,
      sun: 0
    };

    logs.forEach(log => {
      const hour = new Date(log.timestamp).getHours();
      const day = new Date(log.timestamp).getDay();

      // ‡πÄ‡∏ß‡∏•‡∏≤
      if (hour >= 5 && hour < 9) timeDistribution.morning++;
      else if (hour >= 9 && hour < 15) timeDistribution.midday++;
      else if (hour >= 15 && hour < 19) timeDistribution.afternoon++;
      else timeDistribution.night++;

      // ‡∏ß‡∏±‡∏ô
      const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
      dayDistribution[dayNames[day]]++;
    });

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠
    const intervals = [];
    for (let i = 1; i < logs.length; i++) {
      const diff = (logs[i].timestamp - logs[i - 1].timestamp) / (1000 * 60 * 60 * 24);
      intervals.push(diff);
    }

    const avgInterval = intervals.reduce((sum, i) => sum + i, 0) / intervals.length;
    const stdDev = Math.sqrt(
      intervals.reduce((sum, i) => sum + Math.pow(i - avgInterval, 2), 0) / intervals.length
    );

    const consistency =
      stdDev < 1
        ? '‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏°‡∏≤‡∏Å'
        : stdDev < 2
          ? '‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠'
          : stdDev < 3
            ? '‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠'
            : '‡πÑ‡∏°‡πà‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠';

    return {
      timeDistribution,
      dayDistribution,
      consistency,
      avgInterval: Math.round(avgInterval * 10) / 10,
      stdDev: Math.round(stdDev * 10) / 10
    };
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥
   */
  async calculateEfficiency(farmId, irrigationLogs) {
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
    const efficiencyScores = [];

    for (const log of irrigationLogs) {
      // ‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
      const before = await this.getSoilMoisture(farmId, log.timestamp, -30); // 30 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô
      const after = await this.getSoilMoisture(farmId, log.timestamp, 60); // 60 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á

      if (before && after) {
        const increase = after - before;
        const expected = (log.amount / 170) * 100; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ AWC = 170mm

        // ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û = ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á / ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á
        const efficiency = Math.min(100, (increase / expected) * 100);
        efficiencyScores.push(efficiency);
      }
    }

    const avgEfficiency =
      efficiencyScores.length > 0
        ? efficiencyScores.reduce((sum, s) => sum + s, 0) / efficiencyScores.length
        : 75; // default

    // ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•
    let rating,
      issues = [];

    if (avgEfficiency >= 90) {
      rating = 'excellent';
    } else if (avgEfficiency >= 75) {
      rating = 'good';
    } else if (avgEfficiency >= 60) {
      rating = 'fair';
      issues.push('‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û');
    } else {
      rating = 'poor';
      issues.push('‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏ô‡πâ‡∏≥‡∏™‡∏π‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö');
    }

    return {
      score: Math.round(avgEfficiency),
      rating,
      ratingThai: {
        excellent: '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°',
        good: '‡∏î‡∏µ',
        fair: '‡∏û‡∏≠‡πÉ‡∏ä‡πâ',
        poor: '‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á'
      }[rating],
      issues,
      dataPoints: efficiencyScores.length
    };
  }

  /**
   * ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
   */
  async getSoilMoisture(farmId, timestamp, offsetMinutes = 0) {
    const targetTime = new Date(timestamp.getTime() + offsetMinutes * 60000);
    const reading = await SensorReading.findOne({
      farmId,
      sensorType: 'soil_moisture',
      timestamp: {
        $gte: new Date(targetTime.getTime() - 15 * 60000),
        $lte: new Date(targetTime.getTime() + 15 * 60000)
      }
    })
      .sort({ timestamp: 1 })
      .lean();

    return reading?.value || null;
  }

  /**
   * ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á
   */
  identifyIssues(logs, patterns) {
    const issues = [];

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
    if (patterns.timeDistribution.midday > logs.length * 0.3) {
      issues.push({
        severity: 'high',
        category: '‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥',
        issue: '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
        impact: '‡∏ô‡πâ‡∏≥‡∏Ñ‡∏≤‡∏¢‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏™‡∏π‡∏á ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ï‡πà‡∏≥',
        recommendation: '‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô'
      });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠
    if (patterns.stdDev > 3) {
      issues.push({
        severity: 'medium',
        category: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠',
        issue: '‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠',
        impact: '‡∏û‡∏∑‡∏ä‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠',
        recommendation: '‡∏Ñ‡∏ß‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô'
      });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    const avgAmount = logs.reduce((sum, log) => sum + log.amount, 0) / logs.length;
    if (avgAmount < 5) {
      issues.push({
        severity: 'medium',
        category: '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥',
        issue: '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
        impact: '‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡∏ã‡∏∂‡∏°‡∏•‡∏∂‡∏Å ‡∏£‡∏≤‡∏Å‡∏û‡∏∑‡∏ä‡∏ï‡∏∑‡πâ‡∏ô',
        recommendation: '‡∏Ñ‡∏ß‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ï‡πà‡∏ñ‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á'
      });
    } else if (avgAmount > 30) {
      issues.push({
        severity: 'medium',
        category: '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥',
        issue: '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
        impact: '‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏Ç‡∏±‡∏á ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏£‡∏Ñ‡∏£‡∏≤‡∏Å',
        recommendation: '‡∏Ñ‡∏ß‡∏£‡πÅ‡∏ö‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
      });
    }

    return issues;
  }

  /**
   * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
   */
  generateOptimizationRecommendations(patterns, efficiency, issues) {
    const recommendations = [];

    // ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏•‡∏±‡∏Å
    if (efficiency.score < 80) {
      recommendations.push({
        priority: 1,
        category: '‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û',
        title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥',
        actions: [
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏ô‡πâ‡∏≥‡∏´‡∏¢‡∏î ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•',
          '‡πÉ‡∏ä‡πâ Mulch ‡∏Ñ‡∏•‡∏∏‡∏°‡∏î‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏¢‡∏£‡∏∞‡πÄ‡∏´‡∏¢',
          '‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
        ],
        expectedBenefit: '‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ 15-25%'
      });
    }

    // ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å issues
    issues.forEach((issue, index) => {
      recommendations.push({
        priority: issue.severity === 'high' ? 2 : 3,
        category: issue.category,
        title: issue.issue,
        actions: [issue.recommendation],
        expectedBenefit: '‡∏•‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ' + issue.impact
      });
    });

    // ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    if (patterns.timeDistribution.morning < logs.length * 0.5) {
      recommendations.push({
        priority: 2,
        category: '‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥',
        title: '‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥',
        actions: [
          '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ 06:00-08:00 ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å',
          '‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏ß‡∏•‡∏≤ 11:00-15:00',
          '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏¢‡πá‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (16:00-18:00)'
        ],
        expectedBenefit: '‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏¢‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡πÑ‡∏î‡πâ 20-30%'
      });
    }

    return recommendations.sort((a, b) => a.priority - b.priority);
  }

  /**
   * ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ benchmark ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
   */
  getBenchmark(cropType) {
    const benchmarks = {
      cannabis: {
        avgDaily: 5, // mm/day
        efficiency: 75, // %
        costPerRai: 500 // ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      },
      rice: {
        avgDaily: 8,
        efficiency: 60,
        costPerRai: 300
      },
      vegetables: {
        avgDaily: 6,
        efficiency: 70,
        costPerRai: 400
      }
    };

    return benchmarks[cropType] || benchmarks.cannabis;
  }

  /**
   * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
   */
  getDaysBetween(start, end) {
    return Math.ceil((end - start) / (1000 * 60 * 60 * 24));
  }
}

module.exports = WaterOptimizer;
```

### 6.7 Water Management API Controller

API endpoints ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥

**File**: `src/controllers/waterController.js`

```javascript
const IrrigationScheduler = require('../services/water/IrrigationScheduler');
const WaterOptimizer = require('../services/water/WaterOptimizer');
const Farm = require('../models/Farm');
const IrrigationLog = require('../models/IrrigationLog');
const ApiResponse = require('../utils/ApiResponse');
const logger = require('../utils/logger');

const irrigationScheduler = new IrrigationScheduler();
const waterOptimizer = new WaterOptimizer();

/**
 * GET /api/water/:farmId/schedule
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥ 7 ‡∏ß‡∏±‡∏ô
 */
exports.getIrrigationSchedule = async (req, res) => {
  try {
    const { farmId } = req.params;

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≤‡∏£‡πå‡∏°
    const farm = await Farm.findById(farmId).select('farmName location crops soilType area').lean();

    if (!farm) {
      return res.status(404).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≤‡∏£‡πå‡∏°', 404));
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!farm.location?.coordinates) {
      return res.status(400).json(ApiResponse.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏Å‡πà‡∏≠‡∏ô', 400));
    }

    const [longitude, latitude] = farm.location.coordinates;

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    const farmData = {
      farmId,
      cropType: farm.crops?.[0]?.cropType || 'cannabis',
      growthStage: farm.crops?.[0]?.currentStage || 'vegetative',
      soilType: farm.soilType || 'loam',
      latitude,
      longitude,
      elevation: farm.location?.elevation || 0,
      farmSize: farm.area || 1
    };

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
    const schedule = await irrigationScheduler.generateSchedule(farmData);

    res.json(ApiResponse.success(schedule, '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
  } catch (error) {
    logger.error('Failed to generate irrigation schedule', {
      error: error.message,
      farmId: req.params.farmId
    });
    res.status(500).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ', 500, error.message));
  }
};

/**
 * POST /api/water/:farmId/irrigation
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
 */
exports.logIrrigation = async (req, res) => {
  try {
    const { farmId } = req.params;
    const {
      amount, // mm
      duration, // minutes
      method, // drip_regular, drip_slow, flood, sprinkler
      notes
    } = req.body;

    // Validate
    if (!amount || amount <= 0) {
      return res.status(400).json(ApiResponse.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥', 400));
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á log
    const log = new IrrigationLog({
      farmId,
      amount,
      duration: duration || 0,
      method: method || 'manual',
      notes,
      timestamp: new Date(),
      userId: req.user.userId
    });

    await log.save();

    logger.info('Irrigation logged', { farmId, amount, method });

    res.json(ApiResponse.success(log, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
  } catch (error) {
    logger.error('Failed to log irrigation', {
      error: error.message,
      farmId: req.params.farmId
    });
    res.status(500).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ', 500, error.message));
  }
};

/**
 * GET /api/water/:farmId/history
 * ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
 */
exports.getIrrigationHistory = async (req, res) => {
  try {
    const { farmId } = req.params;
    const { startDate, endDate, limit = 30 } = req.query;

    const query = { farmId };

    if (startDate || endDate) {
      query.timestamp = {};
      if (startDate) query.timestamp.$gte = new Date(startDate);
      if (endDate) query.timestamp.$lte = new Date(endDate);
    }

    const history = await IrrigationLog.find(query)
      .sort({ timestamp: -1 })
      .limit(parseInt(limit))
      .populate('userId', 'name email')
      .lean();

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    const totalWater = history.reduce((sum, log) => sum + log.amount, 0);
    const avgDaily = history.length > 0 ? totalWater / history.length : 0;

    res.json(
      ApiResponse.success({
        history,
        statistics: {
          totalEntries: history.length,
          totalWater: Math.round(totalWater),
          avgDaily: Math.round(avgDaily * 10) / 10
        }
      })
    );
  } catch (error) {
    logger.error('Failed to get irrigation history', {
      error: error.message,
      farmId: req.params.farmId
    });
    res.status(500).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ', 500, error.message));
  }
};

/**
 * GET /api/water/:farmId/analysis
 * ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á
 */
exports.getWaterAnalysis = async (req, res) => {
  try {
    const { farmId } = req.params;
    const { days = 30 } = req.query;

    const endDate = new Date();
    const startDate = new Date(endDate.getTime() - days * 24 * 60 * 60 * 1000);

    // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥
    const analysis = await waterOptimizer.analyzeWaterUsage(farmId, startDate, endDate);

    if (!analysis.hasData) {
      return res.json(
        ApiResponse.success({
          hasData: false,
          message: analysis.message
        })
      );
    }

    res.json(ApiResponse.success(analysis, '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
  } catch (error) {
    logger.error('Failed to analyze water usage', {
      error: error.message,
      farmId: req.params.farmId
    });
    res.status(500).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ', 500, error.message));
  }
};

/**
 * GET /api/water/:farmId/stress-detection
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏û‡∏∑‡∏ä‡∏Ç‡∏≤‡∏î‡∏ô‡πâ‡∏≥
 */
exports.detectWaterStress = async (req, res) => {
  try {
    const { farmId } = req.params;

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const soilMoisture = await irrigationScheduler.getSoilMoistureData(farmId);

    if (!soilMoisture.hasData) {
      return res.json(
        ApiResponse.success({
          hasStress: false,
          message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô',
          recommendation: '‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡πâ‡∏≥'
        })
      );
    }

    // ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    let hasStress = false;
    let severity = 'none';
    let message = '';
    let recommendations = [];

    if (soilMoisture.current < 30) {
      hasStress = true;
      severity = 'critical';
      message = '‡∏û‡∏∑‡∏ä‡∏Ç‡∏≤‡∏î‡∏ô‡πâ‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!';
      recommendations = [
        '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 15-20 mm',
        '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏¢‡∏î‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà',
        '‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡∏ä',
        '‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô'
      ];
    } else if (soilMoisture.current < 45) {
      hasStress = true;
      severity = 'moderate';
      message = '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏ï‡πà‡∏≥ ‡∏û‡∏∑‡∏ä‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≤‡∏î‡∏ô‡πâ‡∏≥';
      recommendations = [
        '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥ 10-15 mm ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
        '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô',
        '‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏ä‡πâ mulch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô'
      ];
    } else if (soilMoisture.current < 55) {
      hasStress = true;
      severity = 'mild';
      message = '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥';
      recommendations = ['‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á', '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏® ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏ù‡∏ô‡∏≠‡∏≤‡∏à‡∏£‡∏≠‡πÑ‡∏î‡πâ'];
    } else {
      message = '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°';
      recommendations = ['‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á', '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥'];
    }

    // ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°
    const trend = soilMoisture.trend;
    if (trend === 'decreasing' && soilMoisture.current < 60) {
      recommendations.push('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏î‡∏•‡∏á ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô');
    }

    res.json(
      ApiResponse.success({
        hasStress,
        severity,
        message,
        currentMoisture: soilMoisture.current,
        average24h: soilMoisture.average24h,
        trend: soilMoisture.trend,
        lastUpdated: soilMoisture.lastUpdated,
        recommendations
      })
    );
  } catch (error) {
    logger.error('Failed to detect water stress', {
      error: error.message,
      farmId: req.params.farmId
    });
    res.status(500).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≤‡∏î‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ', 500, error.message));
  }
};

/**
 * POST /api/water/:farmId/auto-irrigation
 * ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 */
exports.toggleAutoIrrigation = async (req, res) => {
  try {
    const { farmId } = req.params;
    const { enabled, settings } = req.body;

    const farm = await Farm.findByIdAndUpdate(
      farmId,
      {
        'settings.autoIrrigation': {
          enabled: enabled === true,
          settings: settings || {},
          lastUpdated: new Date(),
          updatedBy: req.user.userId
        }
      },
      { new: true }
    );

    if (!farm) {
      return res.status(404).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≤‡∏£‡πå‡∏°', 404));
    }

    logger.info('Auto irrigation toggled', { farmId, enabled });

    res.json(
      ApiResponse.success(
        {
          farmId,
          autoIrrigation: farm.settings.autoIrrigation
        },
        `${enabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`
      )
    );
  } catch (error) {
    logger.error('Failed to toggle auto irrigation', {
      error: error.message,
      farmId: req.params.farmId
    });
    res.status(500).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', 500, error.message));
  }
};

module.exports = exports;
```

### 6.8 Water Management Routes

**File**: `src/routes/waterRoutes.js`

```javascript
const express = require('express');
const router = express.Router();
const waterController = require('../controllers/waterController');
const { authenticate, authorize } = require('../middleware/auth');
const { validateRequest } = require('../middleware/validation');
const { body, param, query } = require('express-validator');

// ‡∏ï‡πâ‡∏≠‡∏á authenticate ‡∏ó‡∏∏‡∏Å route
router.use(authenticate);

/**
 * GET /api/water/:farmId/schedule
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥ 7 ‡∏ß‡∏±‡∏ô
 */
router.get(
  '/:farmId/schedule',
  [param('farmId').isMongoId().withMessage('Invalid farm ID')],
  validateRequest,
  waterController.getIrrigationSchedule
);

/**
 * POST /api/water/:farmId/irrigation
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
 */
router.post(
  '/:farmId/irrigation',
  [
    param('farmId').isMongoId().withMessage('Invalid farm ID'),
    body('amount')
      .isFloat({ min: 0.1, max: 100 })
      .withMessage('‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0.1-100 mm'),
    body('duration').optional().isInt({ min: 1 }).withMessage('‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å'),
    body('method')
      .optional()
      .isIn(['drip_regular', 'drip_slow', 'flood', 'sprinkler', 'manual'])
      .withMessage('‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á')
  ],
  validateRequest,
  waterController.logIrrigation
);

/**
 * GET /api/water/:farmId/history
 * ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
 */
router.get(
  '/:farmId/history',
  [
    param('farmId').isMongoId().withMessage('Invalid farm ID'),
    query('startDate').optional().isISO8601().withMessage('Invalid start date'),
    query('endDate').optional().isISO8601().withMessage('Invalid end date'),
    query('limit').optional().isInt({ min: 1, max: 100 })
  ],
  validateRequest,
  waterController.getIrrigationHistory
);

/**
 * GET /api/water/:farmId/analysis
 * ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
 */
router.get(
  '/:farmId/analysis',
  [
    param('farmId').isMongoId().withMessage('Invalid farm ID'),
    query('days')
      .optional()
      .isInt({ min: 7, max: 90 })
      .withMessage('‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 7-90 ‡∏ß‡∏±‡∏ô')
  ],
  validateRequest,
  waterController.getWaterAnalysis
);

/**
 * GET /api/water/:farmId/stress-detection
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏û‡∏∑‡∏ä‡∏Ç‡∏≤‡∏î‡∏ô‡πâ‡∏≥
 */
router.get(
  '/:farmId/stress-detection',
  [param('farmId').isMongoId().withMessage('Invalid farm ID')],
  validateRequest,
  waterController.detectWaterStress
);

/**
 * POST /api/water/:farmId/auto-irrigation
 * ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 */
router.post(
  '/:farmId/auto-irrigation',
  [
    param('farmId').isMongoId().withMessage('Invalid farm ID'),
    body('enabled').isBoolean().withMessage('enabled ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô true/false')
  ],
  validateRequest,
  authorize(['farmer', 'admin']),
  waterController.toggleAutoIrrigation
);

module.exports = router;
```

### 6.9 Irrigation Log Model

**File**: `src/models/IrrigationLog.js`

```javascript
const mongoose = require('mongoose');

const irrigationLogSchema = new mongoose.Schema(
  {
    farmId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'Farm',
      required: true,
      index: true
    },

    amount: {
      type: Number,
      required: true,
      min: 0
      // ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥ (mm)
    },

    duration: {
      type: Number,
      default: 0
      // ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (minutes)
    },

    method: {
      type: String,
      enum: ['drip_regular', 'drip_slow', 'flood', 'sprinkler', 'manual'],
      default: 'manual'
    },

    cost: {
      type: Number,
      default: 0
      // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ö‡∏≤‡∏ó)
    },

    notes: {
      type: String,
      maxlength: 500
    },

    timestamp: {
      type: Date,
      default: Date.now,
      index: true
    },

    userId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User',
      required: true
    },

    cropType: {
      type: String
    },

    automated: {
      type: Boolean,
      default: false
      // true = ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥, false = manual
    }
  },
  {
    timestamps: true
  }
);

// Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö query
irrigationLogSchema.index({ farmId: 1, timestamp: -1 });
irrigationLogSchema.index({ timestamp: 1 }); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TTL

// TTL Index: ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏õ‡∏µ
irrigationLogSchema.index({ timestamp: 1 }, { expireAfterSeconds: 365 * 24 * 60 * 60 });

module.exports = mongoose.model('IrrigationLog', irrigationLogSchema);
```

---

## 7. AI Assistant Enhancement (Thai NLP)

### 7.1 Overview

AI Assistant ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÅ‡∏ö‡∏ö real-time

**Key Features**:

- üáπüá≠ **Thai NLP**: ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥
- üí¨ **Context-Aware**: ‡∏à‡∏î‡∏à‡∏≥‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
- üìö **Knowledge Base**: ‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°
- üéØ **Intent Recognition**: ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
- üîÑ **Multi-turn Dialog**: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á

### 7.2 Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    AI Assistant System                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ  ‚îÇ  User Query    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  Thai NLP Engine ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ  (Thai text)   ‚îÇ      ‚îÇ  - Tokenization  ‚îÇ              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ  - POS Tagging   ‚îÇ              ‚îÇ
‚îÇ                          ‚îÇ  - NER           ‚îÇ              ‚îÇ
‚îÇ                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ                                 ‚îÇ                           ‚îÇ
‚îÇ                                 ‚ñº                           ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ                    ‚îÇ  Intent Classifier   ‚îÇ                ‚îÇ
‚îÇ                    ‚îÇ  - Question          ‚îÇ                ‚îÇ
‚îÇ                    ‚îÇ  - Request advice    ‚îÇ                ‚îÇ
‚îÇ                    ‚îÇ  - Report problem    ‚îÇ                ‚îÇ
‚îÇ                    ‚îÇ  - Small talk        ‚îÇ                ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                                 ‚îÇ                           ‚îÇ
‚îÇ                                 ‚ñº                           ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ                    ‚îÇ  Context Manager     ‚îÇ                ‚îÇ
‚îÇ                    ‚îÇ  - Conversation hist ‚îÇ                ‚îÇ
‚îÇ                    ‚îÇ  - Farm context      ‚îÇ                ‚îÇ
‚îÇ                    ‚îÇ  - User preferences  ‚îÇ                ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                                 ‚îÇ                           ‚îÇ
‚îÇ                                 ‚ñº                           ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ                    ‚îÇ  Response Generator  ‚îÇ                ‚îÇ
‚îÇ                    ‚îÇ  - Query KB          ‚îÇ                ‚îÇ
‚îÇ                    ‚îÇ  - Call APIs         ‚îÇ                ‚îÇ
‚îÇ                    ‚îÇ  - Format response   ‚îÇ                ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                                 ‚îÇ                           ‚îÇ
‚îÇ                                 ‚ñº                           ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ                    ‚îÇ  Thai Response       ‚îÇ                ‚îÇ
‚îÇ                    ‚îÇ  (Natural language)  ‚îÇ                ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 7.3 Thai NLP Service

‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ tokenization, POS tagging, ‡πÅ‡∏•‡∏∞ entity extraction

**File**: `src/services/ai/ThaiNLPService.js`

```javascript
const axios = require('axios');
const logger = require('../../utils/logger');

/**
 * Thai Natural Language Processing Service
 * ‡πÉ‡∏ä‡πâ PyThaiNLP ‡∏´‡∏£‡∏∑‡∏≠ Thai2Vec API
 */
class ThaiNLPService {
  constructor() {
    this.pythainlpUrl = process.env.PYTHAINLP_API_URL || 'http://localhost:5000';

    // Common Thai stop words
    this.stopWords = new Set([
      '‡∏Ñ‡∏£‡∏±‡∏ö',
      '‡∏Ñ‡πà‡∏∞',
      '‡∏Ñ‡∏∞',
      '‡∏ô‡∏∞',
      '‡∏´‡∏£‡∏∑‡∏≠',
      '‡πÅ‡∏•‡∏∞',
      '‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤',
      '‡πÄ‡∏û‡∏£‡∏≤‡∏∞',
      '‡∏ß‡πà‡∏≤',
      '‡∏ó‡∏µ‡πà',
      '‡∏ã‡∏∂‡πà‡∏á',
      '‡∏≠‡∏±‡∏ô',
      '‡∏Å‡∏±‡∏ö',
      '‡πÉ‡∏ô',
      '‡∏Ç‡∏≠‡∏á',
      '‡πÅ‡∏•‡πâ‡∏ß',
      '‡πÑ‡∏î‡πâ',
      '‡πÄ‡∏õ‡πá‡∏ô',
      '‡∏°‡∏µ',
      '‡∏à‡∏∞',
      '‡πÑ‡∏õ',
      '‡∏°‡∏≤',
      '‡πÉ‡∏´‡πâ'
    ]);

    // Intent keywords
    this.intentKeywords = {
      question: ['‡∏≠‡∏∞‡πÑ‡∏£', '‡∏ó‡∏≥‡πÑ‡∏°', '‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£', '‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà', '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏£', '‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô', '‡πÉ‡∏Ñ‡∏£‡∏Ñ‡∏£‡∏±‡∏ö', '‡∏ä‡πà‡∏ß‡∏¢'],
      advice: ['‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', '‡∏Ñ‡∏ß‡∏£', '‡∏î‡∏µ‡πÑ‡∏´‡∏°', '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°', '‡∏ß‡∏¥‡∏ò‡∏µ', '‡∏ä‡πà‡∏ß‡∏¢', '‡∏™‡∏≠‡∏ô'],
      problem: ['‡∏õ‡∏±‡∏ç‡∏´‡∏≤', '‡πÄ‡∏™‡∏µ‡∏¢', '‡∏ï‡∏≤‡∏¢', '‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß', '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', '‡∏î‡πà‡∏≤‡∏á', '‡πÅ‡∏°‡∏•‡∏á', '‡πÇ‡∏£‡∏Ñ', '‡∏ä‡πà‡∏ß‡∏¢'],
      status: ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á', '‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£', '‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ', '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'],
      schedule: ['‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏£', '‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á', '‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô', '‡∏ï‡∏≤‡∏£‡∏≤‡∏á', '‡πÄ‡∏ß‡∏•‡∏≤']
    };
  }

  /**
   * Tokenize Thai text
   */
  async tokenize(text) {
    try {
      // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ PyThaiNLP API ‡∏Å‡πà‡∏≠‡∏ô
      const response = await axios.post(
        `${this.pythainlpUrl}/tokenize`,
        { text },
        { timeout: 5000 }
      );
      return response.data.tokens;
    } catch (error) {
      // Fallback: Simple Thai tokenization
      return this.simpleTokenize(text);
    }
  }

  /**
   * Simple Thai tokenization (fallback)
   */
  simpleTokenize(text) {
    // ‡πÉ‡∏ä‡πâ regex ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡πÑ‡∏ó‡∏¢ (‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢)
    const words = [];

    // ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢
    const segments = text.split(/\s+/);

    segments.forEach(segment => {
      // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß > 1 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
      if (segment.length > 1 && !this.stopWords.has(segment)) {
        words.push(segment);
      }
    });

    return words;
  }

  /**
   * Extract entities (Named Entity Recognition)
   */
  extractEntities(text) {
    const entities = {
      crops: [],
      problems: [],
      nutrients: [],
      numbers: [],
      locations: []
    };

    const lowerText = text.toLowerCase();

    // Crop entities - Focus on Thai medicinal plants
    const crops = [
      '‡∏Å‡∏±‡∏ç‡∏ä‡∏≤',
      'cannabis',
      '‡∏Ç‡∏°‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏ô',
      '‡∏Ç‡∏°‡∏¥‡πâ‡∏ô',
      'turmeric',
      '‡∏Ç‡∏¥‡∏á',
      'ginger',
      '‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏î‡∏≥',
      '‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢',
      'black galingale',
      '‡πÑ‡∏û‡∏•',
      'plai',
      '‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°',
      'kratom'
    ];
    crops.forEach(crop => {
      if (lowerText.includes(crop)) {
        entities.crops.push(crop);
      }
    });

    // Problem entities
    const problems = [
      '‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß',
      '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á',
      '‡∏î‡πà‡∏≤‡∏á',
      '‡∏ï‡∏≤‡∏¢',
      '‡πÄ‡∏ô‡πà‡∏≤',
      '‡πÇ‡∏£‡∏Ñ',
      '‡πÅ‡∏°‡∏•‡∏á',
      '‡∏´‡∏ô‡∏≠‡∏ô',
      '‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢',
      '‡πÑ‡∏£‡πÅ‡∏î‡∏á',
      '‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤'
    ];
    problems.forEach(problem => {
      if (lowerText.includes(problem)) {
        entities.problems.push(problem);
      }
    });

    // Nutrient entities
    const nutrients = ['‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô', '‡∏ü‡∏≠‡∏™‡∏ü‡∏≠‡∏£‡∏±‡∏™', '‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏°', '‡∏õ‡∏∏‡πã‡∏¢', '‡∏ô‡πâ‡∏≥'];
    nutrients.forEach(nutrient => {
      if (lowerText.includes(nutrient)) {
        entities.nutrients.push(nutrient);
      }
    });

    // Extract numbers
    const numberPattern = /\d+(?:\.\d+)?/g;
    const numbers = text.match(numberPattern);
    if (numbers) {
      entities.numbers = numbers.map(n => parseFloat(n));
    }

    return entities;
  }

  /**
   * Classify intent
   */
  classifyIntent(text, tokens) {
    const lowerText = text.toLowerCase();
    const scores = {
      question: 0,
      advice: 0,
      problem: 0,
      status: 0,
      schedule: 0,
      greeting: 0,
      unknown: 0
    };

    // Check for greeting
    const greetings = ['‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ', '‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ', '‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö', '‡∏î‡∏µ‡∏Ñ‡πà‡∏∞', 'hello', 'hi'];
    if (greetings.some(g => lowerText.includes(g))) {
      scores.greeting = 10;
    }

    // Check for question markers
    if (
      lowerText.includes('?') ||
      lowerText.includes('‡πÑ‡∏´‡∏°') ||
      lowerText.includes('‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤') ||
      lowerText.includes('‡∏£‡∏∂‡πÄ‡∏õ‡∏•‡πà‡∏≤')
    ) {
      scores.question += 5;
    }

    // Score by keywords
    Object.entries(this.intentKeywords).forEach(([intent, keywords]) => {
      keywords.forEach(keyword => {
        if (lowerText.includes(keyword)) {
          scores[intent] += 3;
        }
      });
    });

    // Find highest score
    const intents = Object.entries(scores).sort((a, b) => b[1] - a[1]);

    const topIntent = intents[0];

    return {
      intent: topIntent[1] > 0 ? topIntent[0] : 'unknown',
      confidence: Math.min(topIntent[1] / 10, 1.0),
      allScores: scores
    };
  }

  /**
   * Analyze sentiment (simple)
   */
  analyzeSentiment(text) {
    const positiveWords = ['‡∏î‡∏µ', '‡∏™‡∏ß‡∏¢', '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°', '‡πÄ‡∏à‡∏£‡∏¥‡∏ç', '‡∏™‡∏î', '‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á', '‡∏ä‡∏≠‡∏ö', '‡∏£‡∏±‡∏Å'];
    const negativeWords = ['‡πÅ‡∏¢‡πà', '‡πÄ‡∏™‡∏µ‡∏¢', '‡∏ï‡∏≤‡∏¢', '‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß', '‡πÇ‡∏£‡∏Ñ', '‡∏õ‡∏±‡∏ç‡∏´‡∏≤', '‡∏ä‡πà‡∏ß‡∏¢', '‡∏Å‡∏±‡∏á‡∏ß‡∏•'];

    let score = 0;
    const lowerText = text.toLowerCase();

    positiveWords.forEach(word => {
      if (lowerText.includes(word)) score += 1;
    });

    negativeWords.forEach(word => {
      if (lowerText.includes(word)) score -= 1;
    });

    if (score > 0) return 'positive';
    if (score < 0) return 'negative';
    return 'neutral';
  }

  /**
   * Process user query
   */
  async processQuery(text) {
    const tokens = await this.tokenize(text);
    const entities = this.extractEntities(text);
    const { intent, confidence } = this.classifyIntent(text, tokens);
    const sentiment = this.analyzeSentiment(text);

    return {
      originalText: text,
      tokens,
      entities,
      intent,
      confidence,
      sentiment,
      timestamp: new Date()
    };
  }
}

module.exports = ThaiNLPService;
```

### 7.4 Context-Aware Conversation Manager

‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó

**File**: `src/services/ai/ConversationManager.js`

```javascript
const logger = require('../../utils/logger');
const Conversation = require('../../models/Conversation');

/**
 * Context-Aware Conversation Manager
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
 */
class ConversationManager {
  constructor() {
    // ‡πÄ‡∏Å‡πá‡∏ö context ‡πÉ‡∏ô memory (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö active conversations)
    this.activeContexts = new Map();

    // Context timeout: 30 minutes
    this.contextTimeout = 30 * 60 * 1000;
  }

  /**
   * Get or create conversation context
   */
  async getContext(userId, farmId = null) {
    const contextKey = `${userId}_${farmId || 'default'}`;

    // Check memory cache
    if (this.activeContexts.has(contextKey)) {
      const context = this.activeContexts.get(contextKey);

      // Check if expired
      if (Date.now() - context.lastActivity < this.contextTimeout) {
        return context;
      } else {
        // Expired, remove
        this.activeContexts.delete(contextKey);
      }
    }

    // Load from database
    let conversation = await Conversation.findOne({
      userId,
      farmId: farmId || null,
      active: true
    })
      .sort({ lastActivity: -1 })
      .lean();

    // Create new if not found
    if (!conversation) {
      conversation = await Conversation.create({
        userId,
        farmId,
        messages: [],
        context: {},
        active: true,
        lastActivity: new Date()
      });
    }

    // Build context
    const context = {
      conversationId: conversation._id,
      userId,
      farmId,
      messages: conversation.messages || [],
      context: conversation.context || {},
      lastActivity: Date.now()
    };

    // Store in memory
    this.activeContexts.set(contextKey, context);

    return context;
  }

  /**
   * Add message to conversation
   */
  async addMessage(context, role, content, metadata = {}) {
    const message = {
      role, // 'user' or 'assistant'
      content,
      metadata,
      timestamp: new Date()
    };

    // Add to context
    context.messages.push(message);
    context.lastActivity = Date.now();

    // Keep only last 20 messages
    if (context.messages.length > 20) {
      context.messages = context.messages.slice(-20);
    }

    // Save to database
    await Conversation.findByIdAndUpdate(context.conversationId, {
      $push: {
        messages: {
          $each: [message],
          $slice: -20
        }
      },
      lastActivity: new Date(),
      $inc: { messageCount: 1 }
    });

    return message;
  }

  /**
   * Update context metadata
   */
  async updateContext(context, updates) {
    context.context = {
      ...context.context,
      ...updates
    };

    await Conversation.findByIdAndUpdate(context.conversationId, { context: context.context });
  }

  /**
   * Get conversation history
   */
  getHistory(context, limit = 10) {
    return context.messages.slice(-limit);
  }

  /**
   * Extract context from history
   */
  extractContextFromHistory(context) {
    const history = this.getHistory(context, 5);

    const extracted = {
      topics: new Set(),
      entities: {
        crops: new Set(),
        problems: new Set(),
        nutrients: new Set()
      },
      lastIntent: null,
      hasUnresolvedIssue: false
    };

    history.forEach(msg => {
      if (msg.metadata?.intent) {
        extracted.lastIntent = msg.metadata.intent;
      }

      if (msg.metadata?.entities) {
        const entities = msg.metadata.entities;

        if (entities.crops) {
          entities.crops.forEach(c => extracted.entities.crops.add(c));
        }
        if (entities.problems) {
          entities.problems.forEach(p => extracted.entities.problems.add(p));
          extracted.hasUnresolvedIssue = true;
        }
        if (entities.nutrients) {
          entities.nutrients.forEach(n => extracted.entities.nutrients.add(n));
        }
      }
    });

    return {
      topics: Array.from(extracted.topics),
      entities: {
        crops: Array.from(extracted.entities.crops),
        problems: Array.from(extracted.entities.problems),
        nutrients: Array.from(extracted.entities.nutrients)
      },
      lastIntent: extracted.lastIntent,
      hasUnresolvedIssue: extracted.hasUnresolvedIssue
    };
  }

  /**
   * End conversation
   */
  async endConversation(context) {
    const contextKey = `${context.userId}_${context.farmId || 'default'}`;

    // Remove from memory
    this.activeContexts.delete(contextKey);

    // Mark as inactive in DB
    await Conversation.findByIdAndUpdate(context.conversationId, { active: false });

    logger.info('Conversation ended', {
      conversationId: context.conversationId,
      messageCount: context.messages.length
    });
  }

  /**
   * Clean up expired contexts
   */
  cleanupExpiredContexts() {
    const now = Date.now();

    for (const [key, context] of this.activeContexts.entries()) {
      if (now - context.lastActivity > this.contextTimeout) {
        this.activeContexts.delete(key);
        logger.info('Context expired and removed', { key });
      }
    }
  }
}

// Run cleanup every 10 minutes
const manager = new ConversationManager();
setInterval(
  () => {
    manager.cleanupExpiredContexts();
  },
  10 * 60 * 1000
);

module.exports = ConversationManager;
```

### 7.5 Agricultural Knowledge Base

‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°

**File**: `src/services/ai/KnowledgeBase.js`

```javascript
/**
 * Agricultural Knowledge Base
 * ‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÑ‡∏ó‡∏¢
 */
class KnowledgeBase {
  constructor() {
    this.knowledge = {
      crops: this.getCropKnowledge(),
      problems: this.getProblemKnowledge(),
      nutrients: this.getNutrientKnowledge(),
      techniques: this.getTechniqueKnowledge(),
      general: this.getGeneralKnowledge()
    };
  }

  /**
   * ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡∏ä (Thai Medicinal Plants Focus)
   */
  getCropKnowledge() {
    return {
      // üéØ PRIMARY CROP - GACP Compliant Cannabis Production
      ‡∏Å‡∏±‡∏ç‡∏ä‡∏≤: {
        name: '‡∏Å‡∏±‡∏ç‡∏ä‡∏≤',
        scientificName: 'Cannabis sativa L.',
        thaiName: '‡∏Å‡∏±‡∏ç‡∏ä‡∏≤',
        isPrimaryCrop: true,
        gacpCompliant: true,
        legalFramework: '‡∏Å‡∏£‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
        stages: ['‡∏á‡∏≠‡∏Å', '‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤', '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï', '‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å', '‡∏™‡∏∏‡∏Å‡πÅ‡∏Å‡πà'],
        optimalPH: { min: 6.0, max: 7.0 },
        optimalTemp: { min: 20, max: 30 },
        waterNeeds: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á-‡∏™‡∏π‡∏á',
        commonProblems: ['‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß', '‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', '‡∏Ç‡∏≤‡∏î‡∏ò‡∏≤‡∏ï‡∏∏', '‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤'],
        harvestTime: '8-12 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå)',
        gacpRequirements: [
          '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô (Daily logs)',
          '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ (Input records)',
          '‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î (Testing schedule)',
          '‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß (Harvest documentation)',
          '‚úÖ ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approved products only)'
        ],
        tips: [
          '‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° pH ‡∏î‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 6.0-7.0 (GACP Required)',
          '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô',
          '‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏ü‡∏≠‡∏™‡∏ü‡∏≠‡∏£‡∏±‡∏™‡πÅ‡∏•‡∏∞‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏™‡∏π‡∏á',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠',
          'üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠ GACP certification',
          'üî¨ ‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à cannabinoids ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß',
          '‚öñÔ∏è ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏° SOP ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢'
        ]
      },

      // üí∞ SECONDARY ECONOMIC CROPS (Optional - Basic Support)
      ‡∏Ç‡∏°‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏ô: {
        name: '‡∏Ç‡∏°‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏ô',
        scientificName: 'Curcuma longa L.',
        thaiName: '‡∏Ç‡∏°‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏ô',
        stages: ['‡∏õ‡∏•‡∏π‡∏Å', '‡∏á‡∏≠‡∏Å', '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï', '‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏´‡∏á‡πâ‡∏≤', '‡∏™‡∏∏‡∏Å‡πÅ‡∏Å‡πà'],
        optimalPH: { min: 5.5, max: 7.5 },
        optimalTemp: { min: 25, max: 35 },
        waterNeeds: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
        commonProblems: ['‡πÄ‡∏´‡∏á‡πâ‡∏≤‡πÄ‡∏ô‡πà‡∏≤', '‡πÉ‡∏ö‡∏î‡πà‡∏≤‡∏á', '‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡∏à‡∏∏‡∏î'],
        harvestTime: '8-10 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏π‡∏Å',
        tips: [
          '‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏ã‡∏∏‡∏¢ ‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏î‡∏µ',
          '‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏á‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡∏ô‡∏≤‡∏î 20-30 ‡∏Å‡∏£‡∏±‡∏°',
          '‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å 2-3 ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏•‡∏π‡∏Å',
          '‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≥‡∏Ç‡∏±‡∏á',
          '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÅ‡∏´‡πâ‡∏á'
        ]
      },
      ‡∏Ç‡∏¥‡∏á: {
        name: '‡∏Ç‡∏¥‡∏á',
        scientificName: 'Zingiber officinale Roscoe',
        thaiName: '‡∏Ç‡∏¥‡∏á',
        stages: ['‡∏õ‡∏•‡∏π‡∏Å', '‡∏á‡∏≠‡∏Å', '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï', '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏á‡πâ‡∏≤', '‡∏™‡∏∏‡∏Å‡πÅ‡∏Å‡πà'],
        optimalPH: { min: 5.5, max: 6.5 },
        optimalTemp: { min: 25, max: 35 },
        waterNeeds: '‡∏™‡∏π‡∏á',
        commonProblems: ['‡πÄ‡∏´‡∏á‡πâ‡∏≤‡πÄ‡∏ô‡πà‡∏≤', '‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢', '‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡∏à‡∏∏‡∏î', '‡∏´‡∏ô‡∏≠‡∏ô'],
        harvestTime: '10-12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ç‡∏¥‡∏á‡πÅ‡∏Å‡πà), 4-6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ç‡∏¥‡∏á‡∏≠‡πà‡∏≠‡∏ô)',
        tips: [
          '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏î‡∏µ ‡πÄ‡∏´‡∏á‡πâ‡∏≤‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á ‡πÑ‡∏°‡πà‡πÄ‡∏ô‡πà‡∏≤',
          '‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏™‡∏π‡∏á',
          '‡∏£‡∏∞‡∏¢‡∏∞‡∏õ‡∏•‡∏π‡∏Å 30x30 cm ‡∏´‡∏£‡∏∑‡∏≠ 40x40 cm',
          '‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á‡∏à‡∏±‡∏î',
          '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡∏¥‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏π‡∏Å 4-5 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'
        ]
      },
      ‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏î‡∏≥: {
        name: '‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏î‡∏≥',
        scientificName: 'Kaempferia parviflora Wall. ex Baker',
        thaiName: '‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏î‡∏≥',
        stages: ['‡∏õ‡∏•‡∏π‡∏Å', '‡∏á‡∏≠‡∏Å', '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï', '‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏´‡∏á‡πâ‡∏≤', '‡∏û‡∏±‡∏Å‡∏ï‡∏±‡∏ß'],
        optimalPH: { min: 5.0, max: 6.5 },
        optimalTemp: { min: 25, max: 32 },
        waterNeeds: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
        commonProblems: ['‡πÄ‡∏´‡∏á‡πâ‡∏≤‡πÄ‡∏ô‡πà‡∏≤', '‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤', '‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢'],
        harvestTime: '12-15 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏π‡∏Å',
        tips: [
          '‡∏ä‡∏≠‡∏ö‡∏£‡πà‡∏°‡πÄ‡∏á‡∏≤ ‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ï‡πâ‡∏£‡πà‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ',
          '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠',
          '‡∏î‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏™‡∏π‡∏á',
          '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡∏¢‡∏Å‡πÅ‡∏õ‡∏•‡∏á',
          '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô'
        ]
      },
      ‡πÑ‡∏û‡∏•: {
        name: '‡πÑ‡∏û‡∏•',
        scientificName: 'Zingiber cassumunar Roxb.',
        thaiName: '‡πÑ‡∏û‡∏•',
        stages: ['‡∏õ‡∏•‡∏π‡∏Å', '‡∏á‡∏≠‡∏Å', '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï', '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏á‡πâ‡∏≤', '‡∏™‡∏∏‡∏Å‡πÅ‡∏Å‡πà'],
        optimalPH: { min: 5.5, max: 7.0 },
        optimalTemp: { min: 25, max: 33 },
        waterNeeds: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
        commonProblems: ['‡πÄ‡∏´‡∏á‡πâ‡∏≤‡πÄ‡∏ô‡πà‡∏≤', '‡πÉ‡∏ö‡∏î‡πà‡∏≤‡∏á', '‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢'],
        harvestTime: '8-10 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏π‡∏Å',
        tips: [
          '‡∏ó‡∏ô‡∏£‡πà‡∏°‡πÄ‡∏á‡∏≤‡πÑ‡∏î‡πâ‡∏î‡∏µ ‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ï‡πâ‡πÑ‡∏°‡πâ‡∏ú‡∏•‡πÑ‡∏î‡πâ',
          '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô ‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏',
          '‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏´‡πâ‡∏á‡∏à‡∏±‡∏î',
          '‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏á‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å 30-40 ‡∏Å‡∏£‡∏±‡∏°',
          '‡∏ô‡∏¥‡∏¢‡∏°‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£'
        ]
      },
      ‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°: {
        name: '‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°',
        scientificName: 'Mitragyna speciosa Korth.',
        thaiName: '‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°',
        stages: ['‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤', '‡∏ï‡πâ‡∏ô‡∏≠‡πà‡∏≠‡∏ô', '‡∏ï‡πâ‡∏ô‡πÇ‡∏ï', '‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï'],
        optimalPH: { min: 5.5, max: 6.8 },
        optimalTemp: { min: 25, max: 32 },
        waterNeeds: '‡∏™‡∏π‡∏á',
        commonProblems: ['‡πÇ‡∏£‡∏Ñ‡∏£‡∏≤‡∏Å', '‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢', '‡∏°‡∏≠‡∏î', '‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡∏î‡πà‡∏≤‡∏á'],
        harvestTime: '‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ö‡∏ó‡∏∏‡∏Å 3-4 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡πâ‡∏ô‡πÇ‡∏ï (3+ ‡∏õ‡∏µ)',
        tips: [
          '‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏°‡πâ‡∏¢‡∏∑‡∏ô‡∏ï‡πâ‡∏ô ‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏ä‡πâ‡∏≤',
          '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏π‡∏á ‡∏£‡πà‡∏°‡πÄ‡∏á‡∏≤‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô',
          '‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏ú‡∏™‡∏≤‡∏ô',
          '‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ö 3-4 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏ï‡πâ‡∏ô‡πÇ‡∏ï',
          '‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°',
          '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï'
        ]
      }
    };
  }

  /**
   * ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ
   */
  getProblemKnowledge() {
    return {
      ‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á: {
        problem: '‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á',
        causes: ['‡∏Ç‡∏≤‡∏î‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô', '‡∏Ç‡∏≤‡∏î‡∏ô‡πâ‡∏≥', 'pH ‡∏î‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°', '‡πÇ‡∏£‡∏Ñ‡∏£‡∏≤‡∏Å', '‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤'],
        solutions: [
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô',
          '‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏¢‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡∏´‡∏£‡∏∑‡∏≠ blood meal',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö pH ‡∏î‡∏¥‡∏ô ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏£‡∏Ñ'
        ],
        urgency: 'medium'
      },
      ‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß: {
        problem: '‡∏ï‡πâ‡∏ô‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß',
        causes: ['‡∏Ç‡∏≤‡∏î‡∏ô‡πâ‡∏≥', '‡∏£‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', '‡πÇ‡∏£‡∏Ñ‡∏£‡∏≤‡∏Å', '‡πÅ‡∏°‡∏•‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π'],
        solutions: [
          '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ñ‡πâ‡∏≤‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á)',
          '‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏£‡πà‡∏°‡πÄ‡∏á‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏£‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡πÅ‡∏°‡∏•‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π',
          '‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢ (‡∏ñ‡πâ‡∏≤‡πÉ‡∏™‡πà‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)'
        ],
        urgency: 'high'
      },
      ‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤: {
        problem: '‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤',
        causes: ['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÑ‡∏´‡∏•‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏î‡∏µ', '‡∏ô‡πâ‡∏≥‡∏Ñ‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÉ‡∏ö'],
        solutions: [
          '‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®',
          '‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡∏™‡∏≤‡∏£‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå',
          '‡∏ï‡∏±‡∏î‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ó‡∏¥‡πâ‡∏á',
          '‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÇ‡∏î‡∏ô‡πÉ‡∏ö',
          '‡πÉ‡∏ä‡πâ neem oil ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á'
        ],
        urgency: 'high'
      }
    };
  }

  /**
   * ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£
   */
  getNutrientKnowledge() {
    return {
      ‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô: {
        symbol: 'N',
        functions: '‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏≥‡∏ï‡πâ‡∏ô ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏•‡∏≠‡πÇ‡∏£‡∏ü‡∏¥‡∏•‡∏•‡πå',
        deficiencySymptoms: '‡πÉ‡∏ö‡πÅ‡∏Å‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏ä‡πâ‡∏≤',
        sources: ['‡∏¢‡∏π‡πÄ‡∏£‡∏µ‡∏¢', 'Blood Meal', '‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å'],
        applicationTiming: '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï (vegetative stage)'
      },
      ‡∏ü‡∏≠‡∏™‡∏ü‡∏≠‡∏£‡∏±‡∏™: {
        symbol: 'P',
        functions: '‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å ‡∏≠‡∏≠‡∏Å‡∏ú‡∏• ‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏≤‡∏Å',
        deficiencySymptoms: '‡πÉ‡∏ö‡∏°‡∏µ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å‡∏ä‡πâ‡∏≤ ‡∏£‡∏≤‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÑ‡∏°‡πà‡∏î‡∏µ',
        sources: ['‡πÇ‡∏ö‡∏ô‡∏°‡∏µ‡∏•', '‡∏õ‡∏∏‡πã‡∏¢‡∏™‡∏π‡∏ï‡∏£ 15-15-15'],
        applicationTiming: '‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å (flowering stage)'
      },
      ‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏°: {
        symbol: 'K',
        functions: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á ‡∏ó‡∏ô‡πÇ‡∏£‡∏Ñ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï',
        deficiencySymptoms: '‡∏Ç‡∏≠‡∏ö‡πÉ‡∏ö‡πÑ‡∏´‡∏°‡πâ ‡πÉ‡∏ö‡∏°‡πâ‡∏ß‡∏ô ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ï‡πà‡∏≥',
        sources: ['‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏ã‡∏±‡∏•‡πÄ‡∏ü‡∏ï', '‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏´‡∏¥‡∏ô'],
        applicationTiming: '‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡∏Å‡πÅ‡∏Å‡πà'
      }
    };
  }

  /**
   * ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£
   */
  getTechniqueKnowledge() {
    return {
      ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥: {
        technique: 'Smart Irrigation',
        description: '‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û',
        bestPractices: [
          '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ 06:00-08:00 ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô 16:00-18:00',
          '‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô (‡∏Ñ‡∏≤‡∏¢‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏™‡∏π‡∏á)',
          '‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏¢‡∏î ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á 50%',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥',
          '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏•‡∏∂‡∏Å‡πÅ‡∏ï‡πà‡∏ñ‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏∑‡πâ‡∏ô‡πÅ‡∏ï‡πà‡∏ö‡πà‡∏≠‡∏¢'
        ]
      },
      ‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢: {
        technique: 'Fertilization',
        description: '‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        bestPractices: [
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
          '‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ä‡πâ‡∏≤‡πÜ ‡πÅ‡∏ö‡∏ö‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ',
          '‡∏ú‡∏™‡∏°‡∏õ‡∏∏‡πã‡∏¢‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏∑‡∏ä (fertigation)',
          '‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï',
          '‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (overfertilization)'
        ]
      }
    };
  }

  /**
   * ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
   */
  getGeneralKnowledge() {
    return {
      greetings: [
        '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì',
        '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö',
        '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞'
      ],
      farewells: [
        '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏£‡∏≤‡∏ö‡∏£‡∏∑‡πà‡∏ô',
        '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö',
        '‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö'
      ],
      encouragement: [
        '‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö',
        '‡∏Ç‡∏≠‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö',
        '‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏î‡∏ó‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö'
      ]
    };
  }

  /**
   * Query knowledge base
   */
  query(category, key) {
    if (!this.knowledge[category]) {
      return null;
    }

    // Exact match
    if (this.knowledge[category][key]) {
      return this.knowledge[category][key];
    }

    // Fuzzy match (simple)
    const lowerKey = key.toLowerCase();
    for (const [k, v] of Object.entries(this.knowledge[category])) {
      if (k.toLowerCase().includes(lowerKey) || lowerKey.includes(k.toLowerCase())) {
        return v;
      }
    }

    return null;
  }

  /**
   * Search across all categories
   */
  search(query) {
    const results = [];
    const lowerQuery = query.toLowerCase();

    Object.entries(this.knowledge).forEach(([category, items]) => {
      if (typeof items === 'object') {
        Object.entries(items).forEach(([key, value]) => {
          // Check if query matches key or content
          const keyMatch = key.toLowerCase().includes(lowerQuery);
          const contentMatch = JSON.stringify(value).toLowerCase().includes(lowerQuery);

          if (keyMatch || contentMatch) {
            results.push({
              category,
              key,
              data: value,
              relevance: keyMatch ? 1.0 : 0.5
            });
          }
        });
      }
    });

    return results.sort((a, b) => b.relevance - a.relevance);
  }
}

module.exports = KnowledgeBase;
```

### 7.6 AI Response Generator

‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ

**File**: `src/services/ai/ResponseGenerator.js`

```javascript
const ThaiNLPService = require('./ThaiNLPService');
const KnowledgeBase = require('./KnowledgeBase');
const Farm = require('../../models/Farm');
const FertilizerService = require('../fertilizer/FertilizerService');
const IrrigationScheduler = require('../water/IrrigationScheduler');

/**
 * AI Response Generator
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞
 */
class ResponseGenerator {
  constructor() {
    this.nlp = new ThaiNLPService();
    this.kb = new KnowledgeBase();
  }

  /**
   * Generate response based on intent
   */
  async generateResponse(nlpResult, context, farmData = null) {
    const { intent, entities, sentiment } = nlpResult;

    switch (intent) {
      case 'greeting':
        return this.handleGreeting(context);

      case 'question':
        return await this.handleQuestion(nlpResult, context, farmData);

      case 'advice':
        return await this.handleAdviceRequest(nlpResult, context, farmData);

      case 'problem':
        return await this.handleProblemReport(nlpResult, context, farmData);

      case 'status':
        return await this.handleStatusQuery(context, farmData);

      case 'schedule':
        return await this.handleScheduleQuery(context, farmData);

      default:
        return this.handleUnknown(nlpResult);
    }
  }

  /**
   * Handle greeting
   */
  handleGreeting(context) {
    const greetings = this.kb.knowledge.general.greetings;
    const greeting = greetings[Math.floor(Math.random() * greetings.length)];

    const historyContext = context.messages.slice(-5);
    const isReturning = historyContext.length > 0;

    let response = greeting;

    if (isReturning) {
      response += ' ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏û‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö';
    }

    response += '\n\n‡∏ú‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á:';
    response += '\n- ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£';
    response += '\n- ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥';
    response += '\n- ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡∏•‡∏á';
    response += '\n- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ü‡∏≤‡∏£‡πå‡∏°';

    return {
      text: response,
      suggestions: [
        '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ü‡∏≤‡∏£‡πå‡∏°',
        '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥',
        '‡πÉ‡∏ö‡∏Å‡∏±‡∏ç‡∏ä‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á',
        '‡∏Ñ‡∏ß‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏∞‡πÑ‡∏£'
      ]
    };
  }

  /**
   * Handle question
   */
  async handleQuestion(nlpResult, context, farmData) {
    const { entities } = nlpResult;

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡∏ä
    if (entities.crops.length > 0) {
      const crop = entities.crops[0];
      const cropInfo = this.kb.query('crops', crop);

      if (cropInfo) {
        let response = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö${cropInfo.name}:\n\n`;
        response += `üå± ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå: ${cropInfo.scientificName}\n`;
        response += `üìä pH ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°: ${cropInfo.optimalPH.min}-${cropInfo.optimalPH.max}\n`;
        response += `üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥: ${cropInfo.waterNeeds}\n`;
        response += `üìÖ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß: ${cropInfo.harvestTime}\n\n`;

        response += `**‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:**\n`;
        cropInfo.tips.forEach((tip, i) => {
          response += `${i + 1}. ${tip}\n`;
        });

        return {
          text: response,
          suggestions: ['‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢', '‡∏Ñ‡∏ß‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏∞‡πÑ‡∏£', '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥']
        };
      }
    }

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ
    if (entities.problems.length > 0) {
      const problem = entities.problems[0];
      const problemInfo = this.kb.query('problems', problem);

      if (problemInfo) {
        let response = `üîç ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ${problemInfo.problem}\n\n`;
        response += `**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:**\n`;
        problemInfo.causes.forEach((cause, i) => {
          response += `${i + 1}. ${cause}\n`;
        });

        response += `\n**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:**\n`;
        problemInfo.solutions.forEach((solution, i) => {
          response += `${i + 1}. ${solution}\n`;
        });

        if (problemInfo.urgency === 'high') {
          response += `\n‚ö†Ô∏è **‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏î‡πà‡∏ß‡∏ô!** ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î`;
        }

        return {
          text: response,
          suggestions: ['‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°', '‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏µ‡∏Å']
        };
      }
    }

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏≤‡∏ï‡∏∏
    if (entities.nutrients.length > 0) {
      const nutrient = entities.nutrients[0];
      const nutrientInfo = this.kb.query('nutrients', nutrient);

      if (nutrientInfo) {
        let response = `üíä ${nutrient} (${nutrientInfo.symbol})\n\n`;
        response += `**‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:** ${nutrientInfo.functions}\n\n`;
        response += `**‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î:** ${nutrientInfo.deficiencySymptoms}\n\n`;
        response += `**‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤:** ${nutrientInfo.sources.join(', ')}\n\n`;
        response += `**‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏™‡πà:** ${nutrientInfo.applicationTiming}`;

        return {
          text: response,
          suggestions: ['‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡∏¥‡∏ô', '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏∏‡πã‡∏¢']
        };
      }
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô Knowledge Base
    const searchResults = this.kb.search(nlpResult.originalText);

    if (searchResults.length > 0) {
      const topResult = searchResults[0];
      let response = `‡∏ú‡∏°‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö:\n\n`;

      // Format based on category
      if (topResult.category === 'techniques') {
        const tech = topResult.data;
        response += `üìñ ${tech.technique}\n`;
        response += `${tech.description}\n\n`;
        response += `**‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏î‡∏µ:**\n`;
        tech.bestPractices.forEach((practice, i) => {
          response += `${i + 1}. ${practice}\n`;
        });
      } else {
        response += JSON.stringify(topResult.data, null, 2);
      }

      return {
        text: response,
        suggestions: ['‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°', '‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô']
      };
    }

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
    return this.handleUnknown(nlpResult);
  }

  /**
   * Handle advice request
   */
  async handleAdviceRequest(nlpResult, context, farmData) {
    if (!farmData) {
      return {
        text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö',
        suggestions: ['‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏≤‡∏£‡πå‡∏°', '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ']
      };
    }

    const { entities } = nlpResult;

    // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏∏‡πã‡∏¢
    if (entities.nutrients.length > 0 || nlpResult.originalText.includes('‡∏õ‡∏∏‡πã‡∏¢')) {
      try {
        const fertilizerService = new FertilizerService();
        const recommendations = await fertilizerService.generateRecommendations({
          soilData: farmData.soilMonitoring?.realTimeData || {},
          cropType: farmData.crops?.[0]?.cropType || 'cannabis',
          growthStage: farmData.crops?.[0]?.currentStage || 'vegetative',
          farmSize: farmData.area || 1
        });

        let response = 'üìä **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì**\n\n';

        if (recommendations.recommendations.length > 0) {
          const topRec = recommendations.recommendations[0];
          response += `**‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ${topRec.priority}: ${topRec.category}**\n\n`;
          response += `‡∏õ‡∏∏‡πã‡∏¢: ${topRec.product.name} (${topRec.product.npk})\n`;
          response += `‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì: ${topRec.application.amount} ${topRec.application.unit}\n`;
          response += `‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${topRec.estimatedCost} ‡∏ö‡∏≤‡∏ó\n\n`;

          response += `**‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå:**\n`;
          topRec.benefits.forEach((benefit, i) => {
            response += `- ${benefit}\n`;
          });
        } else {
          response += '‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°';
        }

        return {
          text: response,
          suggestions: ['‡∏î‡∏π‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢']
        };
      } catch (error) {
        return {
          text: '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏Ñ‡∏£‡∏±‡∏ö',
          suggestions: ['‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≤‡∏£‡πå‡∏°']
        };
      }
    }

    // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥
    if (entities.nutrients.includes('‡∏ô‡πâ‡∏≥') || nlpResult.originalText.includes('‡∏ô‡πâ‡∏≥')) {
      return {
        text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô',
        suggestions: ['‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô']
      };
    }

    // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    const cropType = farmData.crops?.[0]?.cropType || '‡∏Å‡∏±‡∏ç‡∏ä‡∏≤';
    const cropInfo = this.kb.query('crops', cropType);

    if (cropInfo) {
      let response = `**‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö${cropInfo.name}**\n\n`;
      cropInfo.tips.forEach((tip, i) => {
        response += `${i + 1}. ${tip}\n`;
      });

      return {
        text: response,
        suggestions: ['‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•', '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢']
      };
    }

    return {
      text: '‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢ ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤',
      suggestions: ['‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢', '‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥', '‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤']
    };
  }

  /**
   * Handle problem report
   */
  async handleProblemReport(nlpResult, context, farmData) {
    const { entities, sentiment } = nlpResult;

    let response = 'üîç ‡∏ú‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏à‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö ';

    if (sentiment === 'negative') {
      response += '‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô\n\n';
    } else {
      response += '‡∏°‡∏≤‡∏î‡∏π‡∏Å‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö\n\n';
    }

    // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å entities
    if (entities.problems.length > 0) {
      const problem = entities.problems[0];
      const problemInfo = this.kb.query('problems', problem);

      if (problemInfo) {
        response += `**‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ${problemInfo.problem}**\n\n`;
        response += `**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô:**\n`;

        // ‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
        problemInfo.solutions.slice(0, 3).forEach((solution, i) => {
          response += `${i + 1}. ${solution}\n`;
        });

        if (problemInfo.urgency === 'high') {
          response += `\n‚ö†Ô∏è **‡∏î‡πà‡∏ß‡∏ô!** ‡∏Ñ‡∏ß‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°`;
        }

        return {
          text: response,
          suggestions: ['‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤']
        };
      }
    }

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    response += '‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô:\n';
    response += '- ‡πÉ‡∏ö‡∏°‡∏µ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á, ‡∏î‡πà‡∏≤‡∏á, ‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß)\n';
    response += '- ‡πÄ‡∏Å‡∏¥‡∏î‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô\n';
    response += '- ‡∏°‡∏µ‡πÅ‡∏°‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà';

    return {
      text: response,
      suggestions: ['‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', '‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°']
    };
  }

  /**
   * Handle status query
   */
  async handleStatusQuery(context, farmData) {
    if (!farmData) {
      return {
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö',
        suggestions: ['‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏≤‡∏£‡πå‡∏°']
      };
    }

    let response = `üåæ **‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ü‡∏≤‡∏£‡πå‡∏°: ${farmData.farmName}**\n\n`;

    // Crop status
    if (farmData.crops && farmData.crops.length > 0) {
      const crop = farmData.crops[0];
      response += `üå± ‡∏û‡∏∑‡∏ä: ${crop.cropType} (${crop.currentStage})\n`;
      response += `üìÖ ‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(crop.plantDate).toLocaleDateString('th-TH')}\n\n`;
    }

    // Soil status
    if (farmData.soilMonitoring?.realTimeData) {
      const soil = farmData.soilMonitoring.realTimeData;
      response += `**‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏¥‡∏ô:**\n`;

      if (soil.ph?.current) {
        response += `- pH: ${soil.ph.current.toFixed(1)}`;
        response += soil.ph.status === 'optimal' ? ' ‚úÖ' : ' ‚ö†Ô∏è';
        response += '\n';
      }

      if (soil.moisture?.current) {
        response += `- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: ${soil.moisture.current.toFixed(0)}%`;
        response += soil.moisture.current > 50 ? ' ‚úÖ' : ' ‚ö†Ô∏è';
        response += '\n';
      }
    }

    response += '\nüí° ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?';

    return {
      text: response,
      suggestions: ['‡∏î‡∏π‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤', '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥']
    };
  }

  /**
   * Handle schedule query
   */
  async handleScheduleQuery(context, farmData) {
    if (!farmData) {
      return {
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö',
        suggestions: ['‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏≤‡∏£‡πå‡∏°']
      };
    }

    return {
      text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏£‡∏±‡∏ö?',
      suggestions: ['‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥', '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢', '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß']
    };
  }

  /**
   * Handle unknown intent
   */
  handleUnknown(nlpResult) {
    return {
      text: '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ ‡∏ä‡πà‡∏ß‡∏¢‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á',
      suggestions: ['‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ü‡∏≤‡∏£‡πå‡∏°', '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•', '‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•']
    };
  }
}

module.exports = ResponseGenerator;
```

### 7.7 AI Assistant API Controller

**File**: `src/controllers/aiAssistantController.js`

```javascript
const ThaiNLPService = require('../services/ai/ThaiNLPService');
const ConversationManager = require('../services/ai/ConversationManager');
const ResponseGenerator = require('../services/ai/ResponseGenerator');
const Farm = require('../models/Farm');
const ApiResponse = require('../utils/ApiResponse');
const logger = require('../utils/logger');

const nlpService = new ThaiNLPService();
const conversationManager = new ConversationManager();
const responseGenerator = new ResponseGenerator();

/**
 * POST /api/ai-assistant/chat
 * ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á AI Assistant
 */
exports.chat = async (req, res) => {
  try {
    const { message, farmId } = req.body;
    const userId = req.user.userId;

    if (!message || message.trim().length === 0) {
      return res.status(400).json(ApiResponse.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', 400));
    }

    // Get conversation context
    const context = await conversationManager.getContext(userId, farmId);

    // Process with NLP
    const nlpResult = await nlpService.processQuery(message);

    // Add user message to conversation
    await conversationManager.addMessage(context, 'user', message, {
      intent: nlpResult.intent,
      entities: nlpResult.entities,
      sentiment: nlpResult.sentiment
    });

    // Get farm data if farmId provided
    let farmData = null;
    if (farmId) {
      farmData = await Farm.findById(farmId)
        .select('farmName crops soilMonitoring area location')
        .lean();
    }

    // Generate response
    const response = await responseGenerator.generateResponse(nlpResult, context, farmData);

    // Add assistant message to conversation
    await conversationManager.addMessage(context, 'assistant', response.text, {
      suggestions: response.suggestions
    });

    logger.info('AI chat completed', {
      userId,
      intent: nlpResult.intent,
      farmId: farmId || 'none'
    });

    res.json(
      ApiResponse.success({
        message: response.text,
        suggestions: response.suggestions || [],
        metadata: {
          intent: nlpResult.intent,
          confidence: nlpResult.confidence,
          conversationId: context.conversationId
        }
      })
    );
  } catch (error) {
    logger.error('AI chat failed', { error: error.message });
    res
      .status(500)
      .json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 500, error.message));
  }
};

/**
 * GET /api/ai-assistant/conversation/:conversationId
 * ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
 */
exports.getConversation = async (req, res) => {
  try {
    const { conversationId } = req.params;
    const userId = req.user.userId;

    const Conversation = require('../models/Conversation');
    const conversation = await Conversation.findOne({
      _id: conversationId,
      userId
    })
      .select('messages context createdAt lastActivity')
      .lean();

    if (!conversation) {
      return res.status(404).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤', 404));
    }

    res.json(
      ApiResponse.success({
        conversationId,
        messages: conversation.messages,
        createdAt: conversation.createdAt,
        lastActivity: conversation.lastActivity
      })
    );
  } catch (error) {
    logger.error('Failed to get conversation', { error: error.message });
    res.status(500).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÑ‡∏î‡πâ', 500, error.message));
  }
};

/**
 * DELETE /api/ai-assistant/conversation/:conversationId
 * ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
 */
exports.deleteConversation = async (req, res) => {
  try {
    const { conversationId } = req.params;
    const userId = req.user.userId;

    const Conversation = require('../models/Conversation');
    const conversation = await Conversation.findOneAndDelete({
      _id: conversationId,
      userId
    });

    if (!conversation) {
      return res.status(404).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤', 404));
    }

    logger.info('Conversation deleted', { conversationId, userId });

    res.json(
      ApiResponse.success({
        message: '‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        conversationId
      })
    );
  } catch (error) {
    logger.error('Failed to delete conversation', { error: error.message });
    res.status(500).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÑ‡∏î‡πâ', 500, error.message));
  }
};

/**
 * GET /api/ai-assistant/conversations
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
exports.getConversations = async (req, res) => {
  try {
    const userId = req.user.userId;
    const { limit = 20, active = true } = req.query;

    const Conversation = require('../models/Conversation');
    const conversations = await Conversation.find({
      userId,
      active: active === 'true'
    })
      .select('farmId messageCount lastActivity createdAt')
      .populate('farmId', 'farmName')
      .sort({ lastActivity: -1 })
      .limit(parseInt(limit))
      .lean();

    res.json(
      ApiResponse.success({
        conversations,
        total: conversations.length
      })
    );
  } catch (error) {
    logger.error('Failed to get conversations', { error: error.message });
    res.status(500).json(ApiResponse.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÑ‡∏î‡πâ', 500, error.message));
  }
};

module.exports = exports;
```

### 7.8 Conversation Model

**File**: `src/models/Conversation.js`

```javascript
const mongoose = require('mongoose');

const conversationSchema = new mongoose.Schema(
  {
    userId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User',
      required: true,
      index: true
    },

    farmId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'Farm',
      default: null,
      index: true
    },

    messages: [
      {
        role: {
          type: String,
          enum: ['user', 'assistant'],
          required: true
        },
        content: {
          type: String,
          required: true
        },
        metadata: {
          type: mongoose.Schema.Types.Mixed,
          default: {}
        },
        timestamp: {
          type: Date,
          default: Date.now
        }
      }
    ],

    context: {
      type: mongoose.Schema.Types.Mixed,
      default: {}
    },

    messageCount: {
      type: Number,
      default: 0
    },

    active: {
      type: Boolean,
      default: true,
      index: true
    },

    lastActivity: {
      type: Date,
      default: Date.now,
      index: true
    }
  },
  {
    timestamps: true
  }
);

// Index for queries
conversationSchema.index({ userId: 1, active: 1, lastActivity: -1 });

// TTL Index: Delete inactive conversations older than 30 days
conversationSchema.index(
  { lastActivity: 1 },
  {
    expireAfterSeconds: 30 * 24 * 60 * 60,
    partialFilterExpression: { active: false }
  }
);

module.exports = mongoose.model('Conversation', conversationSchema);
```

---

## Phase 3 Summary

**Status**: ‚úÖ GACP Compliance Framework Complete (80%)

### Platform Focus Update üéØ

**Primary Mission**: Legal Cannabis Production with GACP Compliance

- üåø **Cannabis (‡∏Å‡∏±‡∏ç‡∏ä‡∏≤)**: Default & Primary Crop - Full GACP support
- üí∞ **5 Secondary Crops**: Basic recommendations (future phase focus)
  - ‡∏Ç‡∏°‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏ô (Turmeric), ‡∏Ç‡∏¥‡∏á (Ginger), ‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏î‡∏≥ (Black Galingale)
  - ‡πÑ‡∏û‡∏• (Plai), ‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏° (Kratom)

**Legal Framework**: Department of Thai Traditional and Alternative Medicine (‡∏Å‡∏£‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)

### Completed Sections

1. ‚úÖ **Platform Mission & GACP Framework** (NEW)
   - Legal cannabis production compliance
   - Standard Operating Procedures (SOP)
   - Automated documentation system
   - Audit trail generation
   - Regulatory compliance monitoring
2. ‚úÖ **Overview & Architecture** (Cannabis-focused)
3. ‚úÖ **Soil Data Analyzer** (GACP-compliant analysis)
4. ‚úÖ **Crop Profiles** (Cannabis as default + 5 secondary crops)
5. ‚úÖ **Fertilizer Recommendation Service** (approved products only)
6. ‚úÖ **Product Matcher & Cost Calculator**
7. ‚úÖ **Fertilizer API Endpoints**
8. ‚úÖ **Water Management & Irrigation AI**
   - Evapotranspiration Calculator (FAO Penman-Monteith)
   - Weather API Integration (TMD + OpenWeatherMap)
   - Smart Irrigation Scheduler
   - Water Usage Optimizer
   - API Controllers & Routes
   - Irrigation Log Model
9. ‚úÖ **AI Assistant Enhancement (Thai NLP)** (NEW)
   - Thai NLP Service (tokenization, NER, intent classification)
   - Context-Aware Conversation Manager
   - Agricultural Knowledge Base
   - Response Generator
   - AI Assistant API Controller
   - Conversation Model

### Deliverables Summary

**NEW: GACP Compliance & Legal Framework**:

- üèõÔ∏è Thai cannabis legal framework documentation
- ‚úÖ 6 Standard Operating Procedures (SOP-01 to SOP-06)
- üìù Automated documentation templates
- üîç Real-time compliance monitoring
- üìä Audit report generation
- ‚öñÔ∏è Regulatory requirements tracking

**1. Fertilizer Recommendation Engine** (Cannabis-Focused):

- Soil analysis algorithms (pH, NPK, micronutrients, organic matter)
- **Cannabis as default crop** with GACP-compliant growing requirements
- Fertilizer recommendation using **approved products only**
- Product matching and application scheduling with documentation
- 5 secondary crop profiles (basic support)
- 6 REST API endpoints

**2. Water Management & Irrigation AI**:

- ET‚ÇÄ calculator with FAO Penman-Monteith equation
- Weather forecast integration (7-day ahead)
- Smart irrigation scheduling with water balance
- Usage pattern analysis and efficiency scoring
- Water stress detection
- 5 REST API endpoints

**3. AI Assistant (Thai NLP)**:

- Thai natural language processing (tokenization, entity extraction)
- Intent classification (greeting, question, advice, problem, status, schedule)
- Context-aware conversation management (30-min timeout)
- Agricultural knowledge base (crops, problems, nutrients, techniques)
- Response generation with smart suggestions
- Multi-turn dialog support
- 4 REST API endpoints

### Technical Highlights

**Scientific Accuracy**:

- FAO Penman-Monteith equation for ET calculation
- Crop coefficient (Kc) by growth stage
- Available Water Capacity (AWC) by soil type
- Management Allowed Depletion (MAD) calculation
- Cannabis-specific NPK requirements by stage

**AI & NLP Features**:

- Thai language tokenization with stop word filtering
- Named Entity Recognition (crops, problems, nutrients)
- Intent classification with confidence scoring
- Sentiment analysis (positive, negative, neutral)
- Context extraction from conversation history
- Knowledge base search with relevance ranking

**Smart Features**:

- Weather-aware irrigation planning
- Rain prediction integration
- Optimal timing recommendations
- Cost calculation (fertilizer, water, electricity)
- Savings estimation vs traditional methods
- Conversational AI with suggestions

**Data Management**:

- Irrigation history logging with TTL (1 year)
- Conversation history with TTL (30 days inactive)
- Pattern analysis (time, consistency, efficiency)
- Benchmark comparison by crop type
- Multiple database indexes for performance

### System Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ            GACP Platform - Phase 3                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  1. Fertilizer Recommendation Engine         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     - Soil Analysis                          ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     - NPK Calculations                       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     - Product Matching                       ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                      ‚îÇ                             ‚îÇ
‚îÇ                      ‚ñº                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  2. Water Management & Irrigation AI         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     - ET Calculator (Penman-Monteith)        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     - Weather Integration                    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     - Smart Scheduling                       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     - Usage Optimization                     ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                      ‚îÇ                             ‚îÇ
‚îÇ                      ‚ñº                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  3. AI Assistant (Thai NLP)                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     - Thai NLP Engine                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     - Conversation Manager                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     - Knowledge Base                         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     - Response Generator                     ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                      ‚îÇ                             ‚îÇ
‚îÇ                      ‚ñº                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  Unified API Layer                           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  15 Endpoints Total                          ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Statistics

- **Total Lines of Code**: ~5,150+ lines (including GACP documentation)
  - GACP Compliance Framework: ~200 lines (new)
  - Fertilizer Engine: ~1,550 lines
  - Water Management: ~1,930 lines
  - AI Assistant: ~1,470 lines

- **Crop Profiles**: 6 total
  - üéØ **Cannabis (‡∏Å‡∏±‡∏ç‡∏ä‡∏≤)**: Primary crop, full GACP support, default selection
  - üí∞ **5 Secondary crops**: Basic profiles for future phases
    - Turmeric, Ginger, Black Galingale, Plai, Kratom

- **Services**: 9 total
  - SoilDataAnalyzer
  - FertilizerRecommendationService
  - ETCalculator
  - WeatherService
  - IrrigationScheduler
  - WaterOptimizer
  - ThaiNLPService
  - ConversationManager
  - ResponseGenerator + KnowledgeBase

- **API Endpoints**: 15 total
  - Fertilizer: 6 endpoints
  - Water Management: 5 endpoints
  - AI Assistant: 4 endpoints

- **Database Models**: 3
  - IrrigationLog (with TTL: 1 year)
  - Conversation (with TTL: 30 days inactive)
  - Farm (updated with new fields)

- **Algorithms & Methods**: 25+
  - Soil analysis (pH, NPK, micronutrients, organic matter)
  - ET calculations (Penman-Monteith, vapor pressure, radiation)
  - Water balance (AWC, MAD, stress detection)
  - NLP (tokenization, NER, intent classification, sentiment)
  - Knowledge base search and matching

### Integration Points

1. **Phase 1 Integration**:
   - Uses Farm model and farm data
   - Integrates with user authentication
   - Links to crop management system

2. **Phase 2 Integration**:
   - Reads soil sensor data (moisture, pH, NPK, EC)
   - Reads water sensor data
   - Uses real-time IoT data for recommendations

3. **Cross-Module Integration**:
   - AI Assistant can query fertilizer recommendations
   - AI Assistant can query irrigation schedules
   - All modules share farm context

### Platform Value Proposition üéØ

**For Cannabis Producers**:

1. ‚úÖ **100% Legal Compliance**: Automated GACP documentation
2. üìù **Simplified Record-Keeping**: Daily logs generated automatically
3. üî¨ **Quality Assurance**: Pharmaceutical-grade standards tracking
4. üí∞ **Cost Savings**: 20-40% reduction in input costs
5. üìà **Yield Optimization**: 15-30% increase with data-driven decisions
6. ‚öñÔ∏è **Legal Protection**: Complete audit trail for government submissions

**For Economic Crop Farmers** (Secondary Support):

- Basic cultivation recommendations
- Resource optimization
- Market standard guidelines
- Future phase: Full support expansion

### Next Steps (20% Remaining)

Continue with final Phase 3 sections (Cannabis-focused):

- **Machine Learning Models** (Cannabis yield prediction, optimal harvest timing)
- **Testing Strategy** (Unit tests with cannabis cultivation scenarios)
- **Deployment Guide** (Production setup with GACP compliance features)

### Key Technologies

- **Backend**: Node.js, Express.js
- **Database**: MongoDB (with TTL indexes)
- **Caching**: Redis (weather data, contexts)
- **AI/ML**: Python (PyThaiNLP API for advanced NLP)
- **External APIs**: Thai Meteorological Department, OpenWeatherMap
- **Scientific Libraries**: FAO methodologies, agricultural standards

---

**Document Version**: 1.3.0 - GACP Cannabis Focus Edition
**Last Updated**: 2025-10-28
**Status**: Phase 3 - 80% Complete (GACP Framework + Fertilizer + Water + AI Assistant) üöÄ

**Major Update**: Platform refocused on **Cannabis as Primary Crop** with full GACP compliance support. Secondary economic crops (5 plants) available as optional future enhancements.

---

## üìä Strategic Documentation (NEW)

### Related Strategic Documents

This Phase 3 implementation is supported by comprehensive strategic analysis and data architecture:

#### 1. [Competitive Analysis Report](./COMPETITIVE_ANALYSIS.md)

**Analysis of Government Platforms**:

- ‚úÖ DTAM Main Portal (www.dtam.moph.go.th) - Information & regulations
- ‚úÖ HerbCtrl System (herbctrl.dtam.moph.go.th) - License applications
- ‚úÖ PanThai Chatbot (panthaichatbot.in.th) - Health advice AI

**Key Finding**: üéØ **MASSIVE MARKET GAP**

- Government provides compliance framework (WHAT to do)
- **We provide operational tools (HOW to do it)**
- No direct competition in farm management space
- We're the only IoT + AI platform for GACP cannabis

**Our Competitive Advantages**:

1. End-to-end farm management (operations + compliance)
2. AI-powered agricultural intelligence (vs health-focused PanThai AI)
3. Automated GACP compliance (real-time monitoring, not just PDFs)
4. Data-driven decision making (live sensors vs static information)
5. Private sector speed & innovation

**Strategy**: Complementary positioning - work WITH government systems, fill the operational gap

üìñ **Full Report**: [COMPETITIVE_ANALYSIS.md](./COMPETITIVE_ANALYSIS.md)

---

#### 2. [Central Database Design](./CENTRAL_DATABASE_DESIGN.md)

**Comprehensive Knowledge Base for 6 Medicinal Plants**:

**Database Collections**:

1. **Plant Catalog** - Master list of 6 plants (Cannabis primary, 5 secondary)
2. **Cultivar Library** - Varieties, genetics, characteristics for each plant
3. **Regional Growing Database** - 77 Thai provinces with suitability scores
4. **Disease & Pest Database** - Comprehensive problems database for prediction
5. **Historical Yield Database** - Training data for ML models
6. **Climate Correlation Database** - Weather patterns linked to outcomes

**Machine Learning Capabilities**:

- üéØ **Yield Prediction Model** - Forecast harvest based on conditions
- ü¶† **Disease Risk Prediction** - Probability of problems in next 7-30 days
- üìÖ **Optimal Planting Date** - Best timing based on climate patterns
- üå± **Cultivar Recommendation** - Match varieties to farm conditions

**Data Collection Strategy**:

- Phase 1: Seed with literature & research (Months 1-3)
- Phase 2: Platform user data (Months 4-12)
- Phase 3: Continuous ML improvement (Ongoing)

**Target**:

- Year 1: 100+ farms, 500+ yield records
- Year 2: 500+ farms, 2,500+ yield records, 75%+ ML accuracy
- Year 3: 2,000+ farms, 10,000+ yield records, 85%+ ML accuracy

üìñ **Full Design**: [CENTRAL_DATABASE_DESIGN.md](./CENTRAL_DATABASE_DESIGN.md)

---

### How These Documents Connect to Phase 3

**Competitive Analysis** ‚Üí Informs our AI Assistant positioning and feature priorities

- PanThai does health advice (patients)
- We do agricultural advice (farmers)
- Different knowledge bases, different users, no overlap

**Central Database** ‚Üí Powers all Phase 3 AI/ML features:

- Fertilizer recommendations use cultivar requirements
- Disease prediction uses historical outbreak data
- AI Assistant queries knowledge base
- Yield models train on historical yields
- Regional suitability guides crop selection

**Integration Point**: Phase 3 (this document) = Implementation details
Supporting docs = Strategic context + Data foundation

---
