# Business Workflow Specification: New GACP Application
(กระบวนการขอรับใบรับรองแหล่งผลิตกัญชา - รายใหม่)

## 1. ผู้เกี่ยวข้อง (Actors & Roles)
1. **เกษตรกร (Applicant)**: ผู้ยื่นคำขอและชำระเงิน
2. **เจ้าหน้าที่ตรวจเอกสาร (Document Reviewer)**: ผู้ตรวจสอบความถูกต้องของฟอร์มและไฟล์แนบ
3. **เจ้าหน้าที่จัดคิว (Scheduler)**: ผู้บริหารจัดการตารางนัดหมายและมอบหมายงาน
4. **ผู้ตรวจประเมิน (Auditor)**: ผู้เชี่ยวชาญที่ทำการตรวจประเมิน (หน้างาน/ออนไลน์)
5. **ระบบ (System)**: ตัวกลางจัดการ Logic และการเงินอัตโนมัติ

---

## 2. ขั้นตอนการทำงานแบบละเอียด (Detailed Steps)

### Stage 1: การเตรียมข้อมูลและตรวจสอบตนเอง (Applicant)
**Goal**: กรอกข้อมูลให้ครบและยืนยันความถูกต้องก่อนจ่ายเงิน

1. **Start**: ผู้ใช้ Login เข้าสู่ระบบ เลือกเมนู "ขอรับใบรับรองรายใหม่"
2. **Form Initialization (System Logic)**:
    - Form 09 (ใบสมัคร): ถูกเลือกอัตโนมัติ (Checked & Disabled)
    - Form 10 (ข้อมูลเบื้องต้น): ถูกเลือกอัตโนมัติ (Checked & Disabled)
    - Form 11 (ประเมินตนเอง): ผู้ใช้เลือกติ๊กเองได้ (Optional Checkbox)
3. **Data Entry**:
    - ผู้ใช้กรอกข้อมูลตาม Wizard (Step 1, 2, 3...)
    - อัปโหลดเอกสารแนบ 22 รายการ (เช่น โฉนด, แปลน, SOP, ผลแล็บ)
4. **Pre-Submission Review (UX Logic)**:
    - เมื่อกรอกครบทุกช่อง ปุ่ม "ตรวจสอบเอกสาร (Review Document)" จะทำงาน (Enabled)
    - **Action**: ผู้ใช้กดปุ่ม → ระบบเปิดหน้าต่าง Web View (Pop-up)
    - **Web View Content**: แสดงแบบฟอร์มเสมือนจริง (Preview) และรายการไฟล์ที่แนบ เพื่อให้ผู้ใช้ตรวจทานครั้งสุดท้าย
    - **Decision**:
        - กรณีเจอจุดผิด: กดปุ่ม [แก้ไขข้อมูล] ใน Web View → ปิด Pop-up กลับไปหน้ากรอกข้อมูล
        - กรณีถูกต้อง: กดปุ่ม [ยืนยันความถูกต้อง] ใน Web View → ระบบบันทึกสถานะว่า "Reviewed"

### Stage 2: การชำระเงินงวดแรกและการยื่นคำขอ (Payment Phase 1)
**Goal**: เก็บค่าธรรมเนียมคำขอก่อนเริ่มกระบวนการ

1. **Payment Trigger**:
    - หลังกดยืนยันใน Web View → หน้าจอแสดงสรุปค่าใช้จ่าย 5,000 บาท
    - ปุ่ม [ชำระเงิน 5,000 บาท] ปรากฏขึ้น
2. **Payment Processing**:
    - ผู้ใช้กดชำระเงิน (QR Code / Credit Card)
    - **System Logic**: รอสัญญาณ Payment Gateway = Success
3. **Submission Unlock**:
    - เมื่อจ่ายสำเร็จ → ปุ่ม [ยื่นคำขออนุมัติ (Submit Application)] เปลี่ยนสถานะเป็นกดได้ (Enabled)
    - **Action**: ผู้ใช้กดปุ่ม Submit
    - **Status Update**: สถานะเปลี่ยนเป็น → รอตรวจสอบเอกสาร (Pending Document Review)

### Stage 3: การตรวจสอบเอกสาร (Document Review Loop)
**Goal**: คัดกรองเอกสารโดยเจ้าหน้าที่ (Reviewer)

1. **Reviewer Action**: เจ้าหน้าที่เปิดเคสตรวจสอบข้อมูลเทียบกับไฟล์แนบ
2. **Validation Logic (เงื่อนไขการส่งคืน)**:
    - **กรณีเอกสารไม่ถูกต้อง (Reject)**:
        - เจ้าหน้าที่กด [ส่งคืนแก้ไข] พร้อมระบุเหตุผล (Comment)
        - **System Logic (Submission Counter)**:
            - ส่งคืนครั้งที่ 1: ฟรี → สถานะ: รอแก้ไข
            - ส่งคืนครั้งที่ 2: ฟรี → สถานะ: รอแก้ไข
            - ส่งคืนครั้งที่ 3 (Penalty): Reset Payment Status Phase 1 เป็น Unpaid → สถานะ: รอชำระเงินใหม่ (ผู้ยื่นต้องจ่าย 5,000 บาท อีกครั้งจึงจะส่งได้)
    - **กรณีเอกสารถูกต้อง (Approve)**:
        - เจ้าหน้าที่กด [อนุมัติเอกสาร]
        - **Status Update**: สถานะเปลี่ยนเป็น → รอชำระค่าตรวจประเมิน (Pending Payment Phase 2)
        - **Notification**: ระบบแจ้งเตือนผู้ยื่นให้มาชำระเงินส่วนที่เหลือ

### Stage 4: การชำระเงินงวดที่ 2 และการส่งต่องาน (Payment Phase 2 & Handoff)
**Goal**: เก็บค่าตรวจและส่งงานให้ทีมจัดคิว

1. **Applicant Action**:
    - ผู้ยื่น Login เข้ามาเห็นสถานะ ผ่านการตรวจสอบเอกสาร
    - กดปุ่ม [ชำระเงิน 25,000 บาท]
2. **System Handoff Logic**:
    - **เงื่อนไข**: `Document_Status = Approved` AND `Payment_Phase_2 = Paid`
    - **Action**: ระบบย้ายงาน (Ticket) นี้ไปสู่ถาดงานของ เจ้าหน้าที่จัดคิว (Scheduler) ทันที

### Stage 5: การจัดคิวและตรวจประเมิน (Scheduling & Audit)
**Goal**: นัดหมายและตัดสินผลการรับรอง

1. **Scheduler Action**:
    - ตรวจสอบตารางว่างของผู้ตรวจ (Auditor)
    - ติดต่อประสานงานและลงวันนัดหมายในระบบ
    - กด [มอบหมายงาน (Assign)] ระบุชื่อ Auditor และวันเวลา
2. **Auditor Action (Audit Day)**:
    - ดำเนินการตรวจ (On-site หรือ Online)
    - บันทึกผลการตรวจในระบบ
3. **Final Decision Logic**:
    - ✅ **ผ่าน (Pass)**: Auditor กดอนุมัติ → ระบบออกใบรับรอง (Certificate) ทันที
    - ⚠️ **แก้ไขเล็กน้อย (Minor)**: Auditor เลือกหัวข้อที่ขาด → ผู้ยื่นอัปโหลดไฟล์เพิ่ม → Auditor กดอนุมัติ (ไม่ต้องนัดใหม่)
    - ❌ **ไม่ผ่าน/แก้ไขใหญ่ (Major)**: Auditor กดส่งคืนให้ปรับปรุงสถานที่ → สถานะกลับไปเป็น รอนัดหมายใหม่ (ต้องวนกลับไปหา Scheduler เพื่อจัดคิวตรวจซ้ำ)

---

## 3. ตารางสรุป System Logic (Technical Summary)

| จุดตรวจสอบ (Trigger Point) | เงื่อนไข (Condition) | ผลลัพธ์ (System Action) |
| :--- | :--- | :--- |
| ก่อนชำระเงินงวด 1 | ปุ่ม "ตรวจสอบเอกสาร" ถูกกด | เปิด Web View Pop-up (บังคับดู) |
| ใน Web View | กด "ยืนยันความถูกต้อง" | ปลดล็อคปุ่ม Payment 5,000 บาท |
| ก่อนยื่นคำขอ | Payment_Phase_1 != Paid | ปุ่ม Submit = Disabled (สีเทา) |
| เมื่อกดส่งคืน (Reject) | Reject_Count < 3 | สถานะ = รอแก้ไข (แก้ฟรี) |
| เมื่อกดส่งคืน (Reject) | Reject_Count >= 3 | สถานะ = รอชำระเงินใหม่ (ปรับเงิน 5,000) |
| ก่อนส่งงานให้ Scheduler | Payment_Phase_2 != Paid | งานไม่แสดงใน Dashboard ของ Scheduler |

---

## 4. UX Writing (ข้อความที่จะปรากฏบนหน้าจอ)
- **ปุ่ม Web View**: "ตรวจสอบตัวอย่างใบสมัครและเอกสารแนบ"
- **ข้อความใน Web View**: "กรุณาตรวจสอบความถูกต้องของข้อมูล หากยืนยันแล้วจะไม่สามารถแก้ไขได้จนกว่าเจ้าหน้าที่จะส่งคืน"
- **ปุ่มยืนยัน**: "ยืนยันความถูกต้องและดำเนินการชำระเงิน"
- **ข้อความเมื่อต้องจ่ายค่าปรับ (ครั้งที่ 3)**: "เอกสารของคุณไม่ผ่านการพิจารณาเป็นครั้งที่ 3 กรุณาชำระค่าธรรมเนียมคำขอใหม่เพื่อดำเนินการต่อ"
