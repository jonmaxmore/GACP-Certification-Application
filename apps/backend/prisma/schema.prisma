// GACP Platform - Prisma Schema
// PostgreSQL Database with UUID, Audit Trail, Soft Delete, Legal Retention

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// USER MODEL
// =============================================================================
model User {
  id        String   @id @default(uuid())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Account Type
  accountType String @default("INDIVIDUAL") // INDIVIDUAL, JURISTIC, COMMUNITY_ENTERPRISE, STAFF

  // Login Credentials
  email    String? @unique
  password String

  // Individual Farmer Fields
  firstName   String?
  lastName    String?
  phoneNumber String?
  idCard      String? // Encrypted
  idCardHash  String? @unique
  laserCode   String? // Encrypted

  // Juristic Person Fields
  companyName             String?
  taxId                   String?
  taxIdHash               String? @unique
  representativeName      String?
  representativePosition  String?

  // Community Enterprise Fields
  communityName                 String?
  communityRegistrationNo       String?
  communityRegistrationNoHash   String? @unique

  // Role & Status
  role   String @default("FARMER") // FARMER, REVIEWER_AUDITOR, SCHEDULER, ACCOUNTANT, ADMIN, SUPER_ADMIN
  status String @default("PENDING_VERIFICATION") // PENDING_VERIFICATION, ACTIVE, SUSPENDED, LOCKED, INACTIVE

  // Address
  address     String?
  province    String?
  district    String?
  subdistrict String?
  zipCode     String?

  // Verification
  isEmailVerified         Boolean   @default(false)
  emailVerificationToken  String?
  emailVerificationExpiry DateTime?
  passwordResetToken      String?
  passwordResetExpiry     DateTime?

  // Login History
  lastLoginAt   DateTime?
  loginAttempts Int       @default(0)
  isLocked      Boolean   @default(false)
  lockedUntil   DateTime?

  // Audit Trail
  createdBy   String?
  updatedBy   String?
  createdByIp String?
  updatedByIp String?

  // Soft Delete
  isDeleted    Boolean   @default(false)
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?

  // Legal Retention (5 years)
  retainUntil DateTime @default(dbgenerated("NOW() + INTERVAL '5 years'"))
  legalHold   Boolean  @default(false)

  // Relations
  applications  Application[]
  certificates  Certificate[]
  invoices      Invoice[]
  notifications Notification[]
  farms         Farm[]

  @@index([email])
  @@index([role, status])
  @@index([accountType])
  @@index([isDeleted])
  @@map("users")
}

// =============================================================================
// APPLICATION MODEL
// =============================================================================
model Application {
  id        String   @id @default(uuid())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Application Number
  applicationNumber String @unique

  // Owner
  farmerId String
  farmer   User   @relation(fields: [farmerId], references: [id])

  // Service Type
  serviceType String @default("new_application") // new_application, renewal, replacement, amendment
  areaType    String // OUTDOOR, INDOOR, GREENHOUSE

  // Certification Standard
  standardCode String?                // 'THAI_GACP', 'FDA', 'WHO', 'ASEAN'
  standard     CertificationStandard? @relation(fields: [standardCode], references: [code])

  // Status
  status      String @default("DRAFT")
  rejectCount Int    @default(0)

  // Batch Submission
  batchId        String?
  areaTypeIndex  Int     @default(0)
  totalAreaTypes Int     @default(1)

  // Payment
  phase1Amount   Int       @default(5000)
  phase1Status   String    @default("PENDING")
  phase1PaidAt   DateTime?
  phase2Amount   Int       @default(25000)
  phase2Status   String    @default("PENDING")
  phase2PaidAt   DateTime?

  // Audit Info
  auditorId     String?
  scheduledDate DateTime?
  auditResult   String?
  auditNotes    String?

  // Form Data (JSON)
  formData Json?

  // Attachments (JSON array)
  attachments Json?

  // Workflow History (JSON array)
  workflowHistory Json?

  // เกณฑ์เสริม (Supplementary Criteria - Optional)
  supplementaryCriteria Json?    // JSON object with optional fields
  supplementarySkipped  Boolean @default(false) // User chose to skip

  // Document Integrity
  submissionHash        String?
  officialReceiptNumber String?
  idempotencyKey        String? @unique

  // Audit Trail
  createdBy   String?
  updatedBy   String?
  createdByIp String?
  updatedByIp String?

  // Soft Delete
  isDeleted    Boolean   @default(false)
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?

  // Legal Retention (5 years)
  retainUntil DateTime @default(dbgenerated("NOW() + INTERVAL '5 years'"))
  legalHold   Boolean  @default(false)

  // Relations
  certificates Certificate[]
  invoices     Invoice[]
  quotes       Quote[]

  @@index([farmerId])
  @@index([status])
  @@index([applicationNumber])
  @@index([isDeleted])
  @@map("applications")
}

// =============================================================================
// CERTIFICATE MODEL
// =============================================================================
model Certificate {
  id        String   @id @default(uuid())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Certificate Number
  certificateNumber String @unique
  verificationCode  String
  qrData            String

  // Relations
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id])
  userId        String
  user          User        @relation(fields: [userId], references: [id])

  // Farm Info
  farmId     String
  farmName   String
  farmerName String
  cropType   String
  farmSize   Float

  // Location
  province    String
  district    String
  subDistrict String
  address     String?

  // Standard (Certification Standard Relation)
  standardCode   String?                // 'THAI_GACP', 'FDA', 'WHO', 'ASEAN'
  certStandard   CertificationStandard? @relation(fields: [standardCode], references: [code])
  standardId     String                 // Legacy - can be removed later
  standardName   String
  score          Float

  // Status & Dates
  status        String   @default("active") // active, expired, revoked, renewed
  issuedDate    DateTime @default(now())
  expiryDate    DateTime
  validityYears Int      @default(3)
  issuedBy      String

  // PDF
  pdfGenerated   Boolean   @default(false)
  pdfUrl         String?
  pdfGeneratedAt DateTime?

  // Usage Tracking
  downloadCount      Int       @default(0)
  verificationCount  Int       @default(0)
  lastDownloadedAt   DateTime?
  lastVerifiedAt     DateTime?

  // Revocation
  revokedAt     DateTime?
  revokedBy     String?
  revokedReason String?

  // Renewal Chain
  renewedCertificateId  String?
  previousCertificateId String?

  // Document Integrity
  documentHash String?
  signedBy     String?
  signedAt     DateTime?

  // Print History (JSON)
  printHistory Json?

  // Audit Trail
  createdBy String?
  updatedBy String?

  // Soft Delete
  isDeleted    Boolean   @default(false)
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?

  // Legal Retention (5 years)
  retainUntil DateTime @default(dbgenerated("NOW() + INTERVAL '5 years'"))
  legalHold   Boolean  @default(false)

  @@index([userId])
  @@index([status])
  @@index([certificateNumber])
  @@index([expiryDate])
  @@index([isDeleted])

  // Planting Cycles using this certificate
  plantingCycles PlantingCycle[]
  @@map("certificates")
}

// =============================================================================
// INVOICE MODEL
// =============================================================================
model Invoice {
  id        String   @id @default(uuid())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Invoice Number
  invoiceNumber String @unique

  // Relations
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id])
  farmerId      String
  farmer        User        @relation(fields: [farmerId], references: [id])
  quoteId       String?
  quote         Quote?      @relation(fields: [quoteId], references: [id])

  // Service Type
  serviceType String

  // Billing
  billingName       String?
  billingAddress    String?
  certificateNumber String?

  // Items (JSON)
  items Json?

  // Totals
  subtotal        Float
  vat             Float   @default(0)
  totalAmount     Float
  totalAmountText String?

  // Payment
  dueDate              DateTime
  status               String    @default("pending") // pending, paid, overdue, cancelled
  paidAt               DateTime?
  paymentTransactionId String?

  // Notes
  notes String?

  // Audit Trail
  createdBy   String?
  updatedBy   String?
  createdByIp String?

  // Soft Delete
  isDeleted    Boolean   @default(false)
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?

  // Legal Retention (7 years for tax)
  retainUntil DateTime @default(dbgenerated("NOW() + INTERVAL '7 years'"))
  legalHold   Boolean  @default(false)

  @@index([applicationId])
  @@index([farmerId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([isDeleted])
  @@map("invoices")
}

// =============================================================================
// QUOTE MODEL
// =============================================================================
model Quote {
  id        String   @id @default(uuid())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quote Number
  quoteNumber String @unique

  // Relations
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id])

  // Items (JSON)
  items Json?

  // Totals
  subtotal    Float
  vat         Float   @default(0)
  totalAmount Float

  // Status
  status     String    @default("pending") // pending, accepted, rejected, expired
  validUntil DateTime
  acceptedAt DateTime?
  rejectedAt DateTime?

  // Notes
  notes String?

  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Relations
  invoices Invoice[]

  @@index([applicationId])
  @@index([status])
  @@index([isDeleted])
  @@map("quotes")
}

// =============================================================================
// FARM MODEL
// =============================================================================
model Farm {
  id        String   @id @default(uuid())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Owner
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  // Farm Info
  farmName          String
  farmType          String // CULTIVATION, PROCESSING, BOTH
  address           String
  province          String
  district          String
  subDistrict       String
  postalCode        String

  // GPS
  latitude  Float?
  longitude Float?

  // Area
  totalArea       Float
  cultivationArea Float
  areaUnit        String @default("rai")

  // Cultivation
  cultivationMethod String
  irrigationType    String?
  soilType          String?
  waterSource       String?

  // Status
  status            String    @default("DRAFT")
  verificationNotes String?
  verifiedBy        String?
  verifiedAt        DateTime?
  rejectionReason   String?
  submittedAt       DateTime?

  // Land Documents (JSON)
  landDocuments Json?

  // Soft Delete
  isDeleted    Boolean   @default(false)
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?

  // Relations
  harvestBatches   HarvestBatch[]
  plantingCycles   PlantingCycle[]

  @@index([ownerId])
  @@index([status])
  @@index([province])
  @@index([isDeleted])
  @@map("farms")
}

// =============================================================================
// NOTIFICATION MODEL
// =============================================================================
model Notification {
  id        String   @id @default(uuid())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now())

  // Owner
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Content
  title    String
  message  String
  type     String // INFO, WARNING, SUCCESS, ERROR, QUOTE_RECEIVED, INVOICE_RECEIVED
  category String?

  // Status
  isRead   Boolean   @default(false)
  readAt   DateTime?
  priority Int       @default(0)

  // Metadata (JSON)
  metadata Json?

  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}

// =============================================================================
// AUDIT LOG MODEL (Immutable)
// =============================================================================
model AuditLog {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("timestamp")

  // Log ID
  logId          String @unique
  sequenceNumber Int    @unique

  // Event Classification
  category String // AUTHENTICATION, APPLICATION, PAYMENT, CERTIFICATE, ADMIN, SECURITY, SYSTEM
  action   String
  severity String @default("INFO") // INFO, WARNING, ERROR, CRITICAL

  // Actor (no FK - can be User or DTAMStaff or SYSTEM)
  actorId    String        // UUID of actor (User.id or DTAMStaff.id)
  actorType  String @default("USER") // USER, DTAM_STAFF, SERVICE, SYSTEM
  actorEmail String?
  actorRole  String

  // Resource
  resourceType String // USER, APPLICATION, INVOICE, PAYMENT, CERTIFICATE, DOCUMENT, SYSTEM
  resourceId   String

  // Context
  ipAddress String
  userAgent String

  // Event Data (JSON)
  metadata Json?

  // Result
  result       String  @default("SUCCESS") // SUCCESS, FAILURE
  errorCode    String?
  errorMessage String?

  // Hash Chain (Immutable)
  previousHash  String
  currentHash   String @unique
  hashAlgorithm String @default("SHA-256")

  @@index([actorId])
  @@index([resourceType, resourceId])
  @@index([category, severity])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

// =============================================================================
// USER CONSENT MODEL (PDPA Compliance)
// =============================================================================
model UserConsent {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User relation
  userId String

  // Consent details
  category   String   // TERMS_OF_SERVICE, PRIVACY_POLICY, MARKETING_EMAIL, etc
  version    String   // Version of consent document
  granted    Boolean  @default(false)
  grantedAt  DateTime?
  withdrawnAt DateTime?

  // Context
  ipAddress String?
  userAgent String?
  metadata  Json?

  @@unique([userId, category])
  @@index([userId])
  @@index([category])
  @@index([granted])
  @@map("user_consents")
}

// =============================================================================
// PLANT SPECIES MODEL (พันธุ์พืช)
// =============================================================================
model PlantSpecies {
  id        String   @id @default(uuid())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Identification (Maps to legacy plantId)
  code           String   @unique // CAN, KRA, TUR
  
  // Basic Info
  nameTH         String   // nameTH
  nameEN         String?  // nameEN
  scientificName String?  // scientificName
  familyName     String?  // familyName
  description    String?
  imageUrl       String?
  
  // GACP Configuration
  group          String   // HIGH_CONTROL, GENERAL
  requiresLicense Boolean @default(false)
  sortOrder      Int      @default(0)
  
  // Dynamic Configuration (JSON)
  units          Json?    // ["ไร่", "Rai"] or ["ต้น", "Tree"]
  plantParts     Json?    // ["Root", "Leaf"]
  
  // Requirements (JSON)
  securityRequirements Json? // Array of check items
  productionInputs     Json? // Form fields configuration
  
  // Legacy Fields (kept for compatibility or future use)
  gacpCategory        String?   // MEDICINAL, CANNABIS, KRATOM, OTHER
  dtamPlantCode       String?
  cultivationType     String?   @default("SELF_GROWN")
  harvestCycle        String?
  
  // Relations
  harvestBatches       HarvestBatch[]
  documentRequirements DocumentRequirement[]
  plantingCycles       PlantingCycle[]
  
  // Status
  isActive  Boolean @default(true)
  isDeleted Boolean @default(false)
  
  @@index([code])
  @@index([nameTH])
  @@index([isActive, isDeleted])
  @@map("plant_species")
}

// =============================================================================
// DOCUMENT REQUIREMENT MODEL (Dynamic Checklist)
// =============================================================================
model DocumentRequirement {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation to Plant
  plantCode   String
  plant       PlantSpecies @relation(fields: [plantCode], references: [code])
  
  // Configuration
  requestType     String  // NEW, RENEW, AMEND, REPLACEMENT
  documentName    String
  documentNameTH  String
  category        String  // LICENSE, PROPERTY, COMPLIANCE, FINANCIAL, OTHER
  description     String?
  
  // Validation Rules
  isRequired       Boolean @default(true)
  allowedFileTypes Json?   // ["pdf", "jpg"]
  maxFileSizeMB    Int     @default(10)
  
  // Sorting
  sortOrder Int @default(0)
  
  @@index([plantCode, requestType])
  @@map("document_requirements")
}

// =============================================================================
// PLANTING CYCLE MODEL (รอบการปลูก)
// =============================================================================
model PlantingCycle {
  id        String   @id @default(uuid())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // รหัสรอบ
  cycleName   String  // "รอบที่ 1/2569", "Winter 2026"
  cycleNumber Int     @default(1) // 1, 2, 3...

  // ความสัมพันธ์กับฟาร์มและใบรับรอง
  farmId        String
  farm          Farm        @relation(fields: [farmId], references: [id])
  certificateId String?
  certificate   Certificate? @relation(fields: [certificateId], references: [id])

  // ข้อมูลพืช
  plantSpeciesId String
  plantSpecies   PlantSpecies @relation(fields: [plantSpeciesId], references: [id])
  varietyName    String?      // พันธุ์ (ถ้ามี)

  // ข้อมูลแปลง
  plotName  String?  // ชื่อแปลง
  plotArea  Float?   // พื้นที่ปลูก
  areaUnit  String   @default("rai")

  // วันที่
  startDate           DateTime   // วันเริ่มปลูก
  expectedHarvestDate DateTime?  // กำหนดเก็บเกี่ยว
  actualHarvestDate   DateTime?  // วันเก็บจริง

  // ข้อมูลการปลูก
  seedSource     String?  // แหล่งเมล็ดพันธุ์
  seedQuantity   Float?   // ปริมาณเมล็ด (กก.)
  cultivationType String  @default("SELF_GROWN") // ปลูกเอง
  soilType       String?  // ประเภทดิน
  irrigationType String?  // ระบบน้ำ

  // ผลผลิต
  estimatedYield Float?  // ผลผลิตคาดการณ์ (กก.)
  actualYield    Float?  // ผลผลิตจริง (กก.)

  // สถานะ
  status String @default("PLANNING")
  // PLANNING → PLANTED → GROWING → READY_HARVEST → HARVESTED → COMPLETED

  // หมายเหตุ
  notes String?

  // ความสัมพันธ์
  batches HarvestBatch[]

  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@index([farmId])
  @@index([certificateId])
  @@index([status])
  @@index([isDeleted])
  @@map("planting_cycles")
}

// =============================================================================
// HARVEST BATCH MODEL (Lot การเก็บเกี่ยว)
// =============================================================================
model HarvestBatch {
  id        String   @id @default(uuid())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // รหัส Lot
  batchNumber String @unique // เช่น "LOT-2025-001"
  
  // ความสัมพันธ์ (เพิ่ม cycleId)
  farmId    String
  farm      Farm         @relation(fields: [farmId], references: [id])
  speciesId String
  species   PlantSpecies @relation(fields: [speciesId], references: [id])
  cycleId   String?
  cycle     PlantingCycle? @relation(fields: [cycleId], references: [id])
  
  // ข้อมูลการปลูก
  plantingDate    DateTime  // วันปลูก
  harvestDate     DateTime? // วันเก็บเกี่ยว
  cultivationType String    @default("SELF_GROWN") // ปลูกเอง (DTAM required)
  seedSource      String?   // แหล่งเมล็ดพันธุ์
  
  // พื้นที่
  plotName        String?   // ชื่อแปลง
  plotArea        Float?    // พื้นที่ปลูก
  areaUnit        String    @default("rai")
  
  // ปริมาณ
  estimatedYield  Float?    // ผลผลิตที่คาดการณ์
  actualYield     Float?    // ผลผลิตจริง
  yieldUnit       String    @default("kg")
  
  // สถานะ
  status          String    @default("GROWING") // GROWING, READY_HARVEST, HARVESTED, PROCESSED
  qualityGrade    String?   // A, B, C
  
  // หมายเหตุ
  notes           String?
  
  // QR Code Tracking
  qrCode      String? @unique // UUID for public lookup
  trackingUrl String?         // Full URL with domain

  // Related Lots
  lots Lot[]
  
  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  
  @@index([farmId])
  @@index([speciesId])
  @@index([status])
  @@index([harvestDate])
  @@index([isDeleted])
  @@map("harvest_batches")
}

// =============================================================================
// DTAM STAFF MODEL (เจ้าหน้าที่กรมการแพทย์แผนไทย)
// =============================================================================
model DTAMStaff {
  id        String   @id @default(uuid())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Login Credentials
  username String  @unique
  email    String  @unique
  password String

  // Personal Info
  firstName  String
  lastName   String
  employeeId String? @unique
  department String  @default("กรมการแพทย์แผนไทย")

  // Role & Permissions
  role     String @default("reviewer") // admin, reviewer, auditor, scheduler, accountant, inspector, manager
  userType String @default("DTAM_STAFF")

  // Status
  isActive            Boolean   @default(true)
  failedLoginAttempts Int       @default(0)
  lockedAt            DateTime?
  lastLoginAt         DateTime?

  // Audit Trail
  createdBy String?
  updatedBy String?

  // MFA (Multi-Factor Authentication)
  mfaEnabled     Boolean @default(false)
  mfaSecret      String?
  mfaBackupCodes String? // JSON array of hashed codes

  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@index([username])
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@map("dtam_staff")
}

// =============================================================================
// CERTIFICATION STANDARD MODEL (มาตรฐานการรับรอง)
// =============================================================================
model CertificationStandard {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Standard Info
  code        String  @unique // 'THAI_GACP', 'FDA', 'WHO', 'ASEAN'
  name        String           // 'Thai GACP'
  nameTH      String           // 'มาตรฐาน GACP ไทย'
  description String?
  version     String  @default("v2024") // Standard version

  // Configuration
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)
  logoUrl     String? // URL to standard logo

  // Target Market
  targetMarket String? // 'DOMESTIC', 'USA', 'GLOBAL', 'ASEAN'

  // Relations
  requirements StandardRequirement[]
  applications Application[]
  certificates Certificate[]

  @@index([code])
  @@index([isActive])
  @@map("certification_standards")
}

// =============================================================================
// STANDARD REQUIREMENT MODEL (ข้อกำหนดมาตรฐาน)
// =============================================================================
model StandardRequirement {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation to Standard
  standardId String
  standard   CertificationStandard @relation(fields: [standardId], references: [id])

  // Requirement Info
  category    String  // 'FACILITY', 'DOCUMENTATION', 'TESTING', 'PROCESS'
  name        String
  nameTH      String
  description String?
  
  // Validation
  isRequired  Boolean @default(true)
  sortOrder   Int     @default(0)

  @@index([standardId])
  @@index([category])
  @@map("standard_requirements")
}

// =============================================================================
// LOT MODEL (ล็อตย่อย - Package Level Tracking)
// =============================================================================
model Lot {
  id        String   @id @default(uuid())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Lot Number
  lotNumber String @unique // 'LOT-2026-001-A'

  // Relation to Batch
  batchId String
  batch   HarvestBatch @relation(fields: [batchId], references: [id])

  // Packaging Info
  packageType   String  // 'BAG_1KG', 'BOX_5KG', 'BOTTLE_100ML'
  quantity      Int     // Number of packages
  unitWeight    Float   // Weight per package (kg)
  totalWeight   Float?  // Total weight

  // QR Code Tracking
  qrCode      String @unique // UUID for public lookup
  trackingUrl String?        // Full URL with domain

  // Processing
  processedAt DateTime?
  packagedAt  DateTime?
  expiryDate  DateTime?

  // Lab Test
  labTestReportUrl String?
  thcContent       Float?
  cbdContent       Float?
  moistureContent  Float?
  testStatus       String? // 'PENDING', 'PASSED', 'FAILED'

  // Destination
  destinationType String? // 'DOMESTIC', 'EXPORT'
  destination     String? // Customer/Country
  shippedAt       DateTime?

  // Status
  status String @default("CREATED") // CREATED, PACKAGED, TESTED, SHIPPED

  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@index([batchId])
  @@index([qrCode])
  @@index([status])
  @@index([isDeleted])
  @@map("lots")
}
